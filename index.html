<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึก OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <!-- Chart.js สำหรับกราฟ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=TH+Sarabun+New:wght@400;700&display=swap');
        body {
            font-family: 'TH Sarabun New', sans-serif;
        }

        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #00cec9;
            --danger-color: #e17055;
            --success-color: #00b894;
            --light-bg: #f8f9ff;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Sarabun', 'Noto Sans Thai', system-ui, sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1.2rem 1.5rem;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3);
        }
        
        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            border-radius: 10px;
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 0.7rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(108, 92, 231, 0.15);
        }
        
        .chip {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 50px;
            background-color: #f1f3ff;
            border: 1px solid #e0e5ff;
            color: #555;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chip:hover {
            background-color: #e9edff;
        }
        
        .chip.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .service-chip {
            display: inline-block;
            padding: 0.7rem 1.2rem;
            margin: 0.3rem;
            border-radius: 12px;
            background-color: white;
            border: 2px solid #e0e5ff;
            color: #555;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 180px;
        }
        
        .service-chip:hover {
            border-color: var(--primary-color);
            background-color: #f8f9ff;
        }
        
        .service-chip.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.2);
        }
        
        .service-price {
            display: block;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 0.3rem;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f2ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-completed {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }
        
        .status-pending {
            background-color: rgba(253, 203, 110, 0.1);
            color: #f39c12;
        }
        
        .status-cancelled {
            background-color: rgba(231, 112, 85, 0.1);
            color: var(--danger-color);
        }
        
        .patient-info-box {
            background: linear-gradient(135deg, #f8f9ff, #f0f2ff);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #777;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 500;
            color: #333;
        }
        
        .receipt-box {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px dashed #e0e5ff;
            margin-top: 1rem;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .receipt-total {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 2px solid var(--primary-color);
            margin-top: 0.5rem;
        }
        
        /* สำหรับ PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        
        /* สำหรับ PDF ครึ่งหน้า */
        .half-page-pdf {
            width: 148mm;
            height: 105mm;
            padding: 15mm;
            box-sizing: border-box;
        }
        
        /* กล้องถ่ายรูป */
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        #tongue-camera, #face-camera {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }
        
        .captured-image-container {
            margin-top: 15px;
            text-align: center;
        }
        
        .captured-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            border: 3px solid #ddd;
        }
        
        /* สไตล์สำหรับส่วนลด */
        .discount-container {
            background-color: #fff9e6;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .discount-badge {
            background-color: #ffeaa7;
            color: #d63031;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        /* สไตล์สำหรับ Performance Report */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* สไตล์สำหรับ Patient History */
        .patient-history-item {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .patient-history-date {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .patient-history-diagnosis {
            color: #555;
            font-size: 0.9rem;
        }
        
        .patient-history-services {
            font-size: 0.85rem;
            color: #777;
        }
        
        /* สไตล์สำหรับรูปภาพใน PDF */
        .pdf-patient-image {
            width: 120px;
            height: 150px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px;
        }
        
        .pdf-images-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        
        .pdf-image-item {
            text-align: center;
            margin: 10px;
        }
        
        .pdf-image-label {
            font-weight: bold;
            margin-top: 5px;
            color: #555;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .card {
                margin-bottom: 1.5rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn-group {
                width: 100%;
            }
            
            .service-chip {
                min-width: 140px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .pdf-patient-image {
                width: 80px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse me-2"></i>
                OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showMainForm()"><i class="bi bi-house-door me-1"></i> หน้าหลัก</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openSavedList()"><i class="bi bi-folder me-1"></i> ประวัติผู้ป่วย</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAppointments()"><i class="bi bi-calendar-check me-1"></i> นัดหมาย</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPerformanceReport()"><i class="bi bi-graph-up me-1"></i> รายงานสถิติ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4" id="main-content">
        <!-- ค้นหาประวัติ -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-search me-2"></i> ค้นหาประวัติผู้ป่วย
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input id="searchBox" class="form-control" placeholder="ค้นหาตามชื่อ, HN, อาการ..." oninput="searchRecords()">
                            </div>
                            <div class="col-md-4">
                                <input id="searchIdCard" class="form-control" placeholder="ค้นหาตามเลขบัตรประชาชน..." oninput="searchRecords()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="openSavedList()">
                                    <i class="bi bi-folder me-2"></i> ประวัติทั้งหมด
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100" onclick="openPatientList()">
                                    <i class="bi bi-people me-2"></i> รายชื่อผู้ป่วย
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ข้อมูลผู้ป่วย -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-person-circle me-2"></i> ข้อมูลผู้ป่วย
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">HN </label>
                                <input id="hn" type="text" class="form-control" placeholder="เช่น HN001234">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ชื่อ - สกุล <span class="text-danger">*</span></label>
                                <input id="pname" class="form-control" placeholder="กรุณากรอกชื่อ-สกุลผู้ป่วย" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">เพศ <span class="text-danger">*</span></label>
                                <select id="gender" class="form-select" required>
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                    <option value="อื่น">อื่น</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขบัตรประชาชน</label>
                                <input id="idCard" type="text" class="form-control" placeholder="กรอกเลขบัตรประชาชน 13 หลัก">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อายุ <span class="text-danger">*</span></label>
                                <input id="age" type="number" class="form-control" min="0" max="120" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เบอร์โทรศัพท์</label>
                                <input id="phone" type="tel" class="form-control" placeholder="กรอกเบอร์โทรศัพท์">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เบอร์โทรฉุกเฉิน</label>
                                <input id="emergencyPhone" type="tel" class="form-control" placeholder="กรอกเบอร์โทรฉุกเฉิน">
                            </div>
                            
                            <!-- ส่วนที่อยู่ -->
                            <div class="col-md-12">
                                <label class="form-label">ที่อยู่</label>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <input id="address" class="form-control" placeholder="บ้านเลขที่, หมู่, ซอย">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <input id="road" class="form-control" placeholder="ถนน">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <input id="subdistrict" class="form-control" placeholder="ตำบล/แขวง">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <input id="district" class="form-control" placeholder="อำเภอ/เขต">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <input id="province" class="form-control" placeholder="จังหวัด">
                                    </div>
                                    <div class="col-md-4">
                                        <input id="zipcode" class="form-control" placeholder="รหัสไปรษณีย์">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">โรคประจำตัว</label>
                                <input id="chronicDisease" type="text" class="form-control" placeholder="กรอกโรคประจำตัว (ถ้ามี)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">แพ้ยา</label>
                                <input id="drugAllergy" type="text" class="form-control" placeholder="กรอกยาที่แพ้ (ถ้ามี)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">แพ้อาหาร</label>
                                <input id="foodAllergy" type="text" class="form-control" placeholder="กรอกอาหารที่แพ้ (ถ้ามี)">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">BP (ความดันโลหิต)</label>
                                <input id="bloodPressure" type="text" class="form-control" placeholder="เช่น 120/80 mmHg">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ชีพจร (P)</label>
                                <input id="pulse" type="number" class="form-control" placeholder="เช่น 72">
                            </div>
        
                            <div class="col-md-3">
                                <label class="form-label"> (SpO2)</label>
                                <input id="spo2" type="number" class="form-control" placeholder="เช่น 98" min="0" max="100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อุณหภูมิ (Temp)</label>
                                <input id="temperature" type="number" step="0.1" class="form-control" placeholder="เช่น 36.5">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">น้ำหนัก (Weight)</label>
                                <input id="weight" type="number" step="0.1" class="form-control" placeholder="เช่น 65.5" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วันที่ตรวจ</label>
                                <input id="visitDate" type="date" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เวลา</label>
                                <input id="visitTime" type="time" class="form-control" value="09:00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- อาการและประวัติ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-clipboard-pulse me-2"></i> อาการและการวินิจฉัย
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">อาการสำคัญ(主诉)</label>
                            <textarea id="symptom" rows="3" class="form-control" placeholder="อาการที่ผู้ป่วยมาพบแพทย์"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">อาการปัจจุบัน(现病史)</label>
                            <textarea id="history" rows="2" class="form-control" placeholder="ประวัติการเจ็บป่วย / ประวัติการรักษา"></textarea>
                        </div>
                        
                        <!-- ระบบถ่ายรูปลิ้นและใบหน้า -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ถ่ายรูปลิ้น</label>
                                    <div class="camera-container">
                                        <video id="tongue-camera" autoplay playsinline></video>
                                        <div class="camera-controls">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="captureTongueImage()">
                                                <i class="bi bi-camera me-1"></i> ถ่ายรูปลิ้น
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="startTongueCamera()">
                                                <i class="bi bi-arrow-clockwise me-1"></i> เริ่มใหม่
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="switchTongueCamera()">
                                                <i class="bi bi-arrow-left-right me-1"></i> สลับกล้อง
                                            </button>
                                        </div>
                                    </div>
                                    <div class="captured-image-container">
                                        <img id="tongue-image-preview" class="captured-image d-none" alt="รูปลิ้น">
                                        <input type="hidden" id="tongue-image-data">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ถ่ายรูปใบหน้า</label>
                                    <div class="camera-container">
                                        <video id="face-camera" autoplay playsinline></video>
                                        <div class="camera-controls">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="captureFaceImage()">
                                                <i class="bi bi-camera me-1"></i> ถ่ายรูปหน้า
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="startFaceCamera()">
                                                <i class="bi bi-arrow-clockwise me-1"></i> เริ่มใหม่
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="switchFaceCamera()">
                                                <i class="bi bi-arrow-left-right me-1"></i> สลับกล้อง
                                            </button>
                                        </div>
                                    </div>
                                    <div class="captured-image-container">
                                        <img id="face-image-preview" class="captured-image d-none" alt="รูปหน้า">
                                        <input type="hidden" id="face-image-data">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ลักษณะลิ้น (เลือกได้หลายข้อ)</label>
                                    <div id="tongueChips" class="d-flex flex-wrap">
                                        <span class="chip" data-val="红舌">红舌</span>
                                        <span class="chip" data-val="红绛舌">红绛舌</span>
                                        <span class="chip" data-val="淡白舌">淡白舌</span>
                                        <span class="chip" data-val="青紫舌">青紫舌</span>
                                        <span class="chip" data-val="胖大舌">胖大舌</span>
                                        <span class="chip" data-val="裂纹舌">裂纹舌</span>
                                        <span class="chip" data-val="齿痕舌">齿痕舌</span>
                                        <span class="chip" data-val="点剌舌">点剌舌</span>
                                        <span class="chip" data-val="腻苔">腻苔</span>
                                        <span class="chip" data-val="厚苔">厚苔</span>
                                        <span class="chip" data-val="薄苔">薄苔</span>
                                        <span class="chip" data-val="白苔">白苔</span>
                                        <span class="chip" data-val="黄色苔">黄色苔</span>
                                        <span class="chip" data-val="ปลายลิ้นเเดง">ปลายลิ้นเเดง</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชีพจรแพทย์แผนจีน (เลือกได้หลายข้อ)</label>
                                    <div id="pulseChips" class="d-flex flex-wrap">
                                        <span class="chip" data-val="ปกติ">ปกติ</span>
                                        <span class="chip" data-val="数脉">数脉</span>
                                        <span class="chip" data-val="迟脉">迟脉</span>
                                        <span class="chip" data-val="缓脉">缓脉</span>
                                        <span class="chip" data-val="浮脉">浮脉</span>
                                        <span class="chip" data-val="沉脉">沉脉</span>
                                        <span class="chip" data-val="滑脉">滑脉</span>
                                        <span class="chip" data-val="涩脉">涩脉</span>
                                        <span class="chip" data-val="弦脉">弦脉</span>
                                        <span class="chip" data-val="洪脉">洪脉</span>
                                        <span class="chip" data-val="细脉">细脉</span>
                                        <span class="chip" data-val="弱脉">弱脉</span>
                                        <span class="chip" data-val="紧脉">紧脉</span>
                                        <span class="chip" data-val="结脉">结脉</span>
                                        <span class="chip" data-val="代脉">代脉</span>
                                        <span class="chip" data-val="อื่นๆ">อื่นๆ</span>
                                    </div>
                                    <input id="otherPulse" type="text" class="form-control mt-2" placeholder="ระบุชีพจรอื่นๆ" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">วินิจฉัย (แพทย์แผนจีน)</label>
                                <input id="tcmDiag" class="form-control" placeholder="เช่น 肝郁化火">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วินิจฉัยWestern (Western Dx)</label>
                                <input id="westDiag" class="form-control" placeholder="เช่น Tension Headache">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- แผนการรักษา -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-prescription me-2"></i> แผนการรักษา
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">แผนการรักษา / คำแนะนำ</label>
                            <textarea id="plan" class="form-control" rows="3" placeholder="ให้คำแนะนำการรักษา การดูแลตนเอง หรือข้อควรปฏิบัติ"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ยาสมุนไพรที่แนะนำ</label>
                            <textarea id="herbRecommendation" class="form-control" rows="2" placeholder="เช่น แนะนำให้รับประทานสมุนไพร..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">จำนวนวันรักษา</label>
                                <div class="input-group">
                                    <input id="treatmentDays" type="number" class="form-control" min="1" value="7">
                                    <span class="input-group-text">วัน</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">หมายเหตุเพิ่มเติม</label>
                                <input id="additionalNote" class="form-control" placeholder="หมายเหตุเพิ่มเติม">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- บริการและค่าใช้จ่าย -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-cash-coin me-2"></i> บริการและค่าใช้จ่าย
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="section-title">เลือกบริการที่ได้รับ</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ฝังเข็ม + กระตุ้นไฟฟ้า" data-price="700">
                                        <div>ฝังเข็ม + กระตุ้นไฟฟ้า</div>
                                        <span class="service-price">700 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ฝังเข็ม + ครอบแก้ว" data-price="850">
                                        <div>ฝังเข็ม + ครอบแก้ว</div>
                                        <span class="service-price">850 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ครอบแก้ว" data-price="500">
                                        <div>ตรวจ + ครอบแก้ว</div>
                                        <span class="service-price">500 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ตรวจ + ยาจีน" data-price="750">
                                        <div>ตรวจ + ยาจีน</div>
                                        <span class="service-price">750 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="นวดกดจุด" data-price="400">
                                        <div>ตรวจ + นวดกดจุด ทุยหนา</div>
                                        <span class="service-price">600 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ตรวจทั่วไป" data-price="300">
                                        <div>ตรวจทั่วไป (เเมะ)</div>
                                        <span class="service-price">300 บาท</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ส่วนลด -->
                            <div class="discount-container">
                                <h6 class="section-title mb-3">ส่วนลด</h6>
                                <div class="row align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">ประเภทส่วนลด</label>
                                        <select id="discountType" class="form-select" onchange="updateDiscount()">
                                            <option value="none">ไม่มีส่วนลด</option>
                                            <option value="percent">เปอร์เซ็นต์ (%)</option>
                                            <option value="amount">จำนวนเงิน (บาท)</option>
                                            <option value="custom">ระบุเอง</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">มูลค่าส่วนลด</label>
                                        <div class="input-group">
                                            <input id="discountValue" type="number" class="form-control" min="0" value="0" oninput="updateDiscount()">
                                            <span id="discountUnit" class="input-group-text">บาท</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">เหตุผลส่วนลด (ถ้ามี)</label>
                                        <input id="discountReason" type="text" class="form-control" placeholder="เช่น สมาชิก, โปรโมชัน" oninput="updateDiscount()">
                                    </div>
                                </div>
                                <div id="discountDisplay" class="mt-3 d-none">
                                    <span class="discount-badge">ส่วนลด:</span>
                                    <span id="discountAmountText" class="ms-2 fw-bold">0 บาท</span>
                                    <span id="discountReasonText" class="ms-2 text-muted"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="receipt-box">
                            <h6 class="section-title">ใบเสร็จรับเงิน</h6>
                            <div id="receiptItems">
                                <!-- ข้อมูลใบเสร็จจะถูกเพิ่มโดย JavaScript -->
                            </div>
                            <div class="receipt-item" id="discountReceiptItem" style="display: none;">
                                <span><strong>ส่วนลด</strong> <span id="discountReasonReceipt"></span></span>
                                <span><strong>-<span id="discountAmountReceipt">0</span> บาท</strong></span>
                            </div>
                            <div class="receipt-total">
                                <span>รวมทั้งสิ้น</span>
                                <span id="totalCost">0 บาท</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - การดำเนินการและนัดหมาย -->
            <div class="col-lg-4">
                <!-- ปุ่มดำเนินการ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-gear me-2"></i> การดำเนินการ
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="saveOPD()">
                                <i class="bi bi-save me-2"></i> บันทึกข้อมูล OPD
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportOPDToPDF()">
                                <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกเป็น PDF
                            </button>
                            
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-receipt me-2"></i> ออกใบเสร็จ
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportReceiptPDF()">ใบเสร็จเต็มหน้า</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportHalfPagePDF()">ใบเสร็จครึ่งหน้า</a></li>
                                </ul>
                            </div>
                            
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-file-text me-2"></i> ออกใบรับรองแพทย์
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportMedicalCertPDF()">ใบรับรองแพทย์เต็มหน้า</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportMedicalCertHalfPage()">ใบรับรองแพทย์ครึ่งหน้า</a></li>
                                </ul>
                            </div>
                            
                            <button class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="bi bi-eraser me-2"></i> ล้างฟอร์ม
                            </button>
                        </div>
                    </div>
                </div>

                <!-- นัดหมาย -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-calendar-plus me-2"></i> นัดหมายครั้งต่อไป
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">วัน/เวลานัดหมาย</label>
                            <input id="appointDate" type="datetime-local" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ประเภทการนัด</label>
                            <select id="appointType" class="form-select">
                                <option value="ตรวจติดตาม">ตรวจติดตาม</option>
                                <option value="ฝังเข็ม">ฝังเข็ม</option>
                                <option value="นวดกดจุด">นวดทุยหนา</option>
                                <option value="ครอบแก้ว">ครอบแก้ว</option>
                                <option value="รับยา">รับยา</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <input id="appointNote" class="form-control" placeholder="หมายเหตุเพิ่มเติม">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="saveAppointment()">
                                <i class="bi bi-calendar-check me-2"></i> บันทึกการนัดหมาย
                            </button>
                            <button class="btn btn-outline-secondary" onclick="loadAppointments()">
                                <i class="bi bi-list-ul me-2"></i> ดูการนัดหมายทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- สถิติย่อ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart me-2"></i> สถิติวันนี้
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-number" id="todayPatients">0</div>
                                <div class="stat-label">ผู้ป่วยวันนี้</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-number" id="todayRevenue">0</div>
                                <div class="stat-label">รายได้วันนี้ (บาท)</div>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary w-100" onclick="showPerformanceReport()">
                                    <i class="bi bi-graph-up me-2"></i> ดูรายงานสถิติเต็ม
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Report Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="performance-report">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i> รายงานสถิติและ Performance
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="showMainForm()">
                            <i class="bi bi-arrow-left me-2"></i> กลับหน้าหลัก
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="exportReportPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายงาน
                        </button>
                    </div>
                    <div class="col-md-3">
                        <select id="reportPeriod" class="form-select" onchange="updatePerformanceReport()">
                            <option value="today">วันนี้</option>
                            <option value="week">สัปดาห์นี้</option>
                            <option value="month">เดือนนี้</option>
                            <option value="year">ปีนี้</option>
                            <option value="all">ทั้งหมด</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="doctorSelect" class="form-select" onchange="updatePerformanceReport()">
                            <option value="all">แพทย์ทั้งหมด</option>
                            <option value="dr1">แพทย์จีน ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย</option>
                            <option value="dr2">แพทย์จีน สาคร เเง้นกลางดอน</option>
                            <option value="dr3">แพทย์จีน กิ่งเเก้ว เเง้นกลางดอน</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPatients">0</div>
                            <div class="stat-label">จำนวนเคสทั้งหมด</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRevenue">0</div>
                            <div class="stat-label">รายได้ทั้งหมด (บาท)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="avgRevenue">0</div>
                            <div class="stat-label">รายได้เฉลี่ยต่อเคส (บาท)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="topService">-</div>
                            <div class="stat-label">บริการยอดนิยม</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-2"></i> สัดส่วนโรคที่รักษา
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="diseaseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i> รายได้แพทย์
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="doctorRevenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-list-ul me-2"></i> โรคที่พบบ่อย (TOP 5)
                            </div>
                            <div class="card-body">
                                <div id="topDiseasesList">
                                    <div class="text-center text-muted">กำลังโหลดข้อมูล...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-currency-dollar me-2"></i> รายได้แพทย์แต่ละท่าน
                            </div>
                            <div class="card-body">
                                <div id="doctorRevenueList">
                                    <div class="text-center text-muted">กำลังโหลดข้อมูล...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient List Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="patient-list-section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-people me-2"></i> รายชื่อผู้ป่วยทั้งหมด
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="showMainForm()">
                        <i class="bi bi-arrow-left me-1"></i> กลับหน้าหลัก
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input id="patientSearch" class="form-control" placeholder="ค้นหาผู้ป่วย..." oninput="filterPatientList()">
                    </div>
                    <div class="col-md-3">
                        <select id="patientSort" class="form-select" onchange="renderPatientList()">
                            <option value="name">เรียงตามชื่อ</option>
                            <option value="recent">เรียงตามล่าสุด</option>
                            <option value="visits">เรียงตามจำนวนครั้ง</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="exportPatientListPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายชื่อ
                        </button>
                    </div>
                </div>
                
                <div id="patientListContainer" style="max-height: 600px; overflow-y: auto;">
                    <!-- รายชื่อผู้ป่วยจะแสดงที่นี่ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Patient History Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="patient-history-section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-clock-history me-2"></i> ประวัติการรักษา
                    <span id="patientHistoryName" class="ms-2 fw-bold"></span>
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="openPatientList()">
                        <i class="bi bi-arrow-left me-1"></i> กลับหน้ารายชื่อ
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="patient-info-box">
                            <h6>ข้อมูลผู้ป่วย</h6>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <div class="info-label">ชื่อ-สกุล</div>
                                    <div class="info-value" id="historyPatientName">-</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="info-label">อายุ</div>
                                    <div class="info-value" id="historyPatientAge">-</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="info-label">เพศ</div>
                                    <div class="info-value" id="historyPatientGender">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">เลขบัตรประชาชน</div>
                                    <div class="info-value" id="historyPatientIdCard">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">เบอร์โทรศัพท์</div>
                                    <div class="info-value" id="historyPatientPhone">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">โรคประจำตัว</div>
                                    <div class="info-value" id="historyPatientChronic">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">แพ้ยา/อาหาร</div>
                                    <div class="info-value" id="historyPatientAllergy">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i> สถิติผู้ป่วย
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-number" id="historyTotalVisits">0</div>
                                        <div class="stat-label">จำนวนครั้งที่รักษา</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="historyTotalSpent">0</div>
                                        <div class="stat-label">ยอดใช้จ่ายทั้งหมด (บาท)</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="historyAvgSpent">0</div>
                                        <div class="stat-label">ค่าใช้จ่ายเฉลี่ย (บาท)</div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <div class="stat-label">โรคที่พบบ่อย</div>
                                        <div class="info-value" id="historyCommonDiagnosis">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h5 class="section-title">ประวัติการรักษาทั้งหมด</h5>
                        <div id="patientHistoryList">
                            <!-- ประวัติการรักษาจะแสดงที่นี่ -->
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="createNewVisitForPatient()">
                            <i class="bi bi-plus-circle me-2"></i> สร้างบันทึกการรักษาใหม่
                        </button>
                        <button class="btn btn-outline-success" onclick="exportPatientHistoryPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายงานประวัติ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแสดงประวัติ -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ประวัติบันทึก OPD ล่าสุด</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="savedList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแสดงการนัดหมาย -->
    <div class="modal fade" id="appointmentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">การนัดหมายทั้งหมด</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="appointmentList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // เก็บข้อมูลใน localStorage
        const STORAGE_KEY = 'opd_tcm_records';
        const APPOINTMENT_KEY = 'opd_appointments';

        // ตัวแปรเก็บข้อมูลบริการและราคา
        let selectedServices = [];
        let totalCost = 0;
        let discountAmount = 0;
        let discountType = 'none';
        
        // ตัวแปรสำหรับ Chart
        let diseaseChart = null;
        let doctorRevenueChart = null;
        
        // ตัวแปรสำหรับเก็บข้อมูลผู้ป่วยที่กำลังดูอยู่
        let currentPatientIdCard = null;
        let currentPatientRecords = [];
        
        // ตัวแปรสำหรับจัดการกล้อง
        let tongueCameraStream = null;
        let faceCameraStream = null;
        let tongueCameraFacingMode = 'environment'; // เริ่มด้วยกล้องหลัง
        let faceCameraFacingMode = 'user'; // เริ่มด้วยกล้องหน้า

        // ข้อมูลคลินิกซินไท
        const clinicInfo = {
            name: "ซินไท คลินิกการแพทย์แผนจีน",
            nameShort: "ซินไท คลินิกเเพทย์เเผนจีน",
            license: "ใบอนุญาตสถานพยาบาลเลขที่ 30109000365",
            addressThai: "644/3 หมู่ 10 ตำบลโคกกรวด อำเภอเมือง จังหวัดนครราชสีมา 30280",
            addressEnglish: "644/3 Moo 10, Tambon Khok Kruat, Mueang District, Nakhon Ratchasima 30280",
            phone: "โทรศัพท์: 080-662-4224",
            phoneEnglish: "Tel: 080-662-4224",
            website: "www.sinthaitcm.com",
            lineId: "@349bjjli",
            email: "sinthaitcm@gmail.com"
        };

        // เริ่มต้นเลขที่ใบเสร็จจาก 448
        let receiptCounter = 448;

        // เริ่มต้นเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            // ตั้งค่าวันที่ปัจจุบัน
            const today = new Date();
            document.getElementById('visitDate').value = today.toISOString().split('T')[0];
            
            // ตั้งค่าวันที่นัดหมาย (7 วันข้างหน้า)
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().slice(0, 16);
            document.getElementById('appointDate').value = nextWeekStr;
            
            // ตั้งค่า chip handlers
            attachChipHandlers();
            
            // ตั้งค่า service chip handlers
            attachServiceChipHandlers();
            
            // โหลดข้อมูลเก่า (ถ้ามี)
            renderSavedList();
            loadAppointments();
            
            // อัพเดทใบเสร็จ
            updateReceipt();
            
            // อัพเดทสถิติวันนี้
            updateTodayStats();
            
            // เริ่มกล้องถ่ายรูป
            initCameras();
        });

        // เริ่มกล้องถ่ายรูป
        async function initCameras() {
            try {
                await startTongueCamera();
                await startFaceCamera();
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องได้: ", err);
                // แสดงข้อความเตือน
                document.querySelectorAll('.camera-container').forEach(container => {
                    container.innerHTML = `
                        <div class="d-flex flex-column justify-content-center align-items-center h-100 text-white">
                            <i class="bi bi-camera-video-off" style="font-size: 3rem;"></i>
                            <p class="mt-2">ไม่สามารถเข้าถึงกล้องได้</p>
                            <p class="small">กรุณาอนุญาตการเข้าถึงกล้อง</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="initCameras()">
                                <i class="bi bi-arrow-clockwise me-1"></i> ลองอีกครั้ง
                            </button>
                        </div>
                    `;
                });
            }
        }

        // เริ่มกล้องลิ้น
        async function startTongueCamera() {
            try {
                // หยุดสตรีมเดิมถ้ามี
                if (tongueCameraStream) {
                    tongueCameraStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: tongueCameraFacingMode
                    } 
                };
                
                tongueCameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('tongue-camera');
                video.srcObject = tongueCameraStream;
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องลิ้นได้: ", err);
                // ลองใช้ค่าเริ่มต้นถ้าเลือกกล้องไม่สำเร็จ
                if (tongueCameraFacingMode !== 'environment') {
                    tongueCameraFacingMode = 'environment';
                    await startTongueCamera();
                }
            }
        }

        // เริ่มกล้องหน้า
        async function startFaceCamera() {
            try {
                // หยุดสตรีมเดิมถ้ามี
                if (faceCameraStream) {
                    faceCameraStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: faceCameraFacingMode
                    } 
                };
                
                faceCameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('face-camera');
                video.srcObject = faceCameraStream;
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องหน้าได้: ", err);
                // ลองใช้ค่าเริ่มต้นถ้าเลือกกล้องไม่สำเร็จ
                if (faceCameraFacingMode !== 'user') {
                    faceCameraFacingMode = 'user';
                    await startFaceCamera();
                }
            }
        }

        // สลับกล้องลิ้น
        async function switchTongueCamera() {
            tongueCameraFacingMode = tongueCameraFacingMode === 'user' ? 'environment' : 'user';
            await startTongueCamera();
            alert(`สลับกล้องลิ้นเป็น: ${tongueCameraFacingMode === 'user' ? 'กล้องหน้า' : 'กล้องหลัง'}`);
        }

        // สลับกล้องหน้า
        async function switchFaceCamera() {
            faceCameraFacingMode = faceCameraFacingMode === 'user' ? 'environment' : 'user';
            await startFaceCamera();
            alert(`สลับกล้องหน้าเป็น: ${faceCameraFacingMode === 'user' ? 'กล้องหน้า' : 'กล้องหลัง'}`);
        }

        // ถ่ายรูปลิ้น
        function captureTongueImage() {
            const video = document.getElementById('tongue-camera');
            if (!video.srcObject) {
                alert('กรุณาเริ่มกล้องก่อนถ่ายรูป');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('tongue-image-data').value = imageData;
            
            const preview = document.getElementById('tongue-image-preview');
            preview.src = imageData;
            preview.classList.remove('d-none');
            
            alert('ถ่ายรูปลิ้นสำเร็จ!');
        }

        // ถ่ายรูปหน้า
        function captureFaceImage() {
            const video = document.getElementById('face-camera');
            if (!video.srcObject) {
                alert('กรุณาเริ่มกล้องก่อนถ่ายรูป');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('face-image-data').value = imageData;
            
            const preview = document.getElementById('face-image-preview');
            preview.src = imageData;
            preview.classList.remove('d-none');
            
            alert('ถ่ายรูปหน้าสำเร็จ!');
        }

        // จัดการ chip selection
        function attachChipHandlers() {
            // ลักษณะลิ้น
            document.querySelectorAll('#tongueChips .chip').forEach(chip => {
                chip.addEventListener('click', () => chip.classList.toggle('active'));
            });
            
            // ชีพจรแพทย์แผนจีน
            document.querySelectorAll('#pulseChips .chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const value = this.dataset.val;
                    if (value === 'อื่นๆ') {
                        const otherPulseInput = document.getElementById('otherPulse');
                        otherPulseInput.style.display = this.classList.contains('active') ? 'none' : 'block';
                        if (!this.classList.contains('active')) {
                            otherPulseInput.focus();
                        }
                    }
                    this.classList.toggle('active');
                });
            });
        }

        // จัดการ service chip selection
        function attachServiceChipHandlers() {
            document.querySelectorAll('.service-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const service = this.dataset.service;
                    const price = parseInt(this.dataset.price);
                    
                    // ถ้าบริการนี้ถูกเลือกอยู่แล้ว ให้เอาออก
                    if (this.classList.contains('active')) {
                        this.classList.remove('active');
                        selectedServices = selectedServices.filter(s => s.service !== service);
                    } else {
                        // ถ้ายังไม่ถูกเลือก ให้เพิ่มเข้าไป
                        this.classList.add('active');
                        selectedServices.push({
                            service: service,
                            price: price
                        });
                    }
                    
                    // อัพเดทใบเสร็จ
                    updateReceipt();
                });
            });
        }

        // อัพเดทส่วนลด
        function updateDiscount() {
            const type = document.getElementById('discountType').value;
            const value = parseFloat(document.getElementById('discountValue').value) || 0;
            const reason = document.getElementById('discountReason').value.trim();
            
            discountType = type;
            
            // อัพเดทหน่วยแสดงผล
            const discountUnit = document.getElementById('discountUnit');
            discountUnit.textContent = type === 'percent' ? '%' : 'บาท';
            
            // อัพเดทแสดงผลส่วนลด
            const discountDisplay = document.getElementById('discountDisplay');
            const discountAmountText = document.getElementById('discountAmountText');
            const discountReasonText = document.getElementById('discountReasonText');
            
            if (type === 'none' || value === 0) {
                discountDisplay.classList.add('d-none');
                discountAmount = 0;
            } else {
                discountDisplay.classList.remove('d-none');
                
                if (type === 'percent') {
                    const subtotal = selectedServices.reduce((sum, item) => sum + item.price, 0);
                    discountAmount = (subtotal * value / 100);
                    discountAmountText.textContent = `${value}% (${discountAmount.toFixed(2)} บาท)`;
                } else {
                    discountAmount = value;
                    discountAmountText.textContent = `${discountAmount.toFixed(2)} บาท`;
                }
                
                if (reason) {
                    discountReasonText.textContent = `- ${reason}`;
                } else {
                    discountReasonText.textContent = '';
                }
            }
            
            // อัพเดทใบเสร็จ
            updateReceipt();
        }

        // อัพเดทใบเสร็จ
        function updateReceipt() {
            const container = document.getElementById('receiptItems');
            let html = '';
            
            // คำนวณราคารวมก่อนหักส่วนลด
            const subtotal = selectedServices.reduce((sum, item) => sum + (item.price || 0), 0);
            
            // คำนวณส่วนลด
            let discount = 0;
            if (discountType !== 'none' && discountAmount > 0) {
                discount = discountAmount;
            }
            
            // คำนวณราคาสุทธิ
            totalCost = Math.max(0, subtotal - discount);
            
            selectedServices.forEach(item => {
                html += `
                    <div class="receipt-item">
                        <span>${item.service}</span>
                        <span>${item.price.toLocaleString()} บาท</span>
                    </div>
                `;
            });
            
            if (selectedServices.length === 0) {
                html = '<div class="text-center text-muted py-3">ยังไม่ได้เลือกบริการ</div>';
            }
            
            container.innerHTML = html;
            
            // แสดงส่วนลดในใบเสร็จ
            const discountItem = document.getElementById('discountReceiptItem');
            const discountAmountReceipt = document.getElementById('discountAmountReceipt');
            const discountReasonReceipt = document.getElementById('discountReasonReceipt');
            
            if (discount > 0) {
                discountItem.style.display = 'flex';
                discountAmountReceipt.textContent = discount.toFixed(2);
                const reason = document.getElementById('discountReason').value.trim();
                discountReasonReceipt.textContent = reason ? `(${reason})` : '';
            } else {
                discountItem.style.display = 'none';
            }
            
            document.getElementById('totalCost').textContent = totalCost.toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' บาท';
        }

        // ฟังก์ชันดึงค่าลิ้นที่เลือก
        function getSelectedTongue() {
            return Array.from(document.querySelectorAll('#tongueChips .chip.active'))
                        .map(c => c.dataset.val);
        }

        // ฟังก์ชันดึงค่าชีพจรที่เลือก
        function getSelectedPulse() {
            const selectedChips = Array.from(document.querySelectorAll('#pulseChips .chip.active'))
                                      .map(c => c.dataset.val);
            
            // ถ้ามีเลือก 'อื่นๆ' ให้เพิ่มค่าจาก input
            if (selectedChips.includes('อื่นๆ')) {
                const otherPulse = document.getElementById('otherPulse').value.trim();
                if (otherPulse) {
                    // ลบ 'อื่นๆ' ออกและเพิ่มค่าที่กรอกเอง
                    selectedChips.splice(selectedChips.indexOf('อื่นๆ'), 1);
                    selectedChips.push(otherPulse);
                }
            }
            
            return selectedChips;
        }

        // สร้างเลขที่ใบเสร็จแบบ Incremental
        function generateReceiptNumber() {
            receiptCounter++;
            return `RCP${receiptCounter.toString().padStart(6, '0')}`;
        }

        // บันทึกข้อมูล OPD
        function saveOPD() {
            const record = {
                id: Date.now(),
                name: document.getElementById('pname').value.trim(),
                hn: document.getElementById('hn').value.trim(),
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                idCard: document.getElementById('idCard').value,
                phone: document.getElementById('phone').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                chronicDisease: document.getElementById('chronicDisease').value,
                drugAllergy: document.getElementById('drugAllergy').value,
                foodAllergy: document.getElementById('foodAllergy').value,
                // ที่อยู่
                address: document.getElementById('address').value,
                road: document.getElementById('road').value,
                subdistrict: document.getElementById('subdistrict').value,
                district: document.getElementById('district').value,
                province: document.getElementById('province').value,
                zipcode: document.getElementById('zipcode').value,
                // สัญญาณชีพ
                bloodPressure: document.getElementById('bloodPressure').value,
                pulse: document.getElementById('pulse').value,
                spo2: document.getElementById('spo2').value,
                temperature: document.getElementById('temperature').value,
                weight: document.getElementById('weight').value,
                visitDate: document.getElementById('visitDate').value,
                visitTime: document.getElementById('visitTime').value,
                symptom: document.getElementById('symptom').value,
                history: document.getElementById('history').value,
                tongueImage: document.getElementById('tongue-image-data').value,
                faceImage: document.getElementById('face-image-data').value,
                tongue: getSelectedTongue(),
                pulseTCM: getSelectedPulse(),
                tcmDiag: document.getElementById('tcmDiag').value,
                westDiag: document.getElementById('westDiag').value,
                plan: document.getElementById('plan').value,
                herbRecommendation: document.getElementById('herbRecommendation').value,
                treatmentDays: document.getElementById('treatmentDays').value,
                services: [...selectedServices],
                subtotal: selectedServices.reduce((sum, item) => sum + (item.price || 0), 0),
                discount: discountAmount,
                discountType: discountType,
                discountReason: document.getElementById('discountReason').value,
                totalCost: totalCost,
                additionalNote: document.getElementById('additionalNote').value,
                savedAt: new Date().toLocaleString('th-TH'),
                // เพิ่มข้อมูลแพทย์ (ในระบบจริงอาจดึงจากผู้ใช้ที่ล็อกอิน)
                doctor: document.getElementById('doctorSelect') ? document.getElementById('doctorSelect').value : 'dr1'
            };

            if (!record.name) {
                alert('กรุณากรอกชื่อผู้ป่วย');
                return;
            }

            if (!record.age) {
                alert('กรุณากรอกอายุผู้ป่วย');
                return;
            }

            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการอย่างน้อย 1 รายการ');
                return;
            }

            // ดึงข้อมูลเก่าจาก localStorage
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            records.unshift(record);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));

            alert('บันทึกข้อมูลสำเร็จ!');
            renderSavedList();
            updateTodayStats();
            
            // เคลียร์ฟอร์มบางส่วน (ยกเว้นข้อมูลผู้ป่วย)
            document.getElementById('symptom').value = '';
            document.getElementById('history').value = '';
            document.getElementById('tcmDiag').value = '';
            document.getElementById('westDiag').value = '';
            document.getElementById('plan').value = '';
            document.getElementById('herbRecommendation').value = '';
            document.getElementById('additionalNote').value = '';
            document.getElementById('bloodPressure').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('spo2').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('otherPulse').value = '';
            document.getElementById('otherPulse').style.display = 'none';
            
            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซตส่วนลด
            document.getElementById('discountType').value = 'none';
            document.getElementById('discountValue').value = 0;
            document.getElementById('discountReason').value = '';
            discountAmount = 0;
            discountType = 'none';
            
            // รีเซตรูปภาพ
            document.getElementById('tongue-image-preview').src = '';
            document.getElementById('tongue-image-preview').classList.add('d-none');
            document.getElementById('tongue-image-data').value = '';
            document.getElementById('face-image-preview').src = '';
            document.getElementById('face-image-preview').classList.add('d-none');
            document.getElementById('face-image-data').value = '';
            
            // รีเซตตัวแปร
            selectedServices = [];
            totalCost = 0;
            
            // อัพเดทใบเสร็จ
            updateReceipt();
            updateDiscount();
        }

        // แสดงรายการบันทึก
        function renderSavedList() {
            const container = document.getElementById('savedList');
            if (!container) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">ยังไม่มีประวัติผู้ป่วย</div>';
                return;
            }

            let html = '<div class="list-group">';
            records.slice(0, 10).forEach(record => {
                const serviceNames = record.services ? record.services.map(s => s.service).join(', ') : 'ไม่มีข้อมูล';
                const hasTongueImage = record.tongueImage ? '<i class="bi bi-image text-success me-1" title="มีรูปลิ้น"></i>' : '';
                const hasFaceImage = record.faceImage ? '<i class="bi bi-person-bounding-box text-success me-1" title="มีรูปหน้า"></i>' : '';
                const discountInfo = record.discount > 0 ? `<i class="bi bi-percent text-warning me-1" title="มีส่วนลด ${record.discount} บาท"></i>` : '';
                const hnInfo = record.hn ? `<span class="badge bg-info me-1">HN: ${record.hn}</span>` : '';
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${record.name} ${hnInfo}${hasTongueImage}${hasFaceImage}${discountInfo}</h6>
                            <small class="text-muted">${record.savedAt}</small>
                        </div>
                        <p class="mb-1">
                            <small>อายุ ${record.age} ปี, ${record.gender}</small><br>
                            <small>วินิจฉัย: ${record.tcmDiag || 'ไม่ระบุ'}</small><br>
                            <small>บริการ: ${serviceNames}</small><br>
                            <small>รวม: ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</small>
                        </p>
                        <div class="d-flex justify-content-end gap-1 mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecord(${record.id})">
                                <i class="bi bi-eye"></i> ดู
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="exportMedicalCertFromRecord(${record.id})">
                                <i class="bi bi-file-text"></i> รับรอง
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportReceiptFromRecord(${record.id})">
                                <i class="bi bi-receipt"></i> เสร็จ
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${record.id})">
                                <i class="bi bi-trash"></i> ลบ
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // โหลดข้อมูลเก่ามาแสดงในฟอร์ม
        function loadRecord(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }

            // เติมข้อมูลลงในฟอร์ม
            document.getElementById('pname').value = record.name;
            document.getElementById('hn').value = record.hn || '';
            document.getElementById('age').value = record.age;
            document.getElementById('gender').value = record.gender;
            document.getElementById('idCard').value = record.idCard || '';
            document.getElementById('phone').value = record.phone || '';
            document.getElementById('emergencyPhone').value = record.emergencyPhone || '';
            document.getElementById('chronicDisease').value = record.chronicDisease || '';
            document.getElementById('drugAllergy').value = record.drugAllergy || '';
            document.getElementById('foodAllergy').value = record.foodAllergy || '';
            // ที่อยู่
            document.getElementById('address').value = record.address || '';
            document.getElementById('road').value = record.road || '';
            document.getElementById('subdistrict').value = record.subdistrict || '';
            document.getElementById('district').value = record.district || '';
            document.getElementById('province').value = record.province || '';
            document.getElementById('zipcode').value = record.zipcode || '';
            // สัญญาณชีพ
            document.getElementById('bloodPressure').value = record.bloodPressure || '';
            document.getElementById('pulse').value = record.pulse || '';
            document.getElementById('spo2').value = record.spo2 || '';
            document.getElementById('temperature').value = record.temperature || '';
            document.getElementById('weight').value = record.weight || '';
            document.getElementById('visitDate').value = record.visitDate;
            document.getElementById('visitTime').value = record.visitTime || '09:00';
            document.getElementById('symptom').value = record.symptom;
            document.getElementById('history').value = record.history;
            document.getElementById('tcmDiag').value = record.tcmDiag;
            document.getElementById('westDiag').value = record.westDiag;
            document.getElementById('plan').value = record.plan;
            document.getElementById('herbRecommendation').value = record.herbRecommendation || '';
            document.getElementById('treatmentDays').value = record.treatmentDays || 7;
            document.getElementById('additionalNote').value = record.additionalNote || '';

            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });

            // เลือก chip ลิ้นตามข้อมูลที่บันทึก
            if (record.tongue && Array.isArray(record.tongue)) {
                record.tongue.forEach(tongueVal => {
                    const chip = document.querySelector(`#tongueChips .chip[data-val="${tongueVal}"]`);
                    if (chip) chip.classList.add('active');
                });
            }

            // รีเซ็ต chip selection ชีพจร
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            document.getElementById('otherPulse').style.display = 'none';
            document.getElementById('otherPulse').value = '';

            // เลือก chip ชีพจรตามข้อมูลที่บันทึก
            if (record.pulseTCM && Array.isArray(record.pulseTCM)) {
                record.pulseTCM.forEach(pulseVal => {
                    // ตรวจสอบว่าค่าเป็นค่ามาตรฐานหรือไม่
                    const standardChip = document.querySelector(`#pulseChips .chip[data-val="${pulseVal}"]`);
                    if (standardChip) {
                        standardChip.classList.add('active');
                        if (pulseVal === 'อื่นๆ') {
                            document.getElementById('otherPulse').style.display = 'block';
                        }
                    } else {
                        // ถ้าไม่ใช่ค่ามาตรฐาน ให้เลือก 'อื่นๆ' และใส่ค่าใน input
                        const otherChip = document.querySelector(`#pulseChips .chip[data-val="อื่นๆ"]`);
                        if (otherChip) {
                            otherChip.classList.add('active');
                            document.getElementById('otherPulse').value = pulseVal;
                            document.getElementById('otherPulse').style.display = 'block';
                        }
                    }
                });
            }

            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });

            // โหลดบริการที่บันทึกไว้
            selectedServices = [];
            if (record.services && Array.isArray(record.services)) {
                record.services.forEach(serviceItem => {
                    // หา service chip ที่ตรงกัน
                    const chip = document.querySelector(`.service-chip[data-service="${serviceItem.service}"]`);
                    if (chip) {
                        chip.classList.add('active');
                        selectedServices.push(serviceItem);
                    } else {
                        // ถ้าไม่เจอ chip ที่ตรงกัน แสดงว่าเป็นบริการอื่นๆ
                        selectedServices.push(serviceItem);
                    }
                });
            }
            
            // โหลดข้อมูลส่วนลด
            document.getElementById('discountType').value = record.discountType || 'none';
            document.getElementById('discountValue').value = record.discount || 0;
            document.getElementById('discountReason').value = record.discountReason || '';
            discountAmount = record.discount || 0;
            discountType = record.discountType || 'none';
            
            // แสดงรูปภาพที่บันทึกไว้
            if (record.tongueImage) {
                document.getElementById('tongue-image-preview').src = record.tongueImage;
                document.getElementById('tongue-image-preview').classList.remove('d-none');
                document.getElementById('tongue-image-data').value = record.tongueImage;
            }
            
            if (record.faceImage) {
                document.getElementById('face-image-preview').src = record.faceImage;
                document.getElementById('face-image-preview').classList.remove('d-none');
                document.getElementById('face-image-data').value = record.faceImage;
            }
            
            // อัพเดทใบเสร็จและส่วนลด
            updateDiscount();
            updateReceipt();

            alert('โหลดข้อมูลสำเร็จ!');
            
            // ปิด modal ถ้ามีการเปิดอยู่
            const modal = bootstrap.Modal.getInstance(document.getElementById('historyModal'));
            if (modal) {
                modal.hide();
            }
        }

        // ลบข้อมูล
        function deleteRecord(id) {
            if (!confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            records = records.filter(r => r.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            
            renderSavedList();
            updateTodayStats();
            alert('ลบข้อมูลสำเร็จ');
        }

        // อัพเดทสถิติวันนี้
        function updateTodayStats() {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const today = new Date().toISOString().split('T')[0];
            
            const todayRecords = records.filter(record => record.visitDate === today);
            const todayPatients = todayRecords.length;
            const todayRevenue = todayRecords.reduce((sum, record) => sum + (record.totalCost || 0), 0);
            
            document.getElementById('todayPatients').textContent = todayPatients;
            document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString();
        }

        // แสดงหน้าหลัก
        function showMainForm() {
            document.getElementById('main-content').classList.remove('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
        }

        // แสดงรายงานสถิติ
        function showPerformanceReport() {
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.remove('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
            updatePerformanceReport();
        }

        // แสดงหน้ารายชื่อผู้ป่วย
        function openPatientList() {
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.remove('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
            renderPatientList();
        }

        // แสดงหน้ารายละเอียดผู้ป่วย
        function openPatientHistory(idCard) {
            currentPatientIdCard = idCard;
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.remove('d-none');
            loadPatientHistory(idCard);
        }

        // แสดงรายชื่อผู้ป่วยทั้งหมด
        function renderPatientList() {
            const container = document.getElementById('patientListContainer');
            if (!container) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-people display-1 mb-3"></i><p>ยังไม่มีข้อมูลผู้ป่วย</p></div>';
                return;
            }
            
            // จัดกลุ่มผู้ป่วยตาม unique key
            const patients = {};
            records.forEach(record => {
                // สร้าง unique key จาก hn, idCard หรือชื่อ+เบอร์โทร
                const uniqueKey = record.hn || record.idCard || `${record.name}_${record.phone || 'no-phone'}`;
                
                if (!patients[uniqueKey]) {
                    patients[uniqueKey] = {
                        name: record.name,
                        hn: record.hn,
                        age: record.age,
                        gender: record.gender,
                        phone: record.phone,
                        idCard: record.idCard || 'ไม่ระบุ',
                        totalVisits: 0,
                        totalSpent: 0,
                        lastVisit: record.savedAt,
                        diagnoses: [],
                        uniqueKey: uniqueKey
                    };
                }
                
                patients[uniqueKey].totalVisits++;
                patients[uniqueKey].totalSpent += record.totalCost || 0;
                if (record.tcmDiag && !patients[uniqueKey].diagnoses.includes(record.tcmDiag)) {
                    patients[uniqueKey].diagnoses.push(record.tcmDiag);
                }
                
                // เก็บวันที่ล่าสุด
                try {
                    const recordDate = new Date(record.savedAt);
                    const currentLastDate = new Date(patients[uniqueKey].lastVisit);
                    if (recordDate > currentLastDate) {
                        patients[uniqueKey].lastVisit = record.savedAt;
                    }
                } catch (e) {
                    console.warn('Error parsing date:', e);
                }
            });
            
            // แปลงเป็นอาร์เรย์และเรียงลำดับ
            const patientArray = Object.values(patients);
            const sortBy = document.getElementById('patientSort').value;
            
            if (sortBy === 'name') {
                patientArray.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'th'));
            } else if (sortBy === 'recent') {
                patientArray.sort((a, b) => {
                    try {
                        return new Date(b.lastVisit) - new Date(a.lastVisit);
                    } catch (e) {
                        return 0;
                    }
                });
            } else if (sortBy === 'visits') {
                patientArray.sort((a, b) => (b.totalVisits || 0) - (a.totalVisits || 0));
            }
            
            // กรองตามคำค้นหา
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const filteredPatients = searchTerm ? 
                patientArray.filter(p => {
                    const nameMatch = (p.name || '').toLowerCase().includes(searchTerm);
                    const hnMatch = (p.hn || '').toLowerCase().includes(searchTerm);
                    const idCardMatch = (p.idCard || '').toLowerCase().includes(searchTerm);
                    const phoneMatch = (p.phone || '').includes(searchTerm);
                    return nameMatch || hnMatch || idCardMatch || phoneMatch;
                }) : patientArray;
            
            let html = '<div class="row">';
            
            if (filteredPatients.length === 0) {
                html = '<div class="text-center text-muted p-5"><i class="bi bi-search display-1 mb-3"></i><p>ไม่พบผู้ป่วยที่ตรงกับการค้นหา</p></div>';
            } else {
                filteredPatients.forEach(patient => {
                    const hnInfo = patient.hn ? `<span class="badge bg-info me-1">HN: ${patient.hn}</span>` : '';
                    const diagnosisText = patient.diagnoses && patient.diagnoses.length > 0 ? 
                        patient.diagnoses.slice(0, 2).join(', ') + (patient.diagnoses.length > 2 ? '...' : '') : 
                        'ไม่ระบุ';
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">${patient.name || 'ไม่ระบุชื่อ'} ${hnInfo}</h6>
                                    <p class="card-text small">
                                        <i class="bi bi-person me-1"></i> ${patient.age || 'ไม่ระบุ'} ปี, ${patient.gender || 'ไม่ระบุ'}<br>
                                        <i class="bi bi-card-text me-1"></i> ${patient.idCard || 'ไม่ระบุ'}<br>
                                        <i class="bi bi-telephone me-1"></i> ${patient.phone || 'ไม่ระบุ'}<br>
                                        <i class="bi bi-calendar-check me-1"></i> รักษา ${patient.totalVisits || 0} ครั้ง<br>
                                        <i class="bi bi-cash-coin me-1"></i> ใช้จ่าย ${(patient.totalSpent || 0).toLocaleString()} บาท<br>
                                        <i class="bi bi-clipboard-pulse me-1"></i> ${diagnosisText}
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-sm btn-outline-primary" onclick="openPatientHistory('${patient.uniqueKey}')">
                                            <i class="bi bi-clock-history"></i> ประวัติ
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="loadPatientToForm('${patient.uniqueKey}')">
                                            <i class="bi bi-plus-circle"></i> บันทึกใหม่
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // กรองรายชื่อผู้ป่วย
        function filterPatientList() {
            renderPatientList();
        }

        // โหลดข้อมูลผู้ป่วยลงในฟอร์ม
        function loadPatientToForm(uniqueKey) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            // หาบันทึกล่าสุดของผู้ป่วยนี้
            const patientRecords = records.filter(r => {
                const patientKey = r.hn || r.idCard || `${r.name}_${r.phone || 'no-phone'}`;
                return patientKey === uniqueKey;
            });
            
            if (patientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            // ใช้ข้อมูลล่าสุดของผู้ป่วย
            const latestRecord = patientRecords[0];
            
            // เติมข้อมูลพื้นฐานลงในฟอร์ม
            document.getElementById('pname').value = latestRecord.name || '';
            document.getElementById('hn').value = latestRecord.hn || '';
            document.getElementById('age').value = latestRecord.age || '';
            document.getElementById('gender').value = latestRecord.gender || 'ชาย';
            document.getElementById('idCard').value = latestRecord.idCard || '';
            document.getElementById('phone').value = latestRecord.phone || '';
            document.getElementById('emergencyPhone').value = latestRecord.emergencyPhone || '';
            document.getElementById('chronicDisease').value = latestRecord.chronicDisease || '';
            document.getElementById('drugAllergy').value = latestRecord.drugAllergy || '';
            document.getElementById('foodAllergy').value = latestRecord.foodAllergy || '';
            // ที่อยู่
            document.getElementById('address').value = latestRecord.address || '';
            document.getElementById('road').value = latestRecord.road || '';
            document.getElementById('subdistrict').value = latestRecord.subdistrict || '';
            document.getElementById('district').value = latestRecord.district || '';
            document.getElementById('province').value = latestRecord.province || '';
            document.getElementById('zipcode').value = latestRecord.zipcode || '';
            
            // กลับไปที่หน้าหลัก
            showMainForm();
            
            alert(`โหลดข้อมูลผู้ป่วย ${latestRecord.name || 'ไม่ระบุชื่อ'} เรียบร้อยแล้ว`);
        }

        // โหลดประวัติผู้ป่วย
        function loadPatientHistory(uniqueKey) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            // ค้นหาบันทึกทั้งหมดของผู้ป่วยนี้
            currentPatientRecords = records.filter(r => {
                const patientKey = r.hn || r.idCard || `${r.name}_${r.phone || 'no-phone'}`;
                return patientKey === uniqueKey;
            }).sort((a, b) => {
                try {
                    return new Date(b.visitDate) - new Date(a.visitDate);
                } catch (e) {
                    return 0;
                }
            });
            
            if (currentPatientRecords.length === 0) {
                alert('ไม่พบประวัติผู้ป่วย');
                return;
            }
            
            const patient = currentPatientRecords[0];
            
            // แสดงชื่อผู้ป่วยในหัวข้อ
            document.getElementById('patientHistoryName').textContent = patient.name || 'ไม่ระบุชื่อ';
            document.getElementById('historyPatientName').textContent = patient.name || 'ไม่ระบุ';
            document.getElementById('historyPatientAge').textContent = `${patient.age || 'ไม่ระบุ'} ปี`;
            document.getElementById('historyPatientGender').textContent = patient.gender || 'ไม่ระบุ';
            document.getElementById('historyPatientIdCard').textContent = patient.idCard || 'ไม่ระบุ';
            document.getElementById('historyPatientPhone').textContent = patient.phone || 'ไม่ระบุ';
            document.getElementById('historyPatientChronic').textContent = patient.chronicDisease || 'ไม่มี';
            document.getElementById('historyPatientAllergy').textContent = 
                `${patient.drugAllergy || 'ไม่มี'} / ${patient.foodAllergy || 'ไม่มี'}`;
            
            // คำนวณสถิติ
            const totalVisits = currentPatientRecords.length;
            const totalSpent = currentPatientRecords.reduce((sum, r) => sum + (r.totalCost || 0), 0);
            const avgSpent = totalVisits > 0 ? Math.round(totalSpent / totalVisits) : 0;
            
            // หาโรคที่พบบ่อย
            const diagnosisCount = {};
            currentPatientRecords.forEach(r => {
                if (r.tcmDiag) {
                    diagnosisCount[r.tcmDiag] = (diagnosisCount[r.tcmDiag] || 0) + 1;
                }
            });
            
            const commonDiagnosis = Object.entries(diagnosisCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([diag, count]) => `${diag} (${count} ครั้ง)`)
                .join(', ');
            
            // อัพเดทสถิติ
            document.getElementById('historyTotalVisits').textContent = totalVisits;
            document.getElementById('historyTotalSpent').textContent = totalSpent.toLocaleString();
            document.getElementById('historyAvgSpent').textContent = avgSpent.toLocaleString();
            document.getElementById('historyCommonDiagnosis').textContent = commonDiagnosis || 'ไม่ระบุ';
            
            // แสดงประวัติการรักษา
            const historyContainer = document.getElementById('patientHistoryList');
            let historyHTML = '';
            
            currentPatientRecords.forEach((record, index) => {
                const services = record.services ? record.services.map(s => s.service).join(', ') : 'ไม่ระบุ';
                
                historyHTML += `
                    <div class="patient-history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="patient-history-date">
                                    ${record.visitDate || 'ไม่ระบุวันที่'} ${record.visitTime || ''}
                                </div>
                                <div class="patient-history-diagnosis mb-2">
                                    <strong>วินิจฉัย:</strong> ${record.tcmDiag || 'ไม่ระบุ'}
                                </div>
                                <div class="patient-history-services mb-2">
                                    <strong>บริการ:</strong> ${services}
                                </div>
                                <div class="mb-2">
                                    <strong>ค่าใช้จ่าย:</strong> ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท
                                </div>
                                ${record.symptom ? `<div class="mb-1"><small><strong>อาการ:</strong> ${record.symptom.substring(0, 100)}${record.symptom.length > 100 ? '...' : ''}</small></div>` : ''}
                            </div>
                            <div class="d-flex flex-column gap-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewRecordDetails(${record.id})">
                                    <i class="bi bi-eye"></i> ดูรายละเอียด
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                    <i class="bi bi-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        // ดูรายละเอียดบันทึก
        function viewRecordDetails(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            // สร้าง modal เพื่อแสดงรายละเอียด
            const modalHTML = `
                <div class="modal fade" id="recordDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">รายละเอียดบันทึกการรักษา</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>ข้อมูลผู้ป่วย</h6>
                                        <p><strong>ชื่อ:</strong> ${record.name || 'ไม่ระบุ'}</p>
                                        <p><strong>HN:</strong> ${record.hn || 'ไม่ระบุ'}</p>
                                        <p><strong>อายุ/เพศ:</strong> ${record.age || 'ไม่ระบุ'} ปี / ${record.gender || 'ไม่ระบุ'}</p>
                                        <p><strong>วันที่ตรวจ:</strong> ${record.visitDate || 'ไม่ระบุ'} ${record.visitTime || ''}</p>
                                        ${record.address ? `<p><strong>ที่อยู่:</strong> ${record.address || ''} ${record.road || ''} ${record.subdistrict || ''} ${record.district || ''} ${record.province || ''} ${record.zipcode || ''}</p>` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>บริการและค่าใช้จ่าย</h6>
                                        ${record.services ? record.services.map(s => `<p>${s.service}: ${s.price} บาท</p>`).join('') : ''}
                                        ${record.discount > 0 ? `<p><strong>ส่วนลด:</strong> ${record.discount} บาท (${record.discountReason || ''})</p>` : ''}
                                        <p><strong>รวม:</strong> ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>อาการและการวินิจฉัย</h6>
                                        <p><strong>อาการสำคัญ:</strong> ${record.symptom || 'ไม่ระบุ'}</p>
                                        <p><strong>วินิจฉัย TCM:</strong> ${record.tcmDiag || 'ไม่ระบุ'}</p>
                                        <p><strong>วินิจฉัย Western:</strong> ${record.westDiag || 'ไม่ระบุ'}</p>
                                        <p><strong>แผนการรักษา:</strong> ${record.plan || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                ${record.tongueImage || record.faceImage ? `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>รูปภาพ</h6>
                                        <div class="row">
                                            ${record.tongueImage ? `<div class="col-md-6"><p><strong>รูปลิ้น:</strong></p><img src="${record.tongueImage}" class="img-fluid" style="max-height: 200px;"></div>` : ''}
                                            ${record.faceImage ? `<div class="col-md-6"><p><strong>รูปหน้า:</strong></p><img src="${record.faceImage}" class="img-fluid" style="max-height: 200px;"></div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                                <button type="button" class="btn btn-primary" onclick="loadRecord(${record.id})">โหลดลงฟอร์ม</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // เพิ่ม modal ลงใน DOM
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
            
            // แสดง modal
            const modal = new bootstrap.Modal(document.getElementById('recordDetailsModal'));
            modal.show();
            
            // ลบ modal เมื่อปิด
            document.getElementById('recordDetailsModal').addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modalDiv);
            });
        }

        // สร้างบันทึกใหม่สำหรับผู้ป่วยคนนี้
        function createNewVisitForPatient() {
            if (!currentPatientRecords || currentPatientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            const patient = currentPatientRecords[0];
            
            // เติมข้อมูลผู้ป่วยลงในฟอร์ม
            document.getElementById('pname').value = patient.name || '';
            document.getElementById('hn').value = patient.hn || '';
            document.getElementById('age').value = patient.age || '';
            document.getElementById('gender').value = patient.gender || 'ชาย';
            document.getElementById('idCard').value = patient.idCard || '';
            document.getElementById('phone').value = patient.phone || '';
            document.getElementById('emergencyPhone').value = patient.emergencyPhone || '';
            document.getElementById('chronicDisease').value = patient.chronicDisease || '';
            document.getElementById('drugAllergy').value = patient.drugAllergy || '';
            document.getElementById('foodAllergy').value = patient.foodAllergy || '';
            // ที่อยู่
            document.getElementById('address').value = patient.address || '';
            document.getElementById('road').value = patient.road || '';
            document.getElementById('subdistrict').value = patient.subdistrict || '';
            document.getElementById('district').value = patient.district || '';
            document.getElementById('province').value = patient.province || '';
            document.getElementById('zipcode').value = patient.zipcode || '';
            
            // ตั้งค่าวันที่ปัจจุบัน
            const today = new Date();
            document.getElementById('visitDate').value = today.toISOString().split('T')[0];
            
            // กลับไปที่หน้าหลัก
            showMainForm();
            
            alert(`เตรียมฟอร์มสำหรับบันทึกใหม่ของ ${patient.name || 'ผู้ป่วย'} เรียบร้อยแล้ว`);
        }

        // ส่งออกรายชื่อผู้ป่วยเป็น PDF
        function exportPatientListPDF() {
            try {
                const element = document.createElement('div');
                element.innerHTML = generatePatientListPDFContent();
                
                const opt = {
                    margin: 10,
                    filename: `รายชื่อผู้ป่วย_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // ส่งออกรายงานประวัติผู้ป่วยเป็น PDF
        function exportPatientHistoryPDF() {
            if (currentPatientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generatePatientHistoryPDFContent();
                
                const patient = currentPatientRecords[0];
                const opt = {
                    margin: 10,
                    filename: `ประวัติผู้ป่วย_${patient.name || 'ผู้ป่วย'}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // ฟังก์ชันสำหรับใบเสร็จ
        function exportReceiptPDF() {
            const patientName = document.getElementById('pname').value.trim();
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบเสร็จ');
                return;
            }
            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการอย่างน้อย 1 รายการ');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateReceiptContent();
                
                const opt = {
                    margin: 10,
                    filename: `ใบเสร็จ_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        function exportHalfPagePDF() {
            const patientName = document.getElementById('pname').value.trim();
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบเสร็จ');
                return;
            }
            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการอย่างน้อย 1 รายการ');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateReceiptContentHalfPage();
                
                const opt = {
                    margin: 5,
                    filename: `ใบเสร็จ_ครึ่งหน้า_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        function exportReceiptFromRecord(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateReceiptContentFromRecord(record);
                
                const opt = {
                    margin: 10,
                    filename: `ใบเสร็จ_${record.name || 'ผู้ป่วย'}_${record.visitDate || 'ไม่มีวันที่'}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // ฟังก์ชันสำหรับใบรับรองแพทย์
        function exportMedicalCertPDF() {
            const patientName = document.getElementById('pname').value.trim();
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบรับรองแพทย์');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateMedicalCertContent();
                
                const opt = {
                    margin: 10,
                    filename: `ใบรับรองแพทย์_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        function exportMedicalCertHalfPage() {
            const patientName = document.getElementById('pname').value.trim();
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบรับรองแพทย์');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateMedicalCertContentHalfPage();
                
                const opt = {
                    margin: 5,
                    filename: `ใบรับรองแพทย์_ครึ่งหน้า_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        function exportMedicalCertFromRecord(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            try {
                const element = document.createElement('div');
                element.innerHTML = generateMedicalCertContentFromRecord(record);
                
                const opt = {
                    margin: 10,
                    filename: `ใบรับรองแพทย์_${record.name || 'ผู้ป่วย'}_${record.visitDate || 'ไม่มีวันที่'}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        function exportRecordPDF(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }

            try {
                const element = document.createElement('div');
                element.innerHTML = generatePDFContentFromRecord(record);
                
                const opt = {
                    margin: 10,
                    filename: `OPD_TCM_${record.name || 'ผู้ป่วย'}_${record.visitDate || 'ไม่มีวันที่'}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // สร้างเนื้อหาใบเสร็จ (แบบทางการ)
        function generateReceiptContent() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            selectedServices.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 3px 0; border-bottom: 0.5pt solid #ccc; font-size: 9pt;">${item.service}</td>
                        <td style="padding: 3px 0; border-bottom: 0.5pt solid #ccc; text-align: right; font-size: 9pt;">${item.price.toLocaleString('th-TH')} บาท</td>
                    </tr>
                `;
            });
            
            const subtotal = selectedServices.reduce((sum, item) => sum + item.price, 0);
            
            return `
                <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm 10mm; line-height: 1.1; color: #000000; font-size: 9pt; page-break-inside: avoid;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 3mm; padding-bottom: 1mm; border-bottom: 1pt solid #000;">
                        <h2 style="margin: 0; font-size: 18pt; font-weight: bold; color: #000;">ใบเสร็จรับเงิน</h2>
                        <h3 style="margin: 2px 0; font-size: 14pt; font-weight: bold;">${clinicInfo.name}</h3>
                        <p style="margin: 1px 0; font-size: 9pt;">
                            ${clinicInfo.addressThai}<br>
                            ${clinicInfo.addressEnglish}<br>
                            ${clinicInfo.phone} | ${clinicInfo.phoneEnglish}<br>
                            ${clinicInfo.license} | ${clinicInfo.taxId}
                        </p>
                    </div>
                    
                    <!-- ข้อมูลผู้ป่วย -->
                    <div style="margin-bottom: 4mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <tr>
                                <td style="width: 35%; padding: 2px 0;"><strong>ชื่อผู้ป่วย:</strong></td>
                                <td style="padding: 2px 0;">${document.getElementById('pname').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>วันที่รับบริการ:</strong></td>
                                <td style="padding: 2px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>เลขที่ใบเสร็จ:</strong></td>
                                <td style="padding: 2px 0; font-weight: bold;">${generateReceiptNumber()}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- ตารางบริการ -->
                    <div style="margin-bottom: 4mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr>
                                    <th style="padding: 4px 0; border-bottom: 1pt solid #000; text-align: left; font-weight: bold; width: 70%;">รายการบริการ</th>
                                    <th style="padding: 4px 0; border-bottom: 1pt solid #000; text-align: right; font-weight: bold; width: 30%;">ราคา (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- สรุปยอด -->
                    <div style="margin-bottom: 5mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                            <tr>
                                <td style="width: 70%; padding: 4px 0; text-align: right; border-top: 0.5pt solid #000;">รวมเป็นเงิน:</td>
                                <td style="padding: 4px 0; text-align: right; border-top: 0.5pt solid #000;">${subtotal.toLocaleString('th-TH')} บาท</td>
                            </tr>
                            ${discountAmount > 0 ? `
                            <tr>
                                <td style="padding: 4px 0; text-align: right;">หักส่วนลด${document.getElementById('discountReason').value ? ' (' + document.getElementById('discountReason').value + ')' : ''}:</td>
                                <td style="padding: 4px 0; text-align: right; color: #d63031;">-${discountAmount.toFixed(2)} บาท</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 6px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">รวมทั้งสิ้น:</td>
                                <td style="padding: 6px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">${totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="padding: 2px 0; text-align: left; font-size: 9pt;">
                                    <strong>หมายเหตุ:</strong> ${document.getElementById('additionalNote').value || 'ขอบคุณที่ใช้บริการ'}
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- ลายเซ็น -->
                    <div style="margin-top: 10mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <tr>
                                <td style="width: 50%; text-align: center; padding-top: 15mm;">
                                    <div style="border-top: 1pt solid #000; width: 70%; margin: 0 auto;">
                                        <p style="margin: 5px 0;">ผู้รับเงิน</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">( ${clinicInfo.nameShort} )</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">วันที่ _________________</p>
                                    </div>
                                </td>
                                <td style="width: 50%; text-align: center; padding-top: 15mm;">
                                    <div style="border-top: 1pt solid #000; width: 70%; margin: 0 auto;">
                                        <p style="margin: 5px 0;">ผู้จ่ายเงิน</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">( ลายเซ็นผู้รับบริการ )</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">วันที่ _________________</p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 8mm; padding-top: 3mm; border-top: 0.5pt solid #ccc; font-size: 8pt; color: #666; text-align: center;">
                        <p style="margin: 2px 0;">ใบเสร็จรับเงินนี้เป็นหลักฐานการชำระเงินที่สมบูรณ์</p>
                        <p style="margin: 2px 0;">กรุณาเก็บใบเสร็จนี้ไว้เพื่อประกอบการตรวจสอบหรือเคลมประกันสุขภาพ (ถ้ามี)</p>
                        <p style="margin: 2px 0;">Email: ${clinicInfo.email} | Website: ${clinicInfo.website} | Line: ${clinicInfo.lineId}</p>
                        <p style="margin: 2px 0;">ออกใบเสร็จโดยระบบอัตโนมัติ ใบเสร็จนี้พิมพ์เมื่อ: ${formattedDate}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาใบเสร็จ (ครึ่งหน้า)
        function generateReceiptContentHalfPage() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            selectedServices.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 2px 0; border-bottom: 0.5pt solid #ddd; font-size: 8pt;">${item.service}</td>
                        <td style="padding: 2px 0; border-bottom: 0.5pt solid #ddd; text-align: right; font-size: 8pt;">${item.price.toLocaleString('th-TH')}</td>
                    </tr>
                `;
            });
            
            const subtotal = selectedServices.reduce((sum, item) => sum + item.price, 0);
            
            return `
                <div class="half-page-pdf" style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 5mm 8mm; line-height: 1; color: #000000; font-size: 8pt; border: 0.5pt solid #999; max-width: 105mm;">
                    <div style="text-align: center; margin-bottom: 2mm; padding-bottom: 1mm; border-bottom: 0.5pt solid #000;">
                        <h3 style="margin: 0; font-size: 12pt; font-weight: bold;">ใบเสร็จรับเงิน</h3>
                        <p style="margin: 1px 0; font-size: 9pt; font-weight: bold;">${clinicInfo.nameShort}</p>
                        <p style="margin: 1px 0; font-size: 7pt;">
                            ${clinicInfo.addressThai}<br>
                            ${clinicInfo.phone} | ${clinicInfo.license}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 2mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                            <tr>
                                <td style="width: 30%; padding: 1px 0;"><strong>ผู้ป่วย:</strong></td>
                                <td style="padding: 1px 0;">${document.getElementById('pname').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 1px 0;"><strong>วันที่:</strong></td>
                                <td style="padding: 1px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 1px 0;"><strong>เลขที่:</strong></td>
                                <td style="padding: 1px 0; font-weight: bold;">${generateReceiptNumber()}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 2mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                            <thead>
                                <tr>
                                    <th style="padding: 2px 0; border-bottom: 0.5pt solid #000; text-align: left; width: 70%;">รายการ</th>
                                    <th style="padding: 2px 0; border-bottom: 0.5pt solid #000; text-align: right; width: 30%;">บาท</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 3mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                            <tr>
                                <td style="width: 70%; padding: 3px 0; text-align: right; border-top: 0.5pt solid #000;">รวม:</td>
                                <td style="padding: 3px 0; text-align: right; border-top: 0.5pt solid #000;">${subtotal.toLocaleString('th-TH')}</td>
                            </tr>
                            ${discountAmount > 0 ? `
                            <tr>
                                <td style="padding: 2px 0; text-align: right;">ส่วนลด:</td>
                                <td style="padding: 2px 0; text-align: right; color: #d63031;">-${discountAmount.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 4px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">สุทธิ:</td>
                                <td style="padding: 4px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">${totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 3mm; font-size: 7pt; color: #666; text-align: center; border-top: 0.5pt solid #ccc; padding-top: 2mm;">
                        <p style="margin: 1px 0;">ใบเสร็จรับเงินย่อสำหรับใช้เป็นหลักฐานการชำระเงิน</p>
                        <p style="margin: 1px 0;">${formattedDate} | ${clinicInfo.nameShort}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาใบเสร็จจากข้อมูลที่บันทึก
        function generateReceiptContentFromRecord(record) {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            record.services.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 3px 0; border-bottom: 0.5pt solid #ccc; font-size: 9pt;">${item.service}</td>
                        <td style="padding: 3px 0; border-bottom: 0.5pt solid #ccc; text-align: right; font-size: 9pt;">${item.price.toLocaleString('th-TH')} บาท</td>
                    </tr>
                `;
            });
            
            const subtotal = record.services.reduce((sum, item) => sum + item.price, 0);
            
            return `
                <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm 10mm; line-height: 1.1; color: #000000; font-size: 9pt;">
                    <div style="text-align: center; margin-bottom: 3mm; padding-bottom: 1mm; border-bottom: 1pt solid #000;">
                        <h2 style="margin: 0; font-size: 18pt; font-weight: bold; color: #000;">ใบเสร็จรับเงิน</h2>
                        <h3 style="margin: 2px 0; font-size: 14pt; font-weight: bold;">${clinicInfo.name}</h3>
                        <p style="margin: 1px 0; font-size: 9pt;">
                            ${clinicInfo.addressThai}<br>
                            ${clinicInfo.addressEnglish}<br>
                            ${clinicInfo.phone} | ${clinicInfo.phoneEnglish}<br>
                            ${clinicInfo.license} | ${clinicInfo.taxId}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 4mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <tr>
                                <td style="width: 35%; padding: 2px 0;"><strong>ชื่อผู้ป่วย:</strong></td>
                                <td style="padding: 2px 0;">${record.name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>วันที่ตรวจ:</strong></td>
                                <td style="padding: 2px 0;">${record.visitDate || '-'} ${record.visitTime || ''}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>วันที่ออกใบเสร็จ:</strong></td>
                                <td style="padding: 2px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;"><strong>เลขที่ใบเสร็จ:</strong></td>
                                <td style="padding: 2px 0; font-weight: bold;">RCP${record.id.toString().slice(-6)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 4mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr>
                                    <th style="padding: 4px 0; border-bottom: 1pt solid #000; text-align: left; font-weight: bold; width: 70%;">รายการบริการ</th>
                                    <th style="padding: 4px 0; border-bottom: 1pt solid #000; text-align: right; font-weight: bold; width: 30%;">ราคา (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 5mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                            <tr>
                                <td style="width: 70%; padding: 4px 0; text-align: right; border-top: 0.5pt solid #000;">รวมเป็นเงิน:</td>
                                <td style="padding: 4px 0; text-align: right; border-top: 0.5pt solid #000;">${subtotal.toLocaleString('th-TH')} บาท</td>
                            </tr>
                            ${record.discount > 0 ? `
                            <tr>
                                <td style="padding: 4px 0; text-align: right;">หักส่วนลด${record.discountReason ? ' (' + record.discountReason + ')' : ''}:</td>
                                <td style="padding: 4px 0; text-align: right; color: #d63031;">-${record.discount.toFixed(2)} บาท</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 6px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">รวมทั้งสิ้น:</td>
                                <td style="padding: 6px 0; text-align: right; font-weight: bold; border-top: 1pt solid #000;">${record.totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="padding: 2px 0; text-align: left; font-size: 9pt;">
                                    <strong>หมายเหตุ:</strong> ${record.additionalNote || 'ขอบคุณที่ใช้บริการ'}
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 10mm;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <tr>
                                <td style="width: 50%; text-align: center; padding-top: 15mm;">
                                    <div style="border-top: 1pt solid #000; width: 70%; margin: 0 auto;">
                                        <p style="margin: 5px 0;">ผู้รับเงิน</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">( ${clinicInfo.nameShort} )</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">วันที่ _________________</p>
                                    </div>
                                </td>
                                <td style="width: 50%; text-align: center; padding-top: 15mm;">
                                    <div style="border-top: 1pt solid #000; width: 70%; margin: 0 auto;">
                                        <p style="margin: 5px 0;">ผู้จ่ายเงิน</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">( ลายเซ็นผู้รับบริการ )</p>
                                        <p style="margin: 2px 0; font-size: 8pt;">วันที่ _________________</p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 8mm; padding-top: 3mm; border-top: 0.5pt solid #ccc; font-size: 8pt; color: #666; text-align: center;">
                        <p style="margin: 2px 0;">ใบเสร็จรับเงินนี้เป็นหลักฐานการชำระเงินที่สมบูรณ์ตามประมวลรัษฎากร</p>
                        <p style="margin: 2px 0;">กรุณาเก็บใบเสร็จนี้ไว้เพื่อประกอบการตรวจสอบหรือเคลมประกันสุขภาพ (ถ้ามี)</p>
                        <p style="margin: 2px 0;">Email: ${clinicInfo.email} | Website: ${clinicInfo.website} | Line: ${clinicInfo.lineId}</p>
                        <p style="margin: 2px 0;">ออกใบเสร็จโดยระบบอัตโนมัติ ใบเสร็จนี้พิมพ์เมื่อ: ${formattedDate}</p>
                    </div>
                </div>
            `;
        }

      // สร้างเนื้อหาใบรับรองแพทย์ (เต็มหน้า)
function generateMedicalCertContent() {
    const patientName = document.getElementById('pname').value.trim();
    const age = document.getElementById('age').value;
    const gender = document.getElementById('gender').value;
    const visitDate = document.getElementById('visitDate').value;
    const tcmDiag = document.getElementById('tcmDiag').value;
    const plan = document.getElementById('plan').value;
    const treatmentDays = document.getElementById('treatmentDays').value || 7;
    
    const today = new Date();
    const formattedDate = today.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // แปลงวันที่นัดหมายถัดไป (ถ้ามี)
    const appointDate = document.getElementById('appointDate').value;
    let followupDate = '';
    if (appointDate) {
        const dateObj = new Date(appointDate);
        followupDate = dateObj.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    // กำหนดค่าเริ่มต้นถ้าช่องว่าง
    const displayVisitDate = visitDate ? new Date(visitDate).toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    }) : formattedDate;
    
    return `
        <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 6mm 10mm; line-height: 1.2; color: #000000; font-size: 14pt; min-height: 297mm; box-sizing: border-box;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 8mm; padding-bottom: 2mm; border-bottom: 1pt solid #000;">
                <h1 style="margin: 0; font-size: 22pt; font-weight: bold; color: #000;">ใบรับรองแพทย์</h1>
                <h2 style="margin: 2mm 0; font-size: 18pt; font-weight: bold;">${clinicInfo.name}</h2>
                <p style="margin: 1mm 0; font-size: 12pt;">
                    ${clinicInfo.addressThai}<br>
                    ${clinicInfo.phone} | ${clinicInfo.license}
                </p>
            </div>
            
            <!-- เนื้อหาใบรับรอง -->
            <div style="margin: 6mm 0; text-align: justify;">
                <p style="margin: 4mm 0; text-indent: 15mm;">
                    ข้าพเจ้า <strong>แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย</strong> แพทย์ประจำ ซินไท คลินิกแพทย์แผนจีน
                    ขอรับรองว่า
                </p>
                
                <div style="margin: 5mm 0; padding-left: 20mm;">
                    <p style="margin: 3mm 0;">
                        <strong>ชื่อ-สกุล:</strong> ${patientName || '...................................'}
                    </p>
                    <p style="margin: 3mm 0;">
                        <strong>อายุ:</strong> ${age || '........'} ปี &nbsp;&nbsp;&nbsp;&nbsp;
                        <strong>เพศ:</strong> ${gender || '........'}
                    </p>
                    <p style="margin: 3mm 0;">
                        <strong>วันที่เข้ารับการตรวจ:</strong> ${displayVisitDate}
                    </p>
                </div>
                
                <p style="margin: 4mm 0; text-indent: 15mm;">
                    ได้รับการตรวจวินิจฉัยและให้การรักษาด้วยศาสตร์การแพทย์แผนจีน
                    ${tcmDiag ? `โดยมีภาวะ <strong>"${tcmDiag}"</strong> ตามหลักการแพทย์แผนจีน` : ''}
                </p>
                
                <div style="margin: 5mm 0; padding: 3mm; background-color: #f9f9f9; border-left: 3px solid #6c5ce7; border-radius: 2px;">
                    <p style="margin: 2mm 0; font-weight: bold;">การรักษาที่ได้รับ:</p>
                    <p style="margin: 2mm 0; padding-left: 10mm;">${plan || 'การรักษาตามแผนการแพทย์แผนจีนตามสภาพอาการของผู้ป่วย'}</p>
                    ${treatmentDays ? `<p style="margin: 2mm 0; padding-left: 10mm;">ระยะเวลาในการรักษา: ${treatmentDays} วัน</p>` : ''}
                </div>
                
                ${followupDate ? `
                <p style="margin: 4mm 0; text-indent: 15mm;">
                    มีนัดติดตามอาการในครั้งถัดไปวันที่ <strong>${followupDate}</strong>
                    ณ ซินไท คลินิกแพทย์แผนจีน
                </p>
                ` : ''}
                
                <p style="margin: 4mm 0; text-indent: 15mm;">
                    จึงได้ออกใบรับรองแพทย์นี้ไว้เพื่อเป็นหลักฐานแก่ผู้ป่วยตามความประสงค์
                </p>
            </div>
            
            <!-- ลายเซ็น -->
            <div style="margin-top: 20mm; position: relative;">
                <div style="text-align: center;">
                    <div style="display: inline-block; text-align: center;">
                        <p style="margin: 15mm 0 3mm 0;">ลงชื่อ.............................................................</p>
                        <p style="margin: 1mm 0; font-weight: bold;">(แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย)</p>
                        <p style="margin: 1mm 0;">แพทย์ประจำ ซินไท คลินิกแพทย์แผนจีน</p>
                        <p style="margin: 1mm 0;">วันที่ ${formattedDate}</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="margin-top: 10mm; padding-top: 3mm; border-top: 0.5px solid #ccc; font-size: 10pt; color: #666; text-align: center; position: relative;">
                <p style="margin: 1mm 0;">${clinicInfo.addressThai} | ${clinicInfo.phone}</p>
                <p style="margin: 1mm 0;">ใบรับรองแพทย์ฉบับนี้ใช้เพื่อวัตถุประสงค์ทางการแพทย์เท่านั้น</p>
            </div>
        </div>
    `;
}

        // สร้างเนื้อหาใบรับรองแพทย์ (ครึ่งหน้า - แบบกระชับ)
        function generateMedicalCertContentHalfPage() {
            const patientName = document.getElementById('pname').value.trim();
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const visitDate = document.getElementById('visitDate').value;
            const tcmDiag = document.getElementById('tcmDiag').value;
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            return `
                <div class="half-page-pdf" style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm; line-height: 1.3; color: #000000; font-size: 12pt; border: 1px solid #999;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 5mm;">
                        <h2 style="margin: 0; font-size: 16pt; font-weight: bold;">ใบรับรองแพทย์</h2>
                        <h3 style="margin: 2px 0; font-size: 14pt;">${clinicInfo.nameShort}</h3>
                    </div>
                    
                    <!-- เนื้อหา -->
                    <div style="margin: 3mm 0;">
                        <p style="margin: 2mm 0; text-align: justify;">
                            ข้าพเจ้า <strong>แพทย์แผนจีน ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย</strong>
                            ขอรับรองว่า
                        </p>
                        
                        <div style="margin: 3mm 0; padding-left: 5mm;">
                            <p style="margin: 1.5mm 0;"><strong>ชื่อ:</strong> ${patientName || '....................'}</p>
                            <p style="margin: 1.5mm 0;">
                                <strong>อายุ:</strong> ${age || '..'} ปี &nbsp;&nbsp;
                                <strong>เพศ:</strong> ${gender || '..'}
                            </p>
                            <p style="margin: 1.5mm 0;">
                                <strong>วันที่ตรวจ:</strong> ${visitDate ? new Date(visitDate).toLocaleDateString('th-TH') : formattedDate}
                            </p>
                        </div>
                        
                        <p style="margin: 2mm 0; text-align: justify;">
                            ได้รับการตรวจรักษาทางการแพทย์แผนจีน
                            ${tcmDiag ? `ด้วยภาวะ "${tcmDiag}"` : 'ตามอาการที่มี'} 
                            และให้คำแนะนำในการดูแลสุขภาพตามหลักการแพทย์แผนจีน
                        </p>
                        
                        <p style="margin: 2mm 0; text-align: justify;">
                            ออกใบรับรองนี้ไว้เพื่อเป็นหลักฐานตามความประสงค์
                        </p>
                    </div>
                    
                    <!-- ลายเซ็น -->
                    <div style="margin-top: 8mm;">
                        <div style="text-align: center;">
                            <p style="margin: 8mm 0 1mm 0;">
                                ลงชื่อ...........................................................
                            </p>
                            <p style="margin: 0; font-size: 10pt;">
                                (แพทย์แผนจีน ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย)
                            </p>
                            <p style="margin: 1mm 0; font-size: 9pt;">
                                วันที่ ${formattedDate}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 3mm; padding-top: 2mm; border-top: 0.5pt solid #ccc; font-size: 8pt; text-align: center; color: #666;">
                        <p style="margin: 1px 0;">${clinicInfo.addressThai}</p>
                        <p style="margin: 1px 0;">${clinicInfo.phone}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาใบรับรองแพทย์จากข้อมูลที่บันทึก
        function generateMedicalCertContentFromRecord(record) {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const visitDate = record.visitDate ? 
                new Date(record.visitDate).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : formattedDate;
            
            return `
                <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 15mm; line-height: 1.5; color: #000000; font-size: 16pt;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 28pt; font-weight: bold; color: #000;">ใบรับรองแพทย์</h1>
                        <h2 style="margin: 10px 0; font-size: 22pt; font-weight: bold;">ซินไท คลินิกแพทย์แผนจีน</h2>
                        <p style="margin: 5px 0; font-size: 14pt;">
                            644/3 หมู่ 10 ตำบลโคกกรวด อำเภอเมือง จังหวัดนครราชสีมา 30280<br>
                            โทรศัพท์: 080-662-4224 | ใบอนุญาตสถานพยาบาลเลขที่ 30109000365
                        </p>
                    </div>
                    
                    <!-- เนื้อหาใบรับรอง -->
                    <div style="margin: 30px 0; text-align: justify;">
                        <p style="margin: 20px 0;">
                            ข้าพเจ้า <strong>แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย</strong> 
                            แพทย์ประจำคลินิกการแพทย์แผนจีนซินไท
                            ขอรับรองว่า
                        </p>
                        
                        <div style="margin: 25px 0; padding-left: 40px;">
                            <p style="margin: 15px 0;">
                                <strong>ชื่อ-สกุล:</strong> ${record.name || '...................................'}
                            </p>
                            <p style="margin: 15px 0;">
                                <strong>อายุ:</strong> ${record.age || '........'} ปี &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <strong>เพศ:</strong> ${record.gender || '........'}
                            </p>
                            <p style="margin: 15px 0;">
                                <strong>วันที่เข้ารับการตรวจ:</strong> ${visitDate}
                            </p>
                            <p style="margin: 15px 0;">
                                <strong>เลขประจำตัวผู้ป่วย (HN):</strong> ${record.hn || 'ไม่ระบุ'}
                            </p>
                        </div>
                        
                        <p style="margin: 20px 0;">
                            ได้รับการตรวจวินิจฉัยและให้การรักษาด้วยศาสตร์การแพทย์แผนจีน
                            ${record.tcmDiag ? `โดยมีภาวะ <strong>"${record.tcmDiag}"</strong> ตามหลักการแพทย์แผนจีน` : ''}
                            ${record.westDiag ? `(วินิจฉัยทางการแพทย์สากล: ${record.westDiag})` : ''}
                        </p>
                        
                        <div style="margin: 25px 0; padding: 15px; background-color: #f9f9f9; border-left: 5px solid #6c5ce7;">
                            <p style="margin: 10px 0; font-weight: bold;">การรักษาที่ได้รับ:</p>
                            <p style="margin: 10px 0; padding-left: 20px;">${record.plan || 'การรักษาตามแผนการแพทย์แผนจีนตามสภาพอาการของผู้ป่วย'}</p>
                            ${record.herbRecommendation ? `<p style="margin: 10px 0; padding-left: 20px;">คำแนะนำเรื่องยาสมุนไพร: ${record.herbRecommendation}</p>` : ''}
                            ${record.treatmentDays ? `<p style="margin: 10px 0; padding-left: 20px;">ระยะเวลาในการรักษาที่แนะนำ: ${record.treatmentDays} วัน</p>` : ''}
                        </div>
                        
                        <p style="margin: 20px 0;">
                            จึงได้ออกใบรับรองแพทย์นี้ไว้เพื่อเป็นหลักฐานแก่ผู้ป่วยตามความประสงค์
                        </p>
                    </div>
                    
                    <!-- ลายเซ็น -->
                    <div style="margin-top: 60px;">
                        <div style="text-align: center;">
                            <div style="display: inline-block; text-align: center; margin: 0 40px;">
                                <p style="margin: 50px 0 10px 0;">ลงชื่อ.............................................................</p>
                                <p style="margin: 5px 0; font-weight: bold;">(แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย)</p>
                                <p style="margin: 5px 0;">แพทย์ประจำ ซินไท คลินิกการแพทย์แผนจีน</p>
                                <p style="margin: 5px 0;">วันที่ ${formattedDate}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ตราประทับ (จำลอง) -->
                    <div style="position: absolute; right: 30mm; bottom: 30mm; text-align: center;">
                        <div style="width: 60mm; height: 60mm; border: 2px solid red; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <div style="text-align: center;">
                                <div style="font-weight: bold; font-size: 12pt;">ตราประทับ</div>
                                <div style="font-size: 10pt;">คลินิกการแพทย์แผนจีน</div>
                                <div style="font-size: 10pt;">ซินไท</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 80px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12pt; color: #666; text-align: center;">
                        <p style="margin: 5px 0;">644/3 หมู่ 10 ตำบลโคกกรวด อำเภอเมือง จังหวัดนครราชสีมา 30280 | โทร. 080-662-4224</p>
                        <p style="margin: 5px 0;">ใบรับรองแพทย์ฉบับนี้ใช้เพื่อวัตถุประสงค์ทางการแพทย์เท่านั้น</p>
                    </div>
                </div>
            `;
        }

        function exportOPDToPDF() {
            const patientName = document.getElementById('pname').value.trim();
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนส่งออก PDF');
                return;
            }
            
            try {
                const tongueImage = document.getElementById('tongue-image-data').value;
                const faceImage = document.getElementById('face-image-data').value;
                const tongue = getSelectedTongue().join(', ');
                const pulseTCM = getSelectedPulse().join(', ');
                const hn = document.getElementById('hn').value.trim();
                
                // รวบรวมที่อยู่แบบกระชับ
                const addressParts = [
                    document.getElementById('address').value,
                    document.getElementById('road').value,
                    document.getElementById('subdistrict').value,
                    document.getElementById('district').value,
                    document.getElementById('province').value
                ].filter(part => part.trim() !== '');
                const fullAddress = addressParts.join(' ');
                
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm 10mm; line-height: 1.1; color: #000000; font-size: 9pt;">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 3mm; padding-bottom: 1mm; border-bottom: 1pt solid #000;">
                            <h1 style="margin: 0; font-size: 12pt; font-weight: bold;">บันทึกการตรวจ OPD แพทย์แผนจีน</h1>
                            <p style="margin: 0.5mm 0; font-size: 8.5pt;"> ซินไท คลินิกแพทย์แผนจีน</p>
                            <p style="margin: 0; font-size: 8pt; color: #666;">เอกสารบันทึกเวชระเบียนทางการแพทย์</p>
                        </div>
                        
                        <!-- Patient Information - Compact Table -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 4mm; font-size: 9pt;">
                            <tr>
                                <td colspan="4" style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                    <strong>ข้อมูลผู้ป่วย | Patient Information</strong>
                                </td>
                                <td rowspan="5" style="width: 25%; text-align: center; vertical-align: top; padding-top: 2mm;">
                                    ${faceImage ? `
                                        <div style="display: inline-block; border: 0.5pt solid #000000; padding: 0.5mm;">
                                            <img src="${faceImage}" style="width: 22mm; height: 25mm; object-fit: cover; display: block;">
                                            <p style="margin: 0.5mm 0 0 0; text-align: center; font-size: 8pt;">รูปหน้าผู้ป่วย</p>
                                        </div>
                                    ` : `
                                        <div style="display: inline-block; border: 0.5pt solid #000000; width: 22mm; height: 26mm; padding: 0.5mm; text-align: center;">
                                            <div style="height: 25mm; display: flex; align-items: center; justify-content: center; border: 0.5pt dashed #999;">
                                                <span style="font-size: 8pt; color: #666;">ไม่มีรูป</span>
                                            </div>
                                            <p style="margin: 0.5mm 0 0 0; text-align: center; font-size: 8pt;">รูปหน้าผู้ป่วย</p>
                                        </div>
                                    `}
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 12%; padding: 0.8mm 0;"><strong>HN:</strong></td>
                                <td style="width: 23%; padding: 0.8mm 0;">${hn || '-'}</td>
                                <td style="width: 12%; padding: 0.8mm 0;"><strong>อายุ/เพศ:</strong></td>
                                <td style="width: 23%; padding: 0.8mm 0;">${document.getElementById('age').value || '-'} / ${document.getElementById('gender').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;"><strong>ชื่อ-สกุล:</strong></td>
                                <td colspan="3" style="padding: 0.8mm 0;">${document.getElementById('pname').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;"><strong>เลขบัตร:</strong></td>
                                <td style="padding: 0.8mm 0;">${document.getElementById('idCard').value || '-'}</td>
                                <td style="padding: 0.8mm 0;"><strong>โทร:</strong></td>
                                <td style="padding: 0.8mm 0;">${document.getElementById('phone').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;"><strong>ที่อยู่:</strong></td>
                                <td colspan="3" style="padding: 0.8mm 0; font-size: 8.5pt;">
                                    ${fullAddress || '-'} ${document.getElementById('zipcode').value ? 'รหัส ' + document.getElementById('zipcode').value : ''}
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Visit & Vital Signs - Combined Compact Table -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 4mm; font-size: 9pt;">
                            <tr>
                                <td style="width: 50%; vertical-align: top; padding-right: 2mm;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr>
                                            <td colspan="2" style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                                <strong>ข้อมูลการตรวจ | Visit Info</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width: 40%; padding: 0.8mm 0;"><strong>วันที่ตรวจ:</strong></td>
                                            <td style="padding: 0.8mm 0;">${document.getElementById('visitDate').value || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.8mm 0;"><strong>เวลา:</strong></td>
                                            <td style="padding: 0.8mm 0;">${document.getElementById('visitTime').value || '-'}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 50%; vertical-align: top; padding-left: 2mm;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr>
                                            <td colspan="5" style="padding: 1mm 0; border-bottom: 0.5pt solid #000000; text-align: center;">
                                                <strong>สัญญาณชีพ | Vital Signs</strong>
                                            </td>
                                        </tr>
                                        <tr style="text-align: center; font-size: 8.5pt;">
                                            <td style="padding: 0.6mm 0; border: 0.5pt solid #000000;"><strong>BP</strong><br>${document.getElementById('bloodPressure').value || '-'}</td>
                                            <td style="padding: 0.6mm 0; border: 0.5pt solid #000000;"><strong>ชีพจร</strong><br>${document.getElementById('pulse').value || '-'}</td>
                                            <td style="padding: 0.6mm 0; border: 0.5pt solid #000000;"><strong>SpO₂</strong><br>${document.getElementById('spo2').value || '-'}</td>
                                            <td style="padding: 0.6mm 0; border: 0.5pt solid #000000;"><strong>อุณหภูมิ</strong><br>${document.getElementById('temperature').value || '-'}</td>
                                            <td style="padding: 0.6mm 0; border: 0.5pt solid #000000;"><strong>น้ำหนัก</strong><br>${document.getElementById('weight').value || '-'}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                        
                        <!-- TCM Examination - Compact -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 3mm; font-size: 9pt;">
                            <tr>
                                <td colspan="2" style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                    <strong>การตรวจร่างกายแพทย์แผนจีน | TCM Examination</strong>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 18%; padding: 0.8mm 0; vertical-align: top;"><strong>อาการสำคัญ:</strong></td>
                                <td style="padding: 0.8mm 0; vertical-align: top; font-size: 8.5pt;">${document.getElementById('symptom').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0; vertical-align: top;"><strong>ประวัติ:</strong></td>
                                <td style="padding: 0.8mm 0; vertical-align: top; font-size: 8.5pt;">${document.getElementById('history').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;"><strong>ลักษณะลิ้น:</strong></td>
                                <td style="padding: 0.8mm 0; font-size: 8.5pt;">${tongue || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;"><strong>ชีพจร TCM:</strong></td>
                                <td style="padding: 0.8mm 0; font-size: 8.5pt;">${pulseTCM || '-'}</td>
                            </tr>
                        </table>
                        
                        <!-- Tongue Image if exists -->
                        ${tongueImage ? `
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 3mm; font-size: 9pt;">
                            <tr>
                                <td style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                    <strong>รูปภาพประกอบการตรวจ</strong>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0; text-align: center;">
                                    <div style="display: inline-block; border: 0.5pt solid #000000; padding: 1mm;">
                                        <img src="${tongueImage}" style="width: 35mm; height: 20mm; object-fit: cover; display: block;">
                                        <p style="margin: 0.5mm 0 0 0; text-align: center; font-size: 8pt;">รูปลิ้นผู้ป่วย</p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        ` : ''}
                        
                        <!-- Diagnosis - Compact -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 3mm; font-size: 9pt;">
                            <tr>
                                <td colspan="2" style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                    <strong>การวินิจฉัย | Diagnosis</strong>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50%; padding: 0.8mm 0; vertical-align: top; border-right: 0.5pt solid #000000; padding-right: 2mm;">
                                    <strong>แพทย์แผนจีน:</strong><br>
                                    <span style="font-size: 8.5pt;">${document.getElementById('tcmDiag').value || 'ไม่ระบุ'}</span>
                                </td>
                                <td style="width: 50%; padding: 0.8mm 0; vertical-align: top; padding-left: 2mm;">
                                    <strong>วินิจฉัยสากล:</strong><br>
                                    <span style="font-size: 8.5pt;">${document.getElementById('westDiag').value || 'ไม่ระบุ'}</span>
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Treatment Plan - Compact -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 5mm; font-size: 9pt;">
                            <tr>
                                <td style="padding: 1mm 0; border-bottom: 0.5pt solid #000000;">
                                    <strong>แผนการรักษา | Treatment Plan</strong>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;">
                                    <strong>แผนการรักษา:</strong> <span style="font-size: 8.5pt;">${document.getElementById('plan').value || '-'}</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;">
                                    <strong>ยาสมุนไพร:</strong> <span style="font-size: 8.5pt;">${document.getElementById('herbRecommendation').value || '-'}</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0.8mm 0;">
                                    <strong>จำนวนวันรักษา:</strong> ${document.getElementById('treatmentDays').value || 0} วัน
                                    ${document.getElementById('additionalNote').value ? ' | <strong>หมายเหตุ:</strong> ' + document.getElementById('additionalNote').value : ''}
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Signature and Footer - Compact -->
                        <div style="margin-top: 3mm;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                <tr>
                                    <td style="width: 60%; vertical-align: bottom;">
                                        <div style="text-align: center;">
                                            <div style="border-bottom: 0.5pt solid #000000; width: 50mm; height: 8mm; margin: 0 auto 1mm auto;">
                                            </div>
                                            <p style="margin: 0; font-size: 8.5pt;">ลายเซ็นแพทย์ผู้ตรวจ</p>
                                            <p style="margin: 0.5mm 0; font-size: 9pt; font-weight: bold;">
                                                แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย
                                            </p>
                                        </div>
                                    </td>
                                    <td style="width: 40%; vertical-align: bottom;">
                                        <div style="text-align: center;">
                                            <p style="margin: 0;"><strong>วันที่</strong></p>
                                            <div style="border-bottom: 0.5pt solid #000000; width: 35mm; margin: 1mm auto; padding-bottom: 1mm;">
                                                ${new Date().toLocaleDateString('th-TH', { 
                                                    year: 'numeric', 
                                                    month: 'short', 
                                                    day: 'numeric' 
                                                })}
                                            </div>
                                            <p style="margin: 0; font-size: 8pt;">(วัน/เดือน/ปี)</p>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Document Footer -->
                            <div style="margin-top: 2mm; padding-top: 1mm; border-top: 0.5pt solid #000000; text-align: center;">
                                <p style="margin: 0; font-size: 7pt; color: #333;">
                                    เอกสารนี้เป็นส่วนหนึ่งของเวชระเบียนทางการแพทย์ ห้ามทำซ้ำหรือเผยแพร่โดยไม่ได้รับอนุญาต
                                </p>
                                <p style="margin: 0.5mm 0 0 0; font-size: 6.5pt; color: #666;">
                                    TCM OPD Record | Generated: ${new Date().toLocaleString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                const opt = {
                    margin: [15, 15, 15, 15],
                    filename: `OPD_TCM_${patientName.replace(/\s+/g, '_')}_${hn || 'NO_HN'}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { 
                        type: 'jpeg', 
                        quality: 0.95,
                        compression: 'MEDIUM'
                    },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false,
                        logging: false,
                        letterRendering: true,
                        width: 794,
                        height: 1123,
                        backgroundColor: '#FFFFFF'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true,
                        hotfixes: ["px_scaling"]
                    }
                };
                
                html2pdf().set(opt).from(element).save();
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // สร้างเนื้อหา PDF จากข้อมูลที่บันทึก
        function generatePDFContentFromRecord(record) {
            const tongue = Array.isArray(record.tongue) ? record.tongue.join(', ') : record.tongue;
            const pulseTCM = Array.isArray(record.pulseTCM) ? record.pulseTCM.join(', ') : record.pulseTCM;
            const servicesList = record.services ? record.services.map(s => `${s.service} (${s.price} บาท)`).join(', ') : 'ไม่มีข้อมูล';
            
            // รวบรวมที่อยู่แบบกระชับ
            const addressParts = [
                record.address,
                record.road,
                `${record.subdistrict || ''} ${record.district || ''}`.trim(),
                record.province
            ].filter(part => part && part.trim() !== '');
            const fullAddress = addressParts.join(' ');
            
            // ตรวจสอบว่ามีรูปหน้าผู้ป่วยหรือไม่
            const hasFaceImage = record.faceImage && record.faceImage.trim() !== '';
            const hasTongueImage = record.tongueImage && record.tongueImage.trim() !== '';
            
            return `
                <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm 10mm; line-height: 1.1; color: #000000; font-size: 9pt;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 3mm; padding-bottom: 1mm; border-bottom: 1pt solid #000;">
                        <h1 style="margin: 0; font-size: 12pt; font-weight: bold;">บันทึกการตรวจ OPD แพทย์แผนจีน</h1>
                        <p style="margin: 0.5mm 0; font-size: 8.5pt;"> ซินไท คลินิกแพทย์แผนจีน</p>
                        <p style="margin: 0; font-size: 8pt; color: #666;">เอกสารบันทึกเวชระเบียนทางการแพทย์</p>
                    </div>
                    
                    <!-- Compact Patient Information with Photo -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; border: 0.5pt solid #000;">
                        <tr>
                            <td colspan="2" style="padding: 1mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9.5pt;">ข้อมูลผู้ป่วย</strong>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 70%; padding: 0.8mm; vertical-align: top;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <tr>
                                        <td style="width: 18%; padding: 0.6mm 0.5mm;"><strong>HN:</strong></td>
                                        <td style="width: 32%; padding: 0.6mm 0.5mm; border-right: 0.5pt solid #ccc;">${record.hn || '-'}</td>
                                        <td style="width: 18%; padding: 0.6mm 0.5mm;"><strong>อายุ/เพศ:</strong></td>
                                        <td style="width: 32%; padding: 0.6mm 0.5mm;">${record.age || '-'}/${record.gender || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>ชื่อ-สกุล:</strong></td>
                                        <td colspan="3" style="padding: 0.6mm 0.5mm;">${record.name || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>เลขบัตร:</strong></td>
                                        <td style="padding: 0.6mm 0.5mm; border-right: 0.5pt solid #ccc;">${record.idCard || '-'}</td>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>โทร:</strong></td>
                                        <td style="padding: 0.6mm 0.5mm;">${record.phone || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm; vertical-align: top;"><strong>ที่อยู่:</strong></td>
                                        <td colspan="3" style="padding: 0.6mm 0.5mm; font-size: 8.5pt;">
                                            ${fullAddress || '-'} ${record.zipcode ? ' ' + record.zipcode : ''}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 30%; padding: 0.8mm; border-left: 0.5pt solid #000; text-align: center; vertical-align: top;">
                                <strong style="font-size: 8.5pt;">รูปหน้าผู้ป่วย</strong>
                                <div style="margin: 1mm auto;">
                                    ${hasFaceImage ? `
                                        <img src="${record.faceImage}" 
                                             style="width: 25mm; height: 30mm; object-fit: cover; border: 0.5pt solid #ccc;"
                                             onerror="this.style.display='none';">
                                    ` : `
                                        <div style="width: 25mm; height: 30mm; border: 0.5pt dashed #999; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                            <span style="font-size: 8pt; color: #666;">ไม่มีรูปภาพ</span>
                                        </div>
                                    `}
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visit and Vital Signs - Compact -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; font-size: 9pt;">
                        <tr>
                            <td style="width: 50%; vertical-align: top; padding-right: 1mm;">
                                <table style="width: 100%; border-collapse: collapse; border: 0.5pt solid #000;">
                                    <tr>
                                        <td style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                            <strong>ข้อมูลการตรวจ</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.8mm;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <tr>
                                                    <td style="width: 35%; padding: 0.5mm;"><strong>วันที่:</strong></td>
                                                    <td style="padding: 0.5mm; font-size: 8.5pt;">${record.visitDate || record.savedAt || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.5mm;"><strong>เวลา:</strong></td>
                                                    <td style="padding: 0.5mm; font-size: 8.5pt;">${record.visitTime || '-'}</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 50%; vertical-align: top; padding-left: 1mm;">
                                <table style="width: 100%; border-collapse: collapse; border: 0.5pt solid #000;">
                                    <tr>
                                        <td colspan="5" style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000; text-align: center;">
                                            <strong>สัญญาณชีพ</strong>
                                        </td>
                                    </tr>
                                    <tr style="text-align: center; font-size: 8.5pt;">
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>BP</strong></div>
                                            <div>${record.bloodPressure || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>ชีพจร</strong></div>
                                            <div>${record.pulse || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>SpO₂</strong></div>
                                            <div>${record.spo2 || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>อุณหภูมิ</strong></div>
                                            <div>${record.temperature || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm;">
                                            <div><strong>น้ำหนัก</strong></div>
                                            <div>${record.weight || '-'} กก.</div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- TCM Examination - Ultra Compact -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; border: 0.5pt solid #000; font-size: 9pt;">
                        <tr>
                            <td colspan="4" style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong>การตรวจร่างกายแพทย์แผนจีน</strong>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 15%; padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>อาการสำคัญ:</strong></td>
                            <td style="width: 35%; padding: 0.6mm; border-right: 0.5pt solid #ccc; font-size: 8.5pt;">${record.symptom || '-'}</td>
                            <td style="width: 15%; padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ลักษณะลิ้น:</strong></td>
                            <td style="width: 35%; padding: 0.6mm; font-size: 8.5pt;">${tongue || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ประวัติ:</strong></td>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; font-size: 8.5pt;">${record.history || '-'}</td>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ชีพจร TCM:</strong></td>
                            <td style="padding: 0.6mm; font-size: 8.5pt;">${pulseTCM || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- Diagnosis and Treatment - Side by Side -->
                    <div style="display: flex; gap: 1.5mm; margin-bottom: 2mm;">
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">การวินิจฉัย</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.8mm;">
                                    <strong style="color: #d32f2f; font-size: 8.5pt;">แพทย์แผนจีน:</strong>
                                    <div style="font-size: 8.5pt; margin-top: 0.2mm;">${record.tcmDiag || 'ไม่ระบุ'}</div>
                                </div>
                                <div>
                                    <strong style="color: #1976d2; font-size: 8.5pt;">วินิจฉัยสากล:</strong>
                                    <div style="font-size: 8.5pt; margin-top: 0.2mm;">${record.westDiag || 'ไม่ระบุ'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">แผนการรักษา</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>แผน:</strong> ${record.plan || '-'}
                                </div>
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>ยาสมุนไพร:</strong> ${record.herbRecommendation || '-'}
                                </div>
                                <div style="font-size: 8.5pt;">
                                    <strong>จำนวนวัน:</strong> ${record.treatmentDays || 0} วัน
                                    ${record.additionalNote ? `<br><strong>หมายเหตุ:</strong> ${record.additionalNote}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Services and Tongue Image - Compact -->
                    <div style="display: flex; gap: 1.5mm; margin-bottom: 2mm;">
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">บริการและค่าใช้จ่าย</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>บริการ:</strong> ${servicesList || '-'}
                                </div>
                                ${record.discount > 0 ? `
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>ส่วนลด:</strong> ${record.discount.toFixed(2)} บาท
                                    ${record.discountReason ? `(${record.discountReason})` : ''}
                                </div>
                                ` : ''}
                                <div style="padding: 0.6mm; background-color: #e8f5e8; border: 0.3pt solid #4caf50;">
                                    <strong style="color: #1b5e20; font-size: 9pt;">รวม: ${record.totalCost ? record.totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0'} บาท</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000; text-align: center;">
                                <strong style="font-size: 9pt;">รูปภาพประกอบ</strong>
                            </div>
                            <div style="padding: 0.8mm; text-align: center;">
                                ${hasTongueImage ? `
                                    <img src="${record.tongueImage}" 
                                         style="width: 40mm; height: 25mm; object-fit: cover; border: 0.5pt solid #ccc;"
                                         onerror="this.style.display='none';">
                                    <div style="margin-top: 0.5mm; font-size: 8pt; color: #666;">รูปลิ้นผู้ป่วย</div>
                                ` : `
                                    <div style="width: 40mm; height: 25mm; border: 0.5pt dashed #999; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                        <span style="font-size: 8pt; color: #666;">ไม่มีรูปภาพลิ้น</span>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compact Signatures -->
                    <div style="margin-top: 2mm; padding: 1mm; border: 0.5pt solid #000;">
                        <table style="width: 100%; font-size: 8.5pt;">
                            <tr>
                                <td style="width: 50%; text-align: center; padding: 1mm;">
                                    <div style="border-bottom: 0.5pt solid #000; width: 60mm; margin: 0 auto 1.5mm auto; padding-bottom: 1.5mm;"></div>
                                    <p style="margin: 0; font-weight: bold;">ลายเซ็นแพทย์ผู้ตรวจ</p>
                                    <p style="margin: 0.5mm 0 0 0; font-size: 8.5pt;">
                                        แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย
                                    </p>
                                </td>
                                <td style="width: 50%; text-align: center; padding: 1mm; border-left: 0.5pt solid #ccc;">
                                    <div style="border-bottom: 0.5pt solid #000; width: 60mm; margin: 0 auto 1.5mm auto; padding-bottom: 1.5mm;"></div>
                                    <p style="margin: 0; font-weight: bold;">ลายเซ็นผู้ป่วย/ผู้ปกครอง</p>
                                    <p style="margin: 0.5mm 0 0 0; font-size: 8.5pt;">
                                        วันที่: ${new Date().toLocaleDateString('th-TH')}
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Minimal Footer -->
                    <div style="margin-top: 1mm; text-align: center;">
                        <p style="margin: 0; font-size: 7pt; color: #666;">
                            เอกสารนี้เป็นส่วนหนึ่งของเวชระเบียนทางการแพทย์ | TCM OPD Record
                        </p>
                    </div>
                </div>
            `;
        }

        // ค้นหาประวัติ
        function searchRecords() {
            const query = document.getElementById('searchBox').value.toLowerCase().trim();
            const idCardQuery = document.getElementById('searchIdCard').value.trim();
            const container = document.getElementById('searchResults');
            
            if (!query && !idCardQuery) {
                container.innerHTML = '<div class="text-muted text-center p-2">พิมพ์คำค้นหาเพื่อค้นหาประวัติ</div>';
                return;
            }
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            let results = records;
            
            if (query) {
                results = results.filter(record => {
                    return (
                        (record.name && record.name.toLowerCase().includes(query)) ||
                        (record.hn && record.hn.toLowerCase().includes(query)) ||
                        (record.symptom && record.symptom.toLowerCase().includes(query)) ||
                        (record.tcmDiag && record.tcmDiag.toLowerCase().includes(query)) ||
                        (record.westDiag && record.westDiag.toLowerCase().includes(query)) ||
                        (record.plan && record.plan.toLowerCase().includes(query))
                    );
                });
            }
            
            if (idCardQuery) {
                results = results.filter(record => 
                    record.idCard && record.idCard.includes(idCardQuery)
                );
            }
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-muted text-center p-3">ไม่พบผลลัพธ์ที่ตรงกัน</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            results.slice(0, 5).forEach(record => {
                const hasTongueImage = record.tongueImage ? '<i class="bi bi-image text-success me-1" title="มีรูปลิ้น"></i>' : '';
                const hasFaceImage = record.faceImage ? '<i class="bi bi-person-bounding-box text-success me-1" title="มีรูปหน้า"></i>' : '';
                const hnInfo = record.hn ? `<span class="badge bg-info me-1">HN: ${record.hn}</span>` : '';
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${record.name} ${hnInfo}${hasTongueImage}${hasFaceImage}</h6>
                            <small class="text-muted">${record.savedAt}</small>
                        </div>
                        <p class="mb-1">
                            <small>อายุ ${record.age} ปี, ${record.gender}</small><br>
                            <small>บริการ: ${record.services ? record.services.map(s => s.service).join(', ') : 'ไม่มีข้อมูล'}</small><br>
                            <small>รวม: ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</small>
                        </p>
                        <div class="d-flex justify-content-end gap-1 mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecord(${record.id})">
                                <i class="bi bi-eye"></i> โหลด
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportReceiptFromRecord(${record.id})">
                                <i class="bi bi-receipt"></i> เสร็จ
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // เปิดโมดัลแสดงประวัติทั้งหมด
        function openSavedList() {
            renderSavedList();
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // ล้างฟอร์มทั้งหมด
        function clearForm() {
            if (!confirm('คุณต้องการล้างข้อมูลทั้งหมดในฟอร์มใช่หรือไม่?')) return;
            
            // ล้าง input fields
            document.getElementById('pname').value = '';
            document.getElementById('hn').value = '';
            document.getElementById('age').value = '';
            document.getElementById('gender').value = 'ชาย';
            document.getElementById('idCard').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('emergencyPhone').value = '';
            document.getElementById('chronicDisease').value = '';
            document.getElementById('drugAllergy').value = '';
            document.getElementById('foodAllergy').value = '';
            // ที่อยู่
            document.getElementById('address').value = '';
            document.getElementById('road').value = '';
            document.getElementById('subdistrict').value = '';
            document.getElementById('district').value = '';
            document.getElementById('province').value = '';
            document.getElementById('zipcode').value = '';
            // สัญญาณชีพ
            document.getElementById('bloodPressure').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('spo2').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('visitTime').value = '09:00';
            document.getElementById('symptom').value = '';
            document.getElementById('history').value = '';
            document.getElementById('tcmDiag').value = '';
            document.getElementById('westDiag').value = '';
            document.getElementById('plan').value = '';
            document.getElementById('herbRecommendation').value = '';
            document.getElementById('treatmentDays').value = 7;
            document.getElementById('additionalNote').value = '';
            document.getElementById('appointNote').value = '';
            document.getElementById('otherPulse').value = '';
            document.getElementById('otherPulse').style.display = 'none';
            
            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซตส่วนลด
            document.getElementById('discountType').value = 'none';
            document.getElementById('discountValue').value = 0;
            document.getElementById('discountReason').value = '';
            discountAmount = 0;
            discountType = 'none';
            
            // ตั้งค่าวันที่นัดหมาย (7 วันข้างหน้า)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('appointDate').value = nextWeek.toISOString().slice(0, 16);
            
            // รีเซตตัวแปร
            selectedServices = [];
            totalCost = 0;
            
            // รีเซตรูปภาพ
            document.getElementById('tongue-image-preview').src = '';
            document.getElementById('tongue-image-preview').classList.add('d-none');
            document.getElementById('tongue-image-data').value = '';
            document.getElementById('face-image-preview').src = '';
            document.getElementById('face-image-preview').classList.add('d-none');
            document.getElementById('face-image-data').value = '';
            
            // หยุดสตรีมกล้อง
            if (tongueCameraStream) {
                tongueCameraStream.getTracks().forEach(track => track.stop());
                tongueCameraStream = null;
            }
            if (faceCameraStream) {
                faceCameraStream.getTracks().forEach(track => track.stop());
                faceCameraStream = null;
            }
            
            // อัพเดทใบเสร็จและส่วนลด
            updateDiscount();
            updateReceipt();
            
            // เริ่มกล้องใหม่
            setTimeout(() => initCameras(), 500);
            
            alert('ล้างฟอร์มสำเร็จ');
        }

        // ฟังก์ชันสำหรับจัดการการนัดหมาย
        function saveAppointment() {
            const appointDate = document.getElementById('appointDate').value;
            const appointType = document.getElementById('appointType').value;
            const appointNote = document.getElementById('appointNote').value;
            const patientName = document.getElementById('pname').value;

            if (!appointDate) {
                alert('กรุณาเลือกวันเวลานัดหมาย');
                return;
            }

            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนบันทึกการนัดหมาย');
                return;
            }

            const appointment = {
                id: Date.now(),
                patientName: patientName,
                date: appointDate,
                type: appointType,
                note: appointNote,
                createdAt: new Date().toLocaleString('th-TH')
            };

            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            appointments.unshift(appointment);
            localStorage.setItem(APPOINTMENT_KEY, JSON.stringify(appointments));

            alert('บันทึกการนัดหมายสำเร็จ!');
            document.getElementById('appointNote').value = '';
            
            // ตั้งค่าวันที่นัดหมายถัดไป (7 วันข้างหน้า)
            const nextDate = new Date(appointDate);
            nextDate.setDate(nextDate.getDate() + 7);
            document.getElementById('appointDate').value = nextDate.toISOString().slice(0, 16);
        }

        // แสดงการนัดหมายทั้งหมด
        function loadAppointments() {
            const container = document.getElementById('appointmentList');
            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            
            if (appointments.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">ยังไม่มีการนัดหมาย</div>';
                return;
            }

            // เรียงลำดับตามวันที่นัดหมาย (เร็วสุดก่อน)
            appointments.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '<div class="list-group">';
            appointments.forEach(appt => {
                const apptDate = new Date(appt.date);
                const now = new Date();
                const isPast = apptDate < now;
                const statusClass = isPast ? 'status-completed' : 'status-pending';
                const statusText = isPast ? 'ผ่านแล้ว' : 'รอดำเนินการ';
                
                const formattedDate = apptDate.toLocaleDateString('th-TH', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${appt.patientName}</h6>
                                <p class="mb-1">
                                    <i class="bi bi-calendar-event me-1"></i> ${formattedDate}<br>
                                    <i class="bi bi-tag me-1"></i> ${appt.type}
                                </p>
                                ${appt.note ? `<small class="text-muted"><i class="bi bi-chat-text me-1"></i> ${appt.note}</small>` : ''}
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteAppointment(${appt.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
            
            // แสดง modal
            const modal = new bootstrap.Modal(document.getElementById('appointmentsModal'));
            modal.show();
        }

        // ลบการนัดหมาย
        function deleteAppointment(id) {
            if (!confirm('คุณต้องการลบการนัดหมายนี้ใช่หรือไม่?')) return;
            
            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem(APPOINTMENT_KEY, JSON.stringify(appointments));
            
            loadAppointments();
        }

        // อัพเดทรายงาน Performance
        function updatePerformanceReport() {
            const period = document.getElementById('reportPeriod').value;
            const doctor = document.getElementById('doctorSelect').value;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            // กรองตามระยะเวลา
            const now = new Date();
            let filteredRecords = records;
            
            if (period !== 'all') {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.visitDate);
                    switch (period) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date();
                            weekAgo.setDate(now.getDate() - 7);
                            return recordDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date();
                            monthAgo.setMonth(now.getMonth() - 1);
                            return recordDate >= monthAgo;
                        case 'year':
                            const yearAgo = new Date();
                            yearAgo.setFullYear(now.getFullYear() - 1);
                            return recordDate >= yearAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // กรองตามแพทย์ (ถ้ามี)
            if (doctor !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.doctor === doctor);
            }
            
            // คำนวณสถิติ
            const totalPatients = filteredRecords.length;
            const totalRevenue = filteredRecords.reduce((sum, record) => sum + (record.totalCost || 0), 0);
            const avgRevenue = totalPatients > 0 ? Math.round(totalRevenue / totalPatients) : 0;
            
            // หาบริการยอดนิยม
            const serviceCount = {};
            filteredRecords.forEach(record => {
                if (record.services && Array.isArray(record.services)) {
                    record.services.forEach(service => {
                        serviceCount[service.service] = (serviceCount[service.service] || 0) + 1;
                    });
                }
            });
            
            let topService = '-';
            let maxCount = 0;
            for (const [service, count] of Object.entries(serviceCount)) {
                if (count > maxCount) {
                    maxCount = count;
                    topService = service;
                }
            }
            
            // อัพเดทตัวเลขสถิติ
            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
            document.getElementById('avgRevenue').textContent = avgRevenue.toLocaleString();
            document.getElementById('topService').textContent = topService;
            
            // อัพเดทกราฟโรคที่รักษา
            updateDiseaseChart(filteredRecords);
            
            // อัพเดทกราฟรายได้แพทย์
            updateDoctorRevenueChart(filteredRecords);
            
            // อัพเดทรายการโรคที่พบบ่อย
            updateTopDiseasesList(filteredRecords);
            
            // อัพเดทรายการรายได้แพทย์
            updateDoctorRevenueList(filteredRecords);
        }

        // อัพเดทกราฟโรคที่รักษา
        function updateDiseaseChart(records) {
            const diseaseCount = {};
            records.forEach(record => {
                const diag = record.tcmDiag || 'ไม่ระบุ';
                diseaseCount[diag] = (diseaseCount[diag] || 0) + 1;
            });
            
            const labels = Object.keys(diseaseCount);
            const data = Object.values(diseaseCount);
            
            const ctx = document.getElementById('diseaseChart').getContext('2d');
            
            if (diseaseChart) {
                diseaseChart.destroy();
            }
            
            if (labels.length === 0) {
                document.getElementById('diseaseChart').innerHTML = '<div class="text-center text-muted p-5">ไม่มีข้อมูล</div>';
                return;
            }
            
            diseaseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#6c5ce7', '#a29bfe', '#00cec9', '#00b894', '#fdcb6e',
                            '#e17055', '#d63031', '#e84393', '#0984e3', '#00b894'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'สัดส่วนโรคที่รักษา'
                        }
                    }
                }
            });
        }

        // อัพเดทกราฟรายได้แพทย์
        function updateDoctorRevenueChart(records) {
            const doctorRevenue = {};
            records.forEach(record => {
                const doctor = record.doctor || 'ไม่ระบุ';
                doctorRevenue[doctor] = (doctorRevenue[doctor] || 0) + (record.totalCost || 0);
            });
            
            // แปลงรหัสแพทย์เป็นชื่อ
            const doctorNames = {
                'dr1': 'แพทย์หญิง สุนิสา',
                'dr2': 'แพทย์ชาย อนุชา',
                'dr3': 'แพทย์หญิง ปิยนุช',
                'all': 'แพทย์ทั้งหมด',
                'ไม่ระบุ': 'ไม่ระบุ'
            };
            
            const labels = Object.keys(doctorRevenue).map(d => doctorNames[d] || d);
            const data = Object.values(doctorRevenue);
            
            const ctx = document.getElementById('doctorRevenueChart').getContext('2d');
            
            if (doctorRevenueChart) {
                doctorRevenueChart.destroy();
            }
            
            if (labels.length === 0) {
                document.getElementById('doctorRevenueChart').innerHTML = '<div class="text-center text-muted p-5">ไม่มีข้อมูล</div>';
                return;
            }
            
            doctorRevenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'รายได้ (บาท)',
                        data: data,
                        backgroundColor: '#6c5ce7',
                        borderColor: '#6c5ce7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'รายได้ (บาท)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'รายได้แพทย์แต่ละท่าน'
                        }
                    }
                }
            });
        }

        // อัพเดทรายการโรคที่พบบ่อย
        function updateTopDiseasesList(records) {
            const diseaseCount = {};
            records.forEach(record => {
                const diag = record.tcmDiag || 'ไม่ระบุ';
                if (diag !== 'ไม่ระบุ') {
                    diseaseCount[diag] = (diseaseCount[diag] || 0) + 1;
                }
            });
            
            // เรียงลำดับจากมากไปน้อย
            const sortedDiseases = Object.entries(diseaseCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            if (sortedDiseases.length > 0) {
                sortedDiseases.forEach(([disease, count], index) => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <span class="badge bg-primary me-2">${index + 1}</span>
                                <span>${disease}</span>
                            </div>
                            <span class="badge bg-secondary">${count} เคส</span>
                        </div>
                    `;
                });
            } else {
                html = '<div class="text-center text-muted p-3">ไม่มีข้อมูลโรคที่พบบ่อย</div>';
            }
            
            document.getElementById('topDiseasesList').innerHTML = html;
        }

        // อัพเดทรายการรายได้แพทย์
        function updateDoctorRevenueList(records) {
            const doctorRevenue = {};
            records.forEach(record => {
                const doctor = record.doctor || 'ไม่ระบุ';
                doctorRevenue[doctor] = (doctorRevenue[doctor] || 0) + (record.totalCost || 0);
            });
            
            // แปลงรหัสแพทย์เป็นชื่อ
            const doctorNames = {
                'dr1': 'แพทย์หญิง สุนิสา',
                'dr2': 'แพทย์ชาย อนุชา',
                'dr3': 'แพทย์หญิง ปิยนุช',
                'all': 'แพทย์ทั้งหมด',
                'ไม่ระบุ': 'ไม่ระบุ'
            };
            
            const sortedDoctors = Object.entries(doctorRevenue)
                .sort((a, b) => b[1] - a[1]);
            
            let html = '';
            if (sortedDoctors.length > 0) {
                sortedDoctors.forEach(([doctor, revenue], index) => {
                    const doctorName = doctorNames[doctor] || doctor;
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <span class="badge bg-success me-2">${index + 1}</span>
                                <span>${doctorName}</span>
                            </div>
                            <span class="text-success fw-bold">${revenue.toLocaleString()} บาท</span>
                        </div>
                    `;
                });
            } else {
                html = '<div class="text-center text-muted p-3">ไม่มีข้อมูลรายได้แพทย์</div>';
            }
            
            document.getElementById('doctorRevenueList').innerHTML = html;
        }

        // ส่งออกรายงานเป็น PDF
        function exportReportPDF() {
            try {
                const element = document.createElement('div');
                element.innerHTML = generateReportContent();
                
                const opt = {
                    margin: 10,
                    filename: `รายงานสถิติ_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF export error:', error);
                alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
            }
        }

        // สร้างเนื้อหาสำหรับรายงาน PDF
        function generateReportContent() {
            const period = document.getElementById('reportPeriod').value;
            const doctor = document.getElementById('doctorSelect').value;
            const periodText = {
                'today': 'วันนี้',
                'week': 'สัปดาห์นี้',
                'month': 'เดือนนี้',
                'year': 'ปีนี้',
                'all': 'ทั้งหมด'
            }[period];
            
            const doctorText = document.getElementById('doctorSelect').selectedOptions[0].text;
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 25px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">รายงานสถิติและ Performance</h2>
                        <h4 style="color: #333; margin-bottom: 15px;">ซินไท คลินิกแพทย์แผนจีน</h4>
                        <p style="color: #777;">ช่วงเวลา: ${periodText} | แพทย์: ${doctorText}</p>
                        <p style="color: #777;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH')}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">สถิติสรุป</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <tr>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('totalPatients').textContent}</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">จำนวนเคสทั้งหมด</p>
                                </td>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('totalRevenue').textContent} บาท</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">รายได้ทั้งหมด</p>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('avgRevenue').textContent} บาท</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">รายได้เฉลี่ยต่อเคส</p>
                                </td>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('topService').textContent}</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">บริการยอดนิยม</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">สรุปยอดรายได้แพทย์</h4>
                        <div id="doctorRevenueListForPDF" style="margin-top: 15px;">
                            ${document.getElementById('doctorRevenueList').innerHTML}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">โรคที่พบบ่อย</h4>
                        <div id="topDiseasesListForPDF" style="margin-top: 15px;">
                            ${document.getElementById('topDiseasesList').innerHTML}
                        </div>
                    </div>
                    
                    <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 15px; text-align: center;">
                        <p>รายงานนี้ถูกสร้างขึ้นโดยระบบเวชระเบียน ซินไท คลินิกการแพทย์แผนจีน</p>
                        <p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหารายชื่อผู้ป่วย PDF
        function generatePatientListPDFContent() {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            // จัดกลุ่มผู้ป่วย
            const patients = {};
            records.forEach(record => {
                const uniqueKey = record.hn || record.idCard || `${record.name}_${record.phone || 'no-phone'}`;
                
                if (!patients[uniqueKey]) {
                    patients[uniqueKey] = {
                        name: record.name,
                        hn: record.hn,
                        age: record.age,
                        gender: record.gender,
                        phone: record.phone,
                        idCard: record.idCard || 'ไม่ระบุ',
                        totalVisits: 0,
                        totalSpent: 0,
                        lastVisit: record.savedAt,
                        diagnoses: []
                    };
                }
                
                patients[uniqueKey].totalVisits++;
                patients[uniqueKey].totalSpent += record.totalCost || 0;
                if (record.tcmDiag && !patients[uniqueKey].diagnoses.includes(record.tcmDiag)) {
                    patients[uniqueKey].diagnoses.push(record.tcmDiag);
                }
            });
            
            const patientArray = Object.values(patients);
            
            let patientsHTML = '';
            patientArray.forEach((patient, index) => {
                const diagnosisText = patient.diagnoses.length > 0 ? 
                    patient.diagnoses.slice(0, 2).join(', ') + (patient.diagnoses.length > 2 ? '...' : '') : 
                    'ไม่ระบุ';
                
                patientsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px;">${patient.name || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px; text-align: center;">${patient.hn || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px; text-align: center;">${patient.age || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px; text-align: center;">${patient.gender || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px;">${patient.idCard}</td>
                        <td style="padding: 10px;">${patient.phone || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px; text-align: center;">${patient.totalVisits}</td>
                        <td style="padding: 10px; text-align: right;">${patient.totalSpent.toLocaleString()} บาท</td>
                        <td style="padding: 10px;">${diagnosisText}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">รายชื่อผู้ป่วยทั้งหมด</h2>
                        <h4 style="color: #333; margin-bottom: 15px;">ซินไท คลินิกแพทย์แผนจีน</h4>
                        <p style="color: #777;">จำนวนผู้ป่วยทั้งหมด: ${patientArray.length} ราย</p>
                        <p style="color: #777;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH')}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #6c5ce7; color: white;">
                                <th style="padding: 12px; width: 5%;">ลำดับ</th>
                                <th style="padding: 12px; width: 15%;">ชื่อ-สกุล</th>
                                <th style="padding: 12px; width: 8%;">HN</th>
                                <th style="padding: 12px; width: 5%;">อายุ</th>
                                <th style="padding: 12px; width: 5%;">เพศ</th>
                                <th style="padding: 12px; width: 15%;">เลขบัตรประชาชน</th>
                                <th style="padding: 12px; width: 10%;">โทรศัพท์</th>
                                <th style="padding: 12px; width: 8%;">จำนวนครั้ง</th>
                                <th style="padding: 12px; width: 12%;">ยอดใช้จ่าย</th>
                                <th style="padding: 12px; width: 17%;">โรคที่พบบ่อย</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${patientsHTML}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #333; text-align: right;">
                        <p>พิมพ์โดย: ระบบ OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</p>
                        <p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาประวัติผู้ป่วย PDF
        function generatePatientHistoryPDFContent() {
            if (currentPatientRecords.length === 0) {
                return '<div>ไม่มีข้อมูลผู้ป่วย</div>';
            }
            
            const patient = currentPatientRecords[0];
            
            let historyHTML = '';
            currentPatientRecords.forEach((record, index) => {
                const services = record.services ? record.services.map(s => s.service).join(', ') : 'ไม่ระบุ';
                
                historyHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px;">${record.visitDate || 'ไม่ระบุ'} ${record.visitTime || ''}</td>
                        <td style="padding: 10px;">${record.tcmDiag || 'ไม่ระบุ'}</td>
                        <td style="padding: 10px;">${services}</td>
                        <td style="padding: 10px; text-align: right;">${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</td>
                        <td style="padding: 10px;">${record.symptom ? record.symptom.substring(0, 50) + (record.symptom.length > 50 ? '...' : '') : 'ไม่ระบุ'}</td>
                    </tr>
                `;
            });
            
            // คำนวณสถิติ
            const totalVisits = currentPatientRecords.length;
            const totalSpent = currentPatientRecords.reduce((sum, r) => sum + (r.totalCost || 0), 0);
            const avgSpent = totalVisits > 0 ? Math.round(totalSpent / totalVisits) : 0;
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">ประวัติการรักษาผู้ป่วย</h2>
                        <h3 style="color: #333; margin-bottom: 10px;">${patient.name || 'ไม่ระบุชื่อ'} ${patient.hn ? `(HN: ${patient.hn})` : ''}</h3>
                        <p style="color: #777;">เลขบัตรประชาชน: ${patient.idCard || 'ไม่ระบุ'} | โทรศัพท์: ${patient.phone || 'ไม่ระบุ'}</p>
                        <p style="color: #777;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH')}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px; padding: 15px; background-color: #f8f9ff; border-radius: 8px;">
                        <h4 style="color: #6c5ce7; margin-bottom: 15px;">ข้อมูลผู้ป่วย</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 25%; padding: 8px 0;"><strong>ชื่อ-สกุล:</strong></td>
                                <td style="width: 25%; padding: 8px 0;">${patient.name || 'ไม่ระบุ'}</td>
                                <td style="width: 25%; padding: 8px 0;"><strong>อายุ/เพศ:</strong></td>
                                <td style="width: 25%; padding: 8px 0;">${patient.age || 'ไม่ระบุ'} ปี / ${patient.gender || 'ไม่ระบุ'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>โรคประจำตัว:</strong></td>
                                <td style="padding: 8px 0;">${patient.chronicDisease || 'ไม่มี'}</td>
                                <td style="padding: 8px 0;"><strong>แพ้ยา/อาหาร:</strong></td>
                                <td style="padding: 8px 0;">${patient.drugAllergy || 'ไม่มี'} / ${patient.foodAllergy || 'ไม่มี'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; margin-bottom: 15px;">สถิติการรักษา</h4>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div style="padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 30%;">
                                <div style="font-size: 2rem; color: #6c5ce7; font-weight: 700;">${totalVisits}</div>
                                <div style="color: #666;">จำนวนครั้งที่รักษา</div>
                            </div>
                            <div style="padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 30%;">
                                <div style="font-size: 2rem; color: #6c5ce7; font-weight: 700;">${totalSpent.toLocaleString()}</div>
                                <div style="color: #666;">ยอดใช้จ่ายทั้งหมด (บาท)</div>
                            </div>
                            <div style="padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 30%;">
                                <div style="font-size: 2rem; color: #6c5ce7; font-weight: 700;">${avgSpent.toLocaleString()}</div>
                                <div style="color: #666;">ค่าใช้จ่ายเฉลี่ย (บาท)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; margin-bottom: 15px;">ประวัติการรักษาทั้งหมด</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #6c5ce7; color: white;">
                                    <th style="padding: 12px; width: 5%;">ลำดับ</th>
                                    <th style="padding: 12px; width: 15%;">วันที่ตรวจ</th>
                                    <th style="padding: 12px; width: 20%;">วินิจฉัย</th>
                                    <th style="padding: 12px; width: 25%;">บริการ</th>
                                    <th style="padding: 12px; width: 15%;">ค่าใช้จ่าย</th>
                                    <th style="padding: 12px; width: 20%;">อาการสำคัญ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${historyHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #333; text-align: center;">
                        <p>พิมพ์โดย: ระบบเวชระเบียน ซินไท คลินิกการแพทย์แผนจีน</p>
                        <p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหา PDF สำหรับประวัติผู้ป่วย
        function generatePDFContentFromRecord(record) {
            const tongue = Array.isArray(record.tongue) ? record.tongue.join(', ') : record.tongue;
            const pulseTCM = Array.isArray(record.pulseTCM) ? record.pulseTCM.join(', ') : record.pulseTCM;
            const servicesList = record.services ? record.services.map(s => `${s.service} (${s.price} บาท)`).join(', ') : 'ไม่มีข้อมูล';
            
            // รวบรวมที่อยู่แบบกระชับ
            const addressParts = [
                record.address,
                record.road,
                `${record.subdistrict || ''} ${record.district || ''}`.trim(),
                record.province
            ].filter(part => part && part.trim() !== '');
            const fullAddress = addressParts.join(' ');
            
            // ตรวจสอบว่ามีรูปหน้าผู้ป่วยหรือไม่
            const hasFaceImage = record.faceImage && record.faceImage.trim() !== '';
            const hasTongueImage = record.tongueImage && record.tongueImage.trim() !== '';
            
            return `
                <div style="font-family: 'TH Sarabun New', 'Sarabun', sans-serif; padding: 8mm 10mm; line-height: 1.1; color: #000000; font-size: 9pt;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 3mm; padding-bottom: 1mm; border-bottom: 1pt solid #000;">
                        <h1 style="margin: 0; font-size: 12pt; font-weight: bold;">บันทึกการตรวจ OPD แพทย์แผนจีน</h1>
                        <p style="margin: 0.5mm 0; font-size: 8.5pt;"> ซินไท คลินิกแพทย์แผนจีน</p>
                        <p style="margin: 0; font-size: 8pt; color: #666;">เอกสารบันทึกเวชระเบียนทางการแพทย์</p>
                    </div>
                    
                    <!-- Compact Patient Information with Photo -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; border: 0.5pt solid #000;">
                        <tr>
                            <td colspan="2" style="padding: 1mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9.5pt;">ข้อมูลผู้ป่วย</strong>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 70%; padding: 0.8mm; vertical-align: top;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <tr>
                                        <td style="width: 18%; padding: 0.6mm 0.5mm;"><strong>HN:</strong></td>
                                        <td style="width: 32%; padding: 0.6mm 0.5mm; border-right: 0.5pt solid #ccc;">${record.hn || '-'}</td>
                                        <td style="width: 18%; padding: 0.6mm 0.5mm;"><strong>อายุ/เพศ:</strong></td>
                                        <td style="width: 32%; padding: 0.6mm 0.5mm;">${record.age || '-'}/${record.gender || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>ชื่อ-สกุล:</strong></td>
                                        <td colspan="3" style="padding: 0.6mm 0.5mm;">${record.name || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>เลขบัตร:</strong></td>
                                        <td style="padding: 0.6mm 0.5mm; border-right: 0.5pt solid #ccc;">${record.idCard || '-'}</td>
                                        <td style="padding: 0.6mm 0.5mm;"><strong>โทร:</strong></td>
                                        <td style="padding: 0.6mm 0.5mm;">${record.phone || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.6mm 0.5mm; vertical-align: top;"><strong>ที่อยู่:</strong></td>
                                        <td colspan="3" style="padding: 0.6mm 0.5mm; font-size: 8.5pt;">
                                            ${fullAddress || '-'} ${record.zipcode ? ' ' + record.zipcode : ''}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 30%; padding: 0.8mm; border-left: 0.5pt solid #000; text-align: center; vertical-align: top;">
                                <strong style="font-size: 8.5pt;">รูปหน้าผู้ป่วย</strong>
                                <div style="margin: 1mm auto;">
                                    ${hasFaceImage ? `
                                        <img src="${record.faceImage}" 
                                             style="width: 25mm; height: 30mm; object-fit: cover; border: 0.5pt solid #ccc;"
                                             onerror="this.style.display='none';">
                                    ` : `
                                        <div style="width: 25mm; height: 30mm; border: 0.5pt dashed #999; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                            <span style="font-size: 8pt; color: #666;">ไม่มีรูปภาพ</span>
                                        </div>
                                    `}
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visit and Vital Signs - Compact -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; font-size: 9pt;">
                        <tr>
                            <td style="width: 50%; vertical-align: top; padding-right: 1mm;">
                                <table style="width: 100%; border-collapse: collapse; border: 0.5pt solid #000;">
                                    <tr>
                                        <td style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                            <strong>ข้อมูลการตรวจ</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.8mm;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <tr>
                                                    <td style="width: 35%; padding: 0.5mm;"><strong>วันที่:</strong></td>
                                                    <td style="padding: 0.5mm; font-size: 8.5pt;">${record.visitDate || record.savedAt || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.5mm;"><strong>เวลา:</strong></td>
                                                    <td style="padding: 0.5mm; font-size: 8.5pt;">${record.visitTime || '-'}</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 50%; vertical-align: top; padding-left: 1mm;">
                                <table style="width: 100%; border-collapse: collapse; border: 0.5pt solid #000;">
                                    <tr>
                                        <td colspan="5" style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000; text-align: center;">
                                            <strong>สัญญาณชีพ</strong>
                                        </td>
                                    </tr>
                                    <tr style="text-align: center; font-size: 8.5pt;">
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>BP</strong></div>
                                            <div>${record.bloodPressure || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>ชีพจร</strong></div>
                                            <div>${record.pulse || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>SpO₂</strong></div>
                                            <div>${record.spo2 || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc;">
                                            <div><strong>อุณหภูมิ</strong></div>
                                            <div>${record.temperature || '-'}</div>
                                        </td>
                                        <td style="padding: 0.6mm;">
                                            <div><strong>น้ำหนัก</strong></div>
                                            <div>${record.weight || '-'} กก.</div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- TCM Examination - Ultra Compact -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2mm; border: 0.5pt solid #000; font-size: 9pt;">
                        <tr>
                            <td colspan="4" style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong>การตรวจร่างกายแพทย์แผนจีน</strong>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 15%; padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>อาการสำคัญ:</strong></td>
                            <td style="width: 35%; padding: 0.6mm; border-right: 0.5pt solid #ccc; font-size: 8.5pt;">${record.symptom || '-'}</td>
                            <td style="width: 15%; padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ลักษณะลิ้น:</strong></td>
                            <td style="width: 35%; padding: 0.6mm; font-size: 8.5pt;">${tongue || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ประวัติ:</strong></td>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; font-size: 8.5pt;">${record.history || '-'}</td>
                            <td style="padding: 0.6mm; border-right: 0.5pt solid #ccc; background-color: #f9f9f9;"><strong>ชีพจร TCM:</strong></td>
                            <td style="padding: 0.6mm; font-size: 8.5pt;">${pulseTCM || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- Diagnosis and Treatment - Side by Side -->
                    <div style="display: flex; gap: 1.5mm; margin-bottom: 2mm;">
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">การวินิจฉัย</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.8mm;">
                                    <strong style="color: #d32f2f; font-size: 8.5pt;">แพทย์แผนจีน:</strong>
                                    <div style="font-size: 8.5pt; margin-top: 0.2mm;">${record.tcmDiag || 'ไม่ระบุ'}</div>
                                </div>
                                <div>
                                    <strong style="color: #1976d2; font-size: 8.5pt;">วินิจฉัยสากล:</strong>
                                    <div style="font-size: 8.5pt; margin-top: 0.2mm;">${record.westDiag || 'ไม่ระบุ'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">แผนการรักษา</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>แผน:</strong> ${record.plan || '-'}
                                </div>
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>ยาสมุนไพร:</strong> ${record.herbRecommendation || '-'}
                                </div>
                                <div style="font-size: 8.5pt;">
                                    <strong>จำนวนวัน:</strong> ${record.treatmentDays || 0} วัน
                                    ${record.additionalNote ? `<br><strong>หมายเหตุ:</strong> ${record.additionalNote}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Services and Tongue Image - Compact -->
                    <div style="display: flex; gap: 1.5mm; margin-bottom: 2mm;">
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000;">
                                <strong style="font-size: 9pt;">บริการและค่าใช้จ่าย</strong>
                            </div>
                            <div style="padding: 0.8mm;">
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>บริการ:</strong> ${servicesList || '-'}
                                </div>
                                ${record.discount > 0 ? `
                                <div style="margin-bottom: 0.6mm; font-size: 8.5pt;">
                                    <strong>ส่วนลด:</strong> ${record.discount.toFixed(2)} บาท
                                    ${record.discountReason ? `(${record.discountReason})` : ''}
                                </div>
                                ` : ''}
                                <div style="padding: 0.6mm; background-color: #e8f5e8; border: 0.3pt solid #4caf50;">
                                    <strong style="color: #1b5e20; font-size: 9pt;">รวม: ${record.totalCost ? record.totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0'} บาท</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="flex: 1; border: 0.5pt solid #000;">
                            <div style="padding: 0.8mm; background-color: #f0f0f0; border-bottom: 0.5pt solid #000; text-align: center;">
                                <strong style="font-size: 9pt;">รูปภาพประกอบ</strong>
                            </div>
                            <div style="padding: 0.8mm; text-align: center;">
                                ${hasTongueImage ? `
                                    <img src="${record.tongueImage}" 
                                         style="width: 40mm; height: 25mm; object-fit: cover; border: 0.5pt solid #ccc;"
                                         onerror="this.style.display='none';">
                                    <div style="margin-top: 0.5mm; font-size: 8pt; color: #666;">รูปลิ้นผู้ป่วย</div>
                                ` : `
                                    <div style="width: 40mm; height: 25mm; border: 0.5pt dashed #999; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                        <span style="font-size: 8pt; color: #666;">ไม่มีรูปภาพลิ้น</span>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compact Signatures -->
                    <div style="margin-top: 2mm; padding: 1mm; border: 0.5pt solid #000;">
                        <table style="width: 100%; font-size: 8.5pt;">
                            <tr>
                                <td style="width: 50%; text-align: center; padding: 1mm;">
                                    <div style="border-bottom: 0.5pt solid #000; width: 60mm; margin: 0 auto 1.5mm auto; padding-bottom: 1.5mm;"></div>
                                    <p style="margin: 0; font-weight: bold;">ลายเซ็นแพทย์ผู้ตรวจ</p>
                                    <p style="margin: 0.5mm 0 0 0; font-size: 8.5pt;">
                                        แพทย์แผนจีน พจ.979 ณรงค์ศักดิ์ รุ่งเรืองสกุลไชย
                                    </p>
                                </td>
                                <td style="width: 50%; text-align: center; padding: 1mm; border-left: 0.5pt solid #ccc;">
                                    <div style="border-bottom: 0.5pt solid #000; width: 60mm; margin: 0 auto 1.5mm auto; padding-bottom: 1.5mm;"></div>
                                    <p style="margin: 0; font-weight: bold;">ลายเซ็นผู้ป่วย/ผู้ปกครอง</p>
                                    <p style="margin: 0.5mm 0 0 0; font-size: 8.5pt;">
                                        วันที่: ${new Date().toLocaleDateString('th-TH')}
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Minimal Footer -->
                    <div style="margin-top: 1mm; text-align: center;">
                        <p style="margin: 0; font-size: 7pt; color: #666;">
                            เอกสารนี้เป็นส่วนหนึ่งของเวชระเบียนทางการแพทย์ | TCM OPD Record
                        </p>
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>
