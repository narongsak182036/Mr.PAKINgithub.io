<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึก OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <!-- Chart.js สำหรับกราฟ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #00cec9;
            --danger-color: #e17055;
            --success-color: #00b894;
            --light-bg: #f8f9ff;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Sarabun', 'Noto Sans Thai', system-ui, sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1.2rem 1.5rem;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3);
        }
        
        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            border-radius: 10px;
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 0.7rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(108, 92, 231, 0.15);
        }
        
        .chip {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 50px;
            background-color: #f1f3ff;
            border: 1px solid #e0e5ff;
            color: #555;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chip:hover {
            background-color: #e9edff;
        }
        
        .chip.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .service-chip {
            display: inline-block;
            padding: 0.7rem 1.2rem;
            margin: 0.3rem;
            border-radius: 12px;
            background-color: white;
            border: 2px solid #e0e5ff;
            color: #555;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 180px;
        }
        
        .service-chip:hover {
            border-color: var(--primary-color);
            background-color: #f8f9ff;
        }
        
        .service-chip.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.2);
        }
        
        .service-price {
            display: block;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 0.3rem;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f2ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-completed {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }
        
        .status-pending {
            background-color: rgba(253, 203, 110, 0.1);
            color: #f39c12;
        }
        
        .status-cancelled {
            background-color: rgba(231, 112, 85, 0.1);
            color: var(--danger-color);
        }
        
        .patient-info-box {
            background: linear-gradient(135deg, #f8f9ff, #f0f2ff);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #777;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 500;
            color: #333;
        }
        
        .receipt-box {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px dashed #e0e5ff;
            margin-top: 1rem;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .receipt-total {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 2px solid var(--primary-color);
            margin-top: 0.5rem;
        }
        
        /* สำหรับ PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        
        /* สำหรับ PDF ครึ่งหน้า */
        .half-page-pdf {
            width: 148mm;
            height: 105mm;
            padding: 15mm;
            box-sizing: border-box;
        }
        
        /* กล้องถ่ายรูป */
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        #tongue-camera, #face-camera {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }
        
        .captured-image-container {
            margin-top: 15px;
            text-align: center;
        }
        
        .captured-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            border: 3px solid #ddd;
        }
        
        /* สไตล์สำหรับ Performance Report */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* สไตล์สำหรับ Patient History */
        .patient-history-item {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .patient-history-date {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .patient-history-diagnosis {
            color: #555;
            font-size: 0.9rem;
        }
        
        .patient-history-services {
            font-size: 0.85rem;
            color: #777;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .card {
                margin-bottom: 1.5rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn-group {
                width: 100%;
            }
            
            .service-chip {
                min-width: 140px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse me-2"></i>
                OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showMainForm()"><i class="bi bi-house-door me-1"></i> หน้าหลัก</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openSavedList()"><i class="bi bi-folder me-1"></i> ประวัติผู้ป่วย</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAppointments()"><i class="bi bi-calendar-check me-1"></i> นัดหมาย</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPerformanceReport()"><i class="bi bi-graph-up me-1"></i> รายงานสถิติ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4" id="main-content">
        <!-- ค้นหาประวัติ -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-search me-2"></i> ค้นหาประวัติผู้ป่วย
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input id="searchBox" class="form-control" placeholder="ค้นหาตามชื่อ, อาการ, วินิจฉัย..." oninput="searchRecords()">
                            </div>
                            <div class="col-md-4">
                                <input id="searchIdCard" class="form-control" placeholder="ค้นหาตามเลขบัตรประชาชน..." oninput="searchRecords()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="openSavedList()">
                                    <i class="bi bi-folder me-2"></i> ประวัติทั้งหมด
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100" onclick="openPatientList()">
                                    <i class="bi bi-people me-2"></i> รายชื่อผู้ป่วย
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ข้อมูลผู้ป่วย -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-person-circle me-2"></i> ข้อมูลผู้ป่วย
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">ชื่อ - สกุล</label>
                                <input id="pname" class="form-control" placeholder="กรุณากรอกชื่อ-สกุลผู้ป่วย">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อายุ</label>
                                <input id="age" type="number" class="form-control" min="0" max="120">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">เพศ</label>
                                <select id="gender" class="form-select">
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                    <option value="อื่น">อื่น</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขบัตรประชาชน</label>
                                <input id="idCard" type="text" class="form-control" placeholder="กรอกเลขบัตรประชาชน 13 หลัก">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เบอร์โทรศัพท์</label>
                                <input id="phone" type="tel" class="form-control" placeholder="กรอกเบอร์โทรศัพท์">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เบอร์โทรฉุกเฉิน</label>
                                <input id="emergencyPhone" type="tel" class="form-control" placeholder="กรอกเบอร์โทรฉุกเฉิน">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">โรคประจำตัว</label>
                                <input id="chronicDisease" type="text" class="form-control" placeholder="กรอกโรคประจำตัว (ถ้ามี)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">แพ้ยา</label>
                                <input id="drugAllergy" type="text" class="form-control" placeholder="กรอกยาที่แพ้ (ถ้ามี)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">แพ้อาหาร</label>
                                <input id="foodAllergy" type="text" class="form-control" placeholder="กรอกอาหารที่แพ้ (ถ้ามี)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">BP (ความดันโลหิต)</label>
                                <input id="bloodPressure" type="text" class="form-control" placeholder="เช่น 120/80 mmHg">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">pulse (P)</label>
                                <input id="pulse" type="number" class="form-control" placeholder="เช่น 72">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ออกซิเจนในเลือด (SpO2)</label>
                                <input id="spo2" type="number" class="form-control" placeholder="เช่น 98" min="0" max="100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อุณหภูมิ (Temp)</label>
                                <input id="temperature" type="number" step="0.1" class="form-control" placeholder="เช่น 36.5">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">น้ำหนัก (Weight)</label>
                                <input id="weight" type="number" step="0.1" class="form-control" placeholder="เช่น 65.5" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วันที่ตรวจ</label>
                                <input id="visitDate" type="date" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เวลา</label>
                                <input id="visitTime" type="time" class="form-control" value="09:00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- อาการและประวัติ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-clipboard-pulse me-2"></i> อาการและการวินิจฉัย
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">อาการสำคัญ(主诉)</label>
                            <textarea id="symptom" rows="3" class="form-control" placeholder="อาการที่ผู้ป่วยมาพบแพทย์"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">อาการปัจจุบัน(现病史)</label>
                            <textarea id="history" rows="2" class="form-control" placeholder="ประวัติการเจ็บป่วย / ประวัติการรักษา"></textarea>
                        </div>
                        
                        <!-- ระบบถ่ายรูปลิ้นและใบหน้า -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ถ่ายรูปลิ้น</label>
                                    <div class="camera-container">
                                        <video id="tongue-camera" autoplay playsinline></video>
                                        <div class="camera-controls">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="captureTongueImage()">
                                                <i class="bi bi-camera me-1"></i> ถ่ายรูปลิ้น
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="startTongueCamera()">
                                                <i class="bi bi-arrow-clockwise me-1"></i> เริ่มใหม่
                                            </button>
                                        </div>
                                    </div>
                                    <div class="captured-image-container">
                                        <img id="tongue-image-preview" class="captured-image d-none" alt="รูปลิ้น">
                                        <input type="hidden" id="tongue-image-data">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ถ่ายรูปใบหน้า</label>
                                    <div class="camera-container">
                                        <video id="face-camera" autoplay playsinline></video>
                                        <div class="camera-controls">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="captureFaceImage()">
                                                <i class="bi bi-camera me-1"></i> ถ่ายรูปหน้า
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="startFaceCamera()">
                                                <i class="bi bi-arrow-clockwise me-1"></i> เริ่มใหม่
                                            </button>
                                        </div>
                                    </div>
                                    <div class="captured-image-container">
                                        <img id="face-image-preview" class="captured-image d-none" alt="รูปหน้า">
                                        <input type="hidden" id="face-image-data">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ลักษณะลิ้น (เลือกได้หลายข้อ)</label>
                                    <div id="tongueChips" class="d-flex flex-wrap">
                                        <span class="chip" data-val="สีแดง">สีแดง</span>
                                        <span class="chip" data-val="ซีด">สีซีด</span>
                                        <span class="chip" data-val="สีม่วงคล้ำ">สีม่วงคล้ำ</span>
                                        <span class="chip" data-val="ฝ้าขาว">ฝ้าขาว</span>
                                        <span class="chip" data-val="ฝ้าบาง">ฝ้าบาง</span>
                                        <span class="chip" data-val="ฝ้าเเห้ง">ฝ้าเเห้ง กระด้าง</span>
                                        <span class="chip" data-val="ฝ้าเหลือง">ฝ้าเหลือง</span>
                                        <span class="chip" data-val="ลิ้นมีจุดแดง">ลิ้นมีจุดแดง</span>
                                        <span class="chip" data-val="ลิ้นบวมใหญ่">ลิ้นบวมใหญ่</span>
                                        <span class="chip" data-val="ลิ้นมีรอยพิมพ์ฟัน">ลิ้นมีรอยพิมพ์ฟัน</span>
                                        <span class="chip" data-val="ปลายลิ้นเเดง">ปลายลิ้นเเดง</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชีพจรแพทย์แผนจีน (เลือกได้หลายข้อ)</label>
                                    <div id="pulseChips" class="d-flex flex-wrap">
                                        <span class="chip" data-val="ปกติ">ปกติ</span>
                                        <span class="chip" data-val="ลื่น 滑脉">ลื่น 滑脉</span>
                                        <span class="chip" data-val="ตึง 弦脉">ตึง 弦脉</span>
                                        <span class="chip" data-val="จม 沉脉">จม 沉脉</span>
                                        <span class="chip" data-val="ลอย 浮脉">ลอย 浮脉</span>
                                        <span class="chip" data-val="ฝืด ติดขัด">ฝืด ติดขัด</span>
                                        <span class="chip" data-val="อื่นๆ">อื่นๆ</span>
                                    </div>
                                    <input id="otherPulse" type="text" class="form-control mt-2" placeholder="ระบุชีพจรอื่นๆ" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">วินิจฉัย (แพทย์แผนจีน)</label>
                                <input id="tcmDiag" class="form-control" placeholder="เช่น 肝郁化火">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วินิจฉัยWestern (Western Dx)</label>
                                <input id="westDiag" class="form-control" placeholder="เช่น Tension Headache">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- บริการและค่าใช้จ่าย -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-cash-coin me-2"></i> บริการและค่าใช้จ่าย
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="section-title">เลือกบริการที่ได้รับ</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ฝังเข็ม + กระตุ้นไฟฟ้า" data-price="700">
                                        <div>ฝังเข็ม + กระตุ้นไฟฟ้า</div>
                                        <span class="service-price">700 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ฝังเข็ม + ครอบแก้ว" data-price="850">
                                        <div>ฝังเข็ม + ครอบแก้ว</div>
                                        <span class="service-price">850 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ครอบแก้ว" data-price="500">
                                        <div>ครอบแก้ว</div>
                                        <span class="service-price">500 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ตรวจ + ยาจีน" data-price="750">
                                        <div>ตรวจ + ยาจีน</div>
                                        <span class="service-price">750 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="นวดกดจุด" data-price="400">
                                        <div>นวดกดจุด</div>
                                        <span class="service-price">400 บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="service-chip" data-service="ตรวจทั่วไป" data-price="300">
                                        <div>ตรวจทั่วไป</div>
                                        <span class="service-price">300 บาท</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">บริการอื่นๆ</label>
                                    <input id="otherService" class="form-control" placeholder="กรอกบริการอื่นๆ" onchange="updateCustomService()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ราคาบริการอื่นๆ</label>
                                    <div class="input-group">
                                        <input id="otherPrice" type="number" class="form-control" min="0" value="0" oninput="updateCustomService()">
                                        <span class="input-group-text">บาท</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="receipt-box">
                            <h6 class="section-title">ใบเสร็จรับเงิน</h6>
                            <div id="receiptItems">
                                <!-- ข้อมูลใบเสร็จจะถูกเพิ่มโดย JavaScript -->
                            </div>
                            <div class="receipt-total">
                                <span>รวมทั้งสิ้น</span>
                                <span id="totalCost">0 บาท</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- แผนการรักษา -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-prescription me-2"></i> แผนการรักษา
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">แผนการรักษา / คำแนะนำ</label>
                            <textarea id="plan" class="form-control" rows="3" placeholder="ให้คำแนะนำการรักษา การดูแลตนเอง หรือข้อควรปฏิบัติ"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ยาสมุนไพรที่แนะนำ</label>
                            <textarea id="herbRecommendation" class="form-control" rows="2" placeholder="เช่น แนะนำให้รับประทานสมุนไพร..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">จำนวนวันรักษา</label>
                                <div class="input-group">
                                    <input id="treatmentDays" type="number" class="form-control" min="1" value="7">
                                    <span class="input-group-text">วัน</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">หมายเหตุเพิ่มเติม</label>
                                <input id="additionalNote" class="form-control" placeholder="หมายเหตุเพิ่มเติม">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - การดำเนินการและนัดหมาย -->
            <div class="col-lg-4">
                <!-- ปุ่มดำเนินการ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-gear me-2"></i> การดำเนินการ
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="saveOPD()">
                                <i class="bi bi-save me-2"></i> บันทึกข้อมูล OPD
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportOPDToPDF()">
                                <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกเป็น PDF
                            </button>
                            
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-receipt me-2"></i> ออกใบเสร็จ
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportReceiptPDF()">ใบเสร็จเต็มหน้า</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportHalfPagePDF()">ใบเสร็จครึ่งหน้า</a></li>
                                </ul>
                            </div>
                            
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-file-text me-2"></i> ออกใบรับรองแพทย์
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportMedicalCertPDF()">ใบรับรองแพทย์เต็มหน้า</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportMedicalCertHalfPage()">ใบรับรองแพทย์ครึ่งหน้า</a></li>
                                </ul>
                            </div>
                            
                            <button class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="bi bi-eraser me-2"></i> ล้างฟอร์ม
                            </button>
                        </div>
                    </div>
                </div>

                <!-- นัดหมาย -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-calendar-plus me-2"></i> นัดหมายครั้งต่อไป
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">วัน/เวลานัดหมาย</label>
                            <input id="appointDate" type="datetime-local" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ประเภทการนัด</label>
                            <select id="appointType" class="form-select">
                                <option value="ตรวจติดตาม">ตรวจติดตาม</option>
                                <option value="ฝังเข็ม">ฝังเข็ม</option>
                                <option value="นวดกดจุด">นวดกดจุด</option>
                                <option value="ครอบแก้ว">ครอบแก้ว</option>
                                <option value="รับยา">รับยา</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <input id="appointNote" class="form-control" placeholder="หมายเหตุเพิ่มเติม">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="saveAppointment()">
                                <i class="bi bi-calendar-check me-2"></i> บันทึกการนัดหมาย
                            </button>
                            <button class="btn btn-outline-secondary" onclick="loadAppointments()">
                                <i class="bi bi-list-ul me-2"></i> ดูการนัดหมายทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- สถิติย่อ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart me-2"></i> สถิติวันนี้
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-number" id="todayPatients">0</div>
                                <div class="stat-label">ผู้ป่วยวันนี้</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-number" id="todayRevenue">0</div>
                                <div class="stat-label">รายได้วันนี้ (บาท)</div>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary w-100" onclick="showPerformanceReport()">
                                    <i class="bi bi-graph-up me-2"></i> ดูรายงานสถิติเต็ม
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Report Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="performance-report">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i> รายงานสถิติและ Performance
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="showMainForm()">
                            <i class="bi bi-arrow-left me-2"></i> กลับหน้าหลัก
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="exportReportPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายงาน
                        </button>
                    </div>
                    <div class="col-md-3">
                        <select id="reportPeriod" class="form-select" onchange="updatePerformanceReport()">
                            <option value="today">วันนี้</option>
                            <option value="week">สัปดาห์นี้</option>
                            <option value="month">เดือนนี้</option>
                            <option value="year">ปีนี้</option>
                            <option value="all">ทั้งหมด</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="doctorSelect" class="form-select" onchange="updatePerformanceReport()">
                            <option value="all">แพทย์ทั้งหมด</option>
                            <option value="dr1">แพทย์หญิง สุนิสา</option>
                            <option value="dr2">แพทย์ชาย อนุชา</option>
                            <option value="dr3">แพทย์หญิง ปิยนุช</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPatients">0</div>
                            <div class="stat-label">จำนวนเคสทั้งหมด</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRevenue">0</div>
                            <div class="stat-label">รายได้ทั้งหมด (บาท)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="avgRevenue">0</div>
                            <div class="stat-label">รายได้เฉลี่ยต่อเคส (บาท)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="topService">-</div>
                            <div class="stat-label">บริการยอดนิยม</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-2"></i> สัดส่วนโรคที่รักษา
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="diseaseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i> รายได้แพทย์
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="doctorRevenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-list-ul me-2"></i> โรคที่พบบ่อย (TOP 5)
                            </div>
                            <div class="card-body">
                                <div id="topDiseasesList">
                                    <div class="text-center text-muted">กำลังโหลดข้อมูล...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-currency-dollar me-2"></i> รายได้แพทย์แต่ละท่าน
                            </div>
                            <div class="card-body">
                                <div id="doctorRevenueList">
                                    <div class="text-center text-muted">กำลังโหลดข้อมูล...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient List Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="patient-list-section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-people me-2"></i> รายชื่อผู้ป่วยทั้งหมด
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="showMainForm()">
                        <i class="bi bi-arrow-left me-1"></i> กลับหน้าหลัก
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input id="patientSearch" class="form-control" placeholder="ค้นหาผู้ป่วย..." oninput="filterPatientList()">
                    </div>
                    <div class="col-md-3">
                        <select id="patientSort" class="form-select" onchange="renderPatientList()">
                            <option value="name">เรียงตามชื่อ</option>
                            <option value="recent">เรียงตามล่าสุด</option>
                            <option value="visits">เรียงตามจำนวนครั้ง</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="exportPatientListPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายชื่อ
                        </button>
                    </div>
                </div>
                
                <div id="patientListContainer" style="max-height: 600px; overflow-y: auto;">
                    <!-- รายชื่อผู้ป่วยจะแสดงที่นี่ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Patient History Section (ซ่อนไว้) -->
    <div class="container my-4 d-none" id="patient-history-section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-clock-history me-2"></i> ประวัติการรักษา
                    <span id="patientHistoryName" class="ms-2 fw-bold"></span>
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="openPatientList()">
                        <i class="bi bi-arrow-left me-1"></i> กลับหน้ารายชื่อ
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="patient-info-box">
                            <h6>ข้อมูลผู้ป่วย</h6>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <div class="info-label">ชื่อ-สกุล</div>
                                    <div class="info-value" id="historyPatientName">-</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="info-label">อายุ</div>
                                    <div class="info-value" id="historyPatientAge">-</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="info-label">เพศ</div>
                                    <div class="info-value" id="historyPatientGender">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">เลขบัตรประชาชน</div>
                                    <div class="info-value" id="historyPatientIdCard">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">เบอร์โทรศัพท์</div>
                                    <div class="info-value" id="historyPatientPhone">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">โรคประจำตัว</div>
                                    <div class="info-value" id="historyPatientChronic">-</div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="info-label">แพ้ยา/อาหาร</div>
                                    <div class="info-value" id="historyPatientAllergy">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i> สถิติผู้ป่วย
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-number" id="historyTotalVisits">0</div>
                                        <div class="stat-label">จำนวนครั้งที่รักษา</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="historyTotalSpent">0</div>
                                        <div class="stat-label">ยอดใช้จ่ายทั้งหมด (บาท)</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-number" id="historyAvgSpent">0</div>
                                        <div class="stat-label">ค่าใช้จ่ายเฉลี่ย (บาท)</div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <div class="stat-label">โรคที่พบบ่อย</div>
                                        <div class="info-value" id="historyCommonDiagnosis">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h5 class="section-title">ประวัติการรักษาทั้งหมด</h5>
                        <div id="patientHistoryList">
                            <!-- ประวัติการรักษาจะแสดงที่นี่ -->
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="createNewVisitForPatient()">
                            <i class="bi bi-plus-circle me-2"></i> สร้างบันทึกการรักษาใหม่
                        </button>
                        <button class="btn btn-outline-success" onclick="exportPatientHistoryPDF()">
                            <i class="bi bi-file-earmark-pdf me-2"></i> ส่งออกรายงานประวัติ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแสดงประวัติ -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ประวัติบันทึก OPD ล่าสุด</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="savedList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแสดงการนัดหมาย -->
    <div class="modal fade" id="appointmentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">การนัดหมายทั้งหมด</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="appointmentList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // เก็บข้อมูลใน localStorage
        const STORAGE_KEY = 'opd_tcm_records';
        const APPOINTMENT_KEY = 'opd_appointments';

        // ตัวแปรเก็บข้อมูลบริการและราคา
        let selectedServices = [];
        let totalCost = 0;
        
        // ตัวแปรสำหรับ Chart
        let diseaseChart = null;
        let doctorRevenueChart = null;
        
        // ตัวแปรสำหรับเก็บข้อมูลผู้ป่วยที่กำลังดูอยู่
        let currentPatientIdCard = null;
        let currentPatientRecords = [];

        // เริ่มต้นเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            // ตั้งค่าวันที่ปัจจุบัน
            const today = new Date();
            document.getElementById('visitDate').value = today.toISOString().split('T')[0];
            
            // ตั้งค่าวันที่นัดหมาย (7 วันข้างหน้า)
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().slice(0, 16);
            document.getElementById('appointDate').value = nextWeekStr;
            
            // ตั้งค่า chip handlers
            attachChipHandlers();
            
            // ตั้งค่า service chip handlers
            attachServiceChipHandlers();
            
            // โหลดข้อมูลเก่า (ถ้ามี)
            renderSavedList();
            loadAppointments();
            
            // อัพเดทใบเสร็จ
            updateReceipt();
            
            // อัพเดทสถิติวันนี้
            updateTodayStats();
            
            // เริ่มกล้องถ่ายรูป
            initCameras();
        });

        // เริ่มกล้องถ่ายรูป
        async function initCameras() {
            try {
                await startTongueCamera();
                await startFaceCamera();
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องได้: ", err);
                // แสดงข้อความเตือน
                document.querySelectorAll('.camera-container').forEach(container => {
                    container.innerHTML = `
                        <div class="d-flex flex-column justify-content-center align-items-center h-100 text-white">
                            <i class="bi bi-camera-video-off" style="font-size: 3rem;"></i>
                            <p class="mt-2">ไม่สามารถเข้าถึงกล้องได้</p>
                            <p class="small">กรุณาอนุญาตการเข้าถึงกล้อง</p>
                        </div>
                    `;
                });
            }
        }

        // เริ่มกล้องลิ้น
        async function startTongueCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                const video = document.getElementById('tongue-camera');
                video.srcObject = stream;
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องได้: ", err);
            }
        }

        // เริ่มกล้องหน้า
        async function startFaceCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user"  // ใช้กล้องหน้า
                    } 
                });
                const video = document.getElementById('face-camera');
                video.srcObject = stream;
            } catch (err) {
                console.log("ไม่สามารถเข้าถึงกล้องได้: ", err);
            }
        }

        // ถ่ายรูปลิ้น
        function captureTongueImage() {
            const video = document.getElementById('tongue-camera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('tongue-image-data').value = imageData;
            
            const preview = document.getElementById('tongue-image-preview');
            preview.src = imageData;
            preview.classList.remove('d-none');
            
            alert('ถ่ายรูปลิ้นสำเร็จ!');
        }

        // ถ่ายรูปหน้า
        function captureFaceImage() {
            const video = document.getElementById('face-camera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('face-image-data').value = imageData;
            
            const preview = document.getElementById('face-image-preview');
            preview.src = imageData;
            preview.classList.remove('d-none');
            
            alert('ถ่ายรูปหน้าสำเร็จ!');
        }

        // จัดการ chip selection
        function attachChipHandlers() {
            // ลักษณะลิ้น
            document.querySelectorAll('#tongueChips .chip').forEach(chip => {
                chip.addEventListener('click', () => chip.classList.toggle('active'));
            });
            
            // ชีพจรแพทย์แผนจีน
            document.querySelectorAll('#pulseChips .chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const value = this.dataset.val;
                    if (value === 'อื่นๆ') {
                        const otherPulseInput = document.getElementById('otherPulse');
                        otherPulseInput.style.display = this.classList.contains('active') ? 'none' : 'block';
                        if (!this.classList.contains('active')) {
                            otherPulseInput.focus();
                        }
                    }
                    this.classList.toggle('active');
                });
            });
        }

        // จัดการ service chip selection
        function attachServiceChipHandlers() {
            document.querySelectorAll('.service-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const service = this.dataset.service;
                    const price = parseInt(this.dataset.price);
                    
                    // ถ้าบริการนี้ถูกเลือกอยู่แล้ว ให้เอาออก
                    if (this.classList.contains('active')) {
                        this.classList.remove('active');
                        selectedServices = selectedServices.filter(s => s.service !== service);
                    } else {
                        // ถ้ายังไม่ถูกเลือก ให้เพิ่มเข้าไป
                        this.classList.add('active');
                        selectedServices.push({
                            service: service,
                            price: price
                        });
                    }
                    
                    // อัพเดทใบเสร็จ
                    updateReceipt();
                });
            });
        }

        // อัพเดทบริการที่กรอกเอง
        function updateCustomService() {
            const service = document.getElementById('otherService').value.trim();
            const price = parseInt(document.getElementById('otherPrice').value) || 0;
            
            if (service && price > 0) {
                // ลบบริการอื่นๆ ที่อาจมีอยู่แล้ว (มีได้เพียงหนึ่งบริการ)
                selectedServices = selectedServices.filter(s => s.service !== 'บริการอื่นๆ');
                
                // เพิ่มบริการใหม่
                selectedServices.push({
                    service: service,
                    price: price
                });
                
                // อัพเดทใบเสร็จ
                updateReceipt();
            }
        }

        // อัพเดทใบเสร็จ
        function updateReceipt() {
            const container = document.getElementById('receiptItems');
            let html = '';
            
            totalCost = 0;
            
            selectedServices.forEach(item => {
                totalCost += item.price;
                html += `
                    <div class="receipt-item">
                        <span>${item.service}</span>
                        <span>${item.price.toLocaleString()} บาท</span>
                    </div>
                `;
            });
            
            if (selectedServices.length === 0) {
                html = '<div class="text-center text-muted py-3">ยังไม่ได้เลือกบริการ</div>';
            }
            
            container.innerHTML = html;
            document.getElementById('totalCost').textContent = totalCost.toLocaleString() + ' บาท';
        }

        // ฟังก์ชันดึงค่าลิ้นที่เลือก
        function getSelectedTongue() {
            return Array.from(document.querySelectorAll('#tongueChips .chip.active'))
                        .map(c => c.dataset.val);
        }

        // ฟังก์ชันดึงค่าชีพจรที่เลือก
        function getSelectedPulse() {
            const selectedChips = Array.from(document.querySelectorAll('#pulseChips .chip.active'))
                                      .map(c => c.dataset.val);
            
            // ถ้ามีเลือก 'อื่นๆ' ให้เพิ่มค่าจาก input
            if (selectedChips.includes('อื่นๆ')) {
                const otherPulse = document.getElementById('otherPulse').value.trim();
                if (otherPulse) {
                    // ลบ 'อื่นๆ' ออกและเพิ่มค่าที่กรอกเอง
                    selectedChips.splice(selectedChips.indexOf('อื่นๆ'), 1);
                    selectedChips.push(otherPulse);
                }
            }
            
            return selectedChips;
        }

        // บันทึกข้อมูล OPD
        function saveOPD() {
            const record = {
                id: Date.now(),
                name: document.getElementById('pname').value.trim(),
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                idCard: document.getElementById('idCard').value,
                phone: document.getElementById('phone').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                chronicDisease: document.getElementById('chronicDisease').value,
                drugAllergy: document.getElementById('drugAllergy').value,
                foodAllergy: document.getElementById('foodAllergy').value,
                bloodPressure: document.getElementById('bloodPressure').value,
                pulse: document.getElementById('pulse').value,
                spo2: document.getElementById('spo2').value,
                temperature: document.getElementById('temperature').value,
                weight: document.getElementById('weight').value,
                visitDate: document.getElementById('visitDate').value,
                visitTime: document.getElementById('visitTime').value,
                symptom: document.getElementById('symptom').value,
                history: document.getElementById('history').value,
                tongueImage: document.getElementById('tongue-image-data').value,
                faceImage: document.getElementById('face-image-data').value,
                tongue: getSelectedTongue(),
                pulseTCM: getSelectedPulse(),
                tcmDiag: document.getElementById('tcmDiag').value,
                westDiag: document.getElementById('westDiag').value,
                plan: document.getElementById('plan').value,
                herbRecommendation: document.getElementById('herbRecommendation').value,
                treatmentDays: document.getElementById('treatmentDays').value,
                services: [...selectedServices],
                totalCost: totalCost,
                additionalNote: document.getElementById('additionalNote').value,
                savedAt: new Date().toLocaleString('th-TH'),
                // เพิ่มข้อมูลแพทย์ (ในระบบจริงอาจดึงจากผู้ใช้ที่ล็อกอิน)
                doctor: document.getElementById('doctorSelect') ? document.getElementById('doctorSelect').value : 'dr1'
            };

            if (!record.name) {
                alert('กรุณากรอกชื่อผู้ป่วย');
                return;
            }

            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการอย่างน้อย 1 รายการ');
                return;
            }

            // ดึงข้อมูลเก่าจาก localStorage
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            records.unshift(record);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));

            alert('บันทึกข้อมูลสำเร็จ!');
            renderSavedList();
            updateTodayStats();
            
            // เคลียร์ฟอร์มบางส่วน (ยกเว้นข้อมูลผู้ป่วย)
            document.getElementById('symptom').value = '';
            document.getElementById('history').value = '';
            document.getElementById('tcmDiag').value = '';
            document.getElementById('westDiag').value = '';
            document.getElementById('plan').value = '';
            document.getElementById('herbRecommendation').value = '';
            document.getElementById('additionalNote').value = '';
            document.getElementById('bloodPressure').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('spo2').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('otherPulse').value = '';
            document.getElementById('otherPulse').style.display = 'none';
            
            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ตบริการอื่นๆ
            document.getElementById('otherService').value = '';
            document.getElementById('otherPrice').value = 0;
            
            // รีเซตรูปภาพ
            document.getElementById('tongue-image-preview').src = '';
            document.getElementById('tongue-image-preview').classList.add('d-none');
            document.getElementById('tongue-image-data').value = '';
            document.getElementById('face-image-preview').src = '';
            document.getElementById('face-image-preview').classList.add('d-none');
            document.getElementById('face-image-data').value = '';
            
            // รีเซตตัวแปร
            selectedServices = [];
            
            // อัพเดทใบเสร็จ
            updateReceipt();
        }

        // แสดงรายการบันทึก
        function renderSavedList() {
            const container = document.getElementById('savedList');
            if (!container) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">ยังไม่มีประวัติผู้ป่วย</div>';
                return;
            }

            let html = '<div class="list-group">';
            records.slice(0, 10).forEach(record => {
                const serviceNames = record.services ? record.services.map(s => s.service).join(', ') : 'ไม่มีข้อมูล';
                const hasTongueImage = record.tongueImage ? '<i class="bi bi-image text-success me-1" title="มีรูปลิ้น"></i>' : '';
                const hasFaceImage = record.faceImage ? '<i class="bi bi-person-bounding-box text-success me-1" title="มีรูปหน้า"></i>' : '';
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${record.name} ${hasTongueImage}${hasFaceImage}</h6>
                            <small class="text-muted">${record.savedAt}</small>
                        </div>
                        <p class="mb-1">
                            <small>อายุ ${record.age} ปี, ${record.gender}</small><br>
                            <small>วินิจฉัย: ${record.tcmDiag || 'ไม่ระบุ'}</small><br>
                            <small>บริการ: ${serviceNames}</small><br>
                            <small>รวม: ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</small>
                        </p>
                        <div class="d-flex justify-content-end gap-1 mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecord(${record.id})">
                                <i class="bi bi-eye"></i> ดู
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportReceiptFromRecord(${record.id})">
                                <i class="bi bi-receipt"></i> เสร็จ
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${record.id})">
                                <i class="bi bi-trash"></i> ลบ
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // โหลดข้อมูลเก่ามาแสดงในฟอร์ม
        function loadRecord(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }

            // เติมข้อมูลลงในฟอร์ม
            document.getElementById('pname').value = record.name;
            document.getElementById('age').value = record.age;
            document.getElementById('gender').value = record.gender;
            document.getElementById('idCard').value = record.idCard || '';
            document.getElementById('phone').value = record.phone || '';
            document.getElementById('emergencyPhone').value = record.emergencyPhone || '';
            document.getElementById('chronicDisease').value = record.chronicDisease || '';
            document.getElementById('drugAllergy').value = record.drugAllergy || '';
            document.getElementById('foodAllergy').value = record.foodAllergy || '';
            document.getElementById('bloodPressure').value = record.bloodPressure || '';
            document.getElementById('pulse').value = record.pulse || '';
            document.getElementById('spo2').value = record.spo2 || '';
            document.getElementById('temperature').value = record.temperature || '';
            document.getElementById('weight').value = record.weight || '';
            document.getElementById('visitDate').value = record.visitDate;
            document.getElementById('visitTime').value = record.visitTime || '09:00';
            document.getElementById('symptom').value = record.symptom;
            document.getElementById('history').value = record.history;
            document.getElementById('tcmDiag').value = record.tcmDiag;
            document.getElementById('westDiag').value = record.westDiag;
            document.getElementById('plan').value = record.plan;
            document.getElementById('herbRecommendation').value = record.herbRecommendation || '';
            document.getElementById('treatmentDays').value = record.treatmentDays || 7;
            document.getElementById('additionalNote').value = record.additionalNote || '';

            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });

            // เลือก chip ลิ้นตามข้อมูลที่บันทึก
            if (record.tongue && Array.isArray(record.tongue)) {
                record.tongue.forEach(tongueVal => {
                    const chip = document.querySelector(`#tongueChips .chip[data-val="${tongueVal}"]`);
                    if (chip) chip.classList.add('active');
                });
            }

            // รีเซ็ต chip selection ชีพจร
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            document.getElementById('otherPulse').style.display = 'none';
            document.getElementById('otherPulse').value = '';

            // เลือก chip ชีพจรตามข้อมูลที่บันทึก
            if (record.pulseTCM && Array.isArray(record.pulseTCM)) {
                record.pulseTCM.forEach(pulseVal => {
                    // ตรวจสอบว่าค่าเป็นค่ามาตรฐานหรือไม่
                    const standardChip = document.querySelector(`#pulseChips .chip[data-val="${pulseVal}"]`);
                    if (standardChip) {
                        standardChip.classList.add('active');
                        if (pulseVal === 'อื่นๆ') {
                            document.getElementById('otherPulse').style.display = 'block';
                        }
                    } else {
                        // ถ้าไม่ใช่ค่ามาตรฐาน ให้เลือก 'อื่นๆ' และใส่ค่าใน input
                        const otherChip = document.querySelector(`#pulseChips .chip[data-val="อื่นๆ"]`);
                        if (otherChip) {
                            otherChip.classList.add('active');
                            document.getElementById('otherPulse').value = pulseVal;
                            document.getElementById('otherPulse').style.display = 'block';
                        }
                    }
                });
            }

            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ตบริการอื่นๆ
            document.getElementById('otherService').value = '';
            document.getElementById('otherPrice').value = 0;

            // โหลดบริการที่บันทึกไว้
            selectedServices = [];
            if (record.services && Array.isArray(record.services)) {
                record.services.forEach(serviceItem => {
                    // หา service chip ที่ตรงกัน
                    const chip = document.querySelector(`.service-chip[data-service="${serviceItem.service}"]`);
                    if (chip) {
                        chip.classList.add('active');
                        selectedServices.push(serviceItem);
                    } else {
                        // ถ้าไม่เจอ chip ที่ตรงกัน แสดงว่าเป็นบริการอื่นๆ
                        document.getElementById('otherService').value = serviceItem.service;
                        document.getElementById('otherPrice').value = serviceItem.price;
                        selectedServices.push(serviceItem);
                    }
                });
            }
            
            // แสดงรูปภาพที่บันทึกไว้
            if (record.tongueImage) {
                document.getElementById('tongue-image-preview').src = record.tongueImage;
                document.getElementById('tongue-image-preview').classList.remove('d-none');
                document.getElementById('tongue-image-data').value = record.tongueImage;
            }
            
            if (record.faceImage) {
                document.getElementById('face-image-preview').src = record.faceImage;
                document.getElementById('face-image-preview').classList.remove('d-none');
                document.getElementById('face-image-data').value = record.faceImage;
            }
            
            // อัพเดทใบเสร็จ
            updateReceipt();

            alert('โหลดข้อมูลสำเร็จ!');
            
            // ปิด modal ถ้ามีการเปิดอยู่
            const modal = bootstrap.Modal.getInstance(document.getElementById('historyModal'));
            if (modal) {
                modal.hide();
            }
        }

        // ลบข้อมูล
        function deleteRecord(id) {
            if (!confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            records = records.filter(r => r.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            
            renderSavedList();
            updateTodayStats();
            alert('ลบข้อมูลสำเร็จ');
        }

        // อัพเดทสถิติวันนี้
        function updateTodayStats() {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const today = new Date().toISOString().split('T')[0];
            
            const todayRecords = records.filter(record => record.visitDate === today);
            const todayPatients = todayRecords.length;
            const todayRevenue = todayRecords.reduce((sum, record) => sum + (record.totalCost || 0), 0);
            
            document.getElementById('todayPatients').textContent = todayPatients;
            document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString();
        }

        // แสดงหน้าหลัก
        function showMainForm() {
            document.getElementById('main-content').classList.remove('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
        }

        // แสดงรายงานสถิติ
        function showPerformanceReport() {
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.remove('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
            updatePerformanceReport();
        }

        // แสดงหน้ารายชื่อผู้ป่วย
        function openPatientList() {
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.remove('d-none');
            document.getElementById('patient-history-section').classList.add('d-none');
            renderPatientList();
        }

        // แสดงหน้ารายละเอียดผู้ป่วย
        function openPatientHistory(idCard) {
            currentPatientIdCard = idCard;
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('performance-report').classList.add('d-none');
            document.getElementById('patient-list-section').classList.add('d-none');
            document.getElementById('patient-history-section').classList.remove('d-none');
            loadPatientHistory(idCard);
        }

        // แสดงรายชื่อผู้ป่วยทั้งหมด
        function renderPatientList() {
            const container = document.getElementById('patientListContainer');
            if (!container) return;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-people display-1 mb-3"></i><p>ยังไม่มีข้อมูลผู้ป่วย</p></div>';
                return;
            }
            
            // จัดกลุ่มผู้ป่วยตามเลขบัตรประชาชน
            const patients = {};
            records.forEach(record => {
                const idCard = record.idCard || 'ไม่ระบุ';
                if (!patients[idCard]) {
                    patients[idCard] = {
                        name: record.name,
                        age: record.age,
                        gender: record.gender,
                        phone: record.phone,
                        idCard: idCard,
                        totalVisits: 0,
                        totalSpent: 0,
                        lastVisit: record.savedAt,
                        diagnoses: []
                    };
                }
                
                patients[idCard].totalVisits++;
                patients[idCard].totalSpent += record.totalCost || 0;
                if (record.tcmDiag && !patients[idCard].diagnoses.includes(record.tcmDiag)) {
                    patients[idCard].diagnoses.push(record.tcmDiag);
                }
                
                // เก็บวันที่ล่าสุด
                const recordDate = new Date(record.savedAt);
                const currentLastDate = new Date(patients[idCard].lastVisit);
                if (recordDate > currentLastDate) {
                    patients[idCard].lastVisit = record.savedAt;
                }
            });
            
            // แปลงเป็นอาร์เรย์และเรียงลำดับ
            const patientArray = Object.values(patients);
            const sortBy = document.getElementById('patientSort').value;
            
            if (sortBy === 'name') {
                patientArray.sort((a, b) => a.name.localeCompare(b.name, 'th'));
            } else if (sortBy === 'recent') {
                patientArray.sort((a, b) => new Date(b.lastVisit) - new Date(a.lastVisit));
            } else if (sortBy === 'visits') {
                patientArray.sort((a, b) => b.totalVisits - a.totalVisits);
            }
            
            // กรองตามคำค้นหา
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const filteredPatients = searchTerm ? 
                patientArray.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.idCard && p.idCard.includes(searchTerm)) ||
                    (p.phone && p.phone.includes(searchTerm))
                ) : patientArray;
            
            let html = '<div class="row">';
            filteredPatients.forEach(patient => {
                const diagnosisText = patient.diagnoses.length > 0 ? 
                    patient.diagnoses.slice(0, 2).join(', ') + (patient.diagnoses.length > 2 ? '...' : '') : 
                    'ไม่ระบุ';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${patient.name}</h6>
                                <p class="card-text small">
                                    <i class="bi bi-person me-1"></i> ${patient.age} ปี, ${patient.gender}<br>
                                    <i class="bi bi-card-text me-1"></i> ${patient.idCard || 'ไม่ระบุ'}<br>
                                    <i class="bi bi-telephone me-1"></i> ${patient.phone || 'ไม่ระบุ'}<br>
                                    <i class="bi bi-calendar-check me-1"></i> รักษา ${patient.totalVisits} ครั้ง<br>
                                    <i class="bi bi-cash-coin me-1"></i> ใช้จ่าย ${patient.totalSpent.toLocaleString()} บาท<br>
                                    <i class="bi bi-clipboard-pulse me-1"></i> ${diagnosisText}
                                </p>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openPatientHistory('${patient.idCard}')">
                                        <i class="bi bi-clock-history"></i> ประวัติ
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="loadPatientToForm('${patient.idCard}')">
                                        <i class="bi bi-plus-circle"></i> บันทึกใหม่
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            if (filteredPatients.length === 0) {
                html = '<div class="text-center text-muted p-5"><i class="bi bi-search display-1 mb-3"></i><p>ไม่พบผู้ป่วยที่ตรงกับการค้นหา</p></div>';
            }
            
            container.innerHTML = html;
        }

        // กรองรายชื่อผู้ป่วย
        function filterPatientList() {
            renderPatientList();
        }

        // โหลดข้อมูลผู้ป่วยลงในฟอร์ม
        function loadPatientToForm(idCard) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const patientRecords = records.filter(r => r.idCard === idCard);
            
            if (patientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            // ใช้ข้อมูลล่าสุดของผู้ป่วย
            const latestRecord = patientRecords[0];
            
            // เติมข้อมูลพื้นฐานลงในฟอร์ม
            document.getElementById('pname').value = latestRecord.name;
            document.getElementById('age').value = latestRecord.age;
            document.getElementById('gender').value = latestRecord.gender;
            document.getElementById('idCard').value = latestRecord.idCard || '';
            document.getElementById('phone').value = latestRecord.phone || '';
            document.getElementById('emergencyPhone').value = latestRecord.emergencyPhone || '';
            document.getElementById('chronicDisease').value = latestRecord.chronicDisease || '';
            document.getElementById('drugAllergy').value = latestRecord.drugAllergy || '';
            document.getElementById('foodAllergy').value = latestRecord.foodAllergy || '';
            
            // กลับไปที่หน้าหลัก
            showMainForm();
            
            alert(`โหลดข้อมูลผู้ป่วย ${latestRecord.name} เรียบร้อยแล้ว`);
        }

        // โหลดประวัติผู้ป่วย
        function loadPatientHistory(idCard) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            currentPatientRecords = records.filter(r => r.idCard === idCard).sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
            
            if (currentPatientRecords.length === 0) {
                alert('ไม่พบประวัติผู้ป่วย');
                return;
            }
            
            const patient = currentPatientRecords[0];
            
            // แสดงชื่อผู้ป่วยในหัวข้อ
            document.getElementById('patientHistoryName').textContent = patient.name;
            document.getElementById('historyPatientName').textContent = patient.name;
            document.getElementById('historyPatientAge').textContent = `${patient.age} ปี`;
            document.getElementById('historyPatientGender').textContent = patient.gender;
            document.getElementById('historyPatientIdCard').textContent = patient.idCard || 'ไม่ระบุ';
            document.getElementById('historyPatientPhone').textContent = patient.phone || 'ไม่ระบุ';
            document.getElementById('historyPatientChronic').textContent = patient.chronicDisease || 'ไม่มี';
            document.getElementById('historyPatientAllergy').textContent = 
                `${patient.drugAllergy || 'ไม่มี'} / ${patient.foodAllergy || 'ไม่มี'}`;
            
            // คำนวณสถิติ
            const totalVisits = currentPatientRecords.length;
            const totalSpent = currentPatientRecords.reduce((sum, r) => sum + (r.totalCost || 0), 0);
            const avgSpent = totalVisits > 0 ? Math.round(totalSpent / totalVisits) : 0;
            
            // หาโรคที่พบบ่อย
            const diagnosisCount = {};
            currentPatientRecords.forEach(r => {
                if (r.tcmDiag) {
                    diagnosisCount[r.tcmDiag] = (diagnosisCount[r.tcmDiag] || 0) + 1;
                }
            });
            
            const commonDiagnosis = Object.entries(diagnosisCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([diag, count]) => `${diag} (${count} ครั้ง)`)
                .join(', ');
            
            // อัพเดทสถิติ
            document.getElementById('historyTotalVisits').textContent = totalVisits;
            document.getElementById('historyTotalSpent').textContent = totalSpent.toLocaleString();
            document.getElementById('historyAvgSpent').textContent = avgSpent.toLocaleString();
            document.getElementById('historyCommonDiagnosis').textContent = commonDiagnosis || 'ไม่ระบุ';
            
            // แสดงประวัติการรักษา
            const historyContainer = document.getElementById('patientHistoryList');
            let historyHTML = '';
            
            currentPatientRecords.forEach((record, index) => {
                const services = record.services ? record.services.map(s => s.service).join(', ') : 'ไม่ระบุ';
                
                historyHTML += `
                    <div class="patient-history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="patient-history-date">
                                    ${record.visitDate} ${record.visitTime || ''}
                                </div>
                                <div class="patient-history-diagnosis mb-2">
                                    <strong>วินิจฉัย:</strong> ${record.tcmDiag || 'ไม่ระบุ'}
                                </div>
                                <div class="patient-history-services mb-2">
                                    <strong>บริการ:</strong> ${services}
                                </div>
                                <div class="mb-2">
                                    <strong>ค่าใช้จ่าย:</strong> ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท
                                </div>
                                ${record.symptom ? `<div class="mb-1"><small><strong>อาการ:</strong> ${record.symptom.substring(0, 100)}${record.symptom.length > 100 ? '...' : ''}</small></div>` : ''}
                            </div>
                            <div class="d-flex flex-column gap-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewRecordDetails(${record.id})">
                                    <i class="bi bi-eye"></i> ดูรายละเอียด
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                    <i class="bi bi-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        // ดูรายละเอียดบันทึก
        function viewRecordDetails(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            // สร้าง modal เพื่อแสดงรายละเอียด
            const modalHTML = `
                <div class="modal fade" id="recordDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">รายละเอียดบันทึกการรักษา</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>ข้อมูลผู้ป่วย</h6>
                                        <p><strong>ชื่อ:</strong> ${record.name}</p>
                                        <p><strong>อายุ/เพศ:</strong> ${record.age} ปี / ${record.gender}</p>
                                        <p><strong>วันที่ตรวจ:</strong> ${record.visitDate} ${record.visitTime || ''}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>บริการและค่าใช้จ่าย</h6>
                                        ${record.services ? record.services.map(s => `<p>${s.service}: ${s.price} บาท</p>`).join('') : ''}
                                        <p><strong>รวม:</strong> ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>อาการและการวินิจฉัย</h6>
                                        <p><strong>อาการสำคัญ:</strong> ${record.symptom || 'ไม่ระบุ'}</p>
                                        <p><strong>วินิจฉัย TCM:</strong> ${record.tcmDiag || 'ไม่ระบุ'}</p>
                                        <p><strong>วินิจฉัย Western:</strong> ${record.westDiag || 'ไม่ระบุ'}</p>
                                        <p><strong>แผนการรักษา:</strong> ${record.plan || 'ไม่ระบุ'}</p>
                                    </div>
                                </div>
                                ${record.tongueImage || record.faceImage ? `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>รูปภาพ</h6>
                                        <div class="row">
                                            ${record.tongueImage ? `<div class="col-md-6"><p><strong>รูปลิ้น:</strong></p><img src="${record.tongueImage}" class="img-fluid" style="max-height: 200px;"></div>` : ''}
                                            ${record.faceImage ? `<div class="col-md-6"><p><strong>รูปหน้า:</strong></p><img src="${record.faceImage}" class="img-fluid" style="max-height: 200px;"></div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                                <button type="button" class="btn btn-primary" onclick="loadRecord(${record.id})">โหลดลงฟอร์ม</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // เพิ่ม modal ลงใน DOM
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
            
            // แสดง modal
            const modal = new bootstrap.Modal(document.getElementById('recordDetailsModal'));
            modal.show();
            
            // ลบ modal เมื่อปิด
            document.getElementById('recordDetailsModal').addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modalDiv);
            });
        }

        // สร้างบันทึกใหม่สำหรับผู้ป่วยคนนี้
        function createNewVisitForPatient() {
            if (!currentPatientIdCard || currentPatientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            const patient = currentPatientRecords[0];
            
            // เติมข้อมูลผู้ป่วยลงในฟอร์ม
            document.getElementById('pname').value = patient.name;
            document.getElementById('age').value = patient.age;
            document.getElementById('gender').value = patient.gender;
            document.getElementById('idCard').value = patient.idCard || '';
            document.getElementById('phone').value = patient.phone || '';
            document.getElementById('emergencyPhone').value = patient.emergencyPhone || '';
            document.getElementById('chronicDisease').value = patient.chronicDisease || '';
            document.getElementById('drugAllergy').value = patient.drugAllergy || '';
            document.getElementById('foodAllergy').value = patient.foodAllergy || '';
            
            // ตั้งค่าวันที่ปัจจุบัน
            const today = new Date();
            document.getElementById('visitDate').value = today.toISOString().split('T')[0];
            
            // กลับไปที่หน้าหลัก
            showMainForm();
            
            alert(`เตรียมฟอร์มสำหรับบันทึกใหม่ของ ${patient.name} เรียบร้อยแล้ว`);
        }

        // ส่งออกรายชื่อผู้ป่วยเป็น PDF
        function exportPatientListPDF() {
            const element = document.createElement('div');
            element.innerHTML = generatePatientListPDFContent();
            
            const opt = {
                margin: 10,
                filename: `รายชื่อผู้ป่วย_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // ส่งออกรายงานประวัติผู้ป่วยเป็น PDF
        function exportPatientHistoryPDF() {
            if (currentPatientRecords.length === 0) {
                alert('ไม่พบข้อมูลผู้ป่วย');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generatePatientHistoryPDFContent();
            
            const patient = currentPatientRecords[0];
            const opt = {
                margin: 10,
                filename: `ประวัติผู้ป่วย_${patient.name}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // ฟังก์ชันสำหรับใบเสร็จและใบรับรองแพทย์
        function exportReceiptPDF() {
            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการก่อนออกใบเสร็จ');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generateReceiptContent();
            
            const opt = {
                margin: 10,
                filename: `ใบเสร็จ_${document.getElementById('pname').value || 'ผู้ป่วย'}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportHalfPagePDF() {
            if (selectedServices.length === 0) {
                alert('กรุณาเลือกบริการก่อนออกใบเสร็จ');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generateReceiptContentHalfPage();
            
            const opt = {
                margin: 5,
                filename: `ใบเสร็จ_ครึ่งหน้า_${document.getElementById('pname').value || 'ผู้ป่วย'}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportReceiptFromRecord(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generateReceiptContentFromRecord(record);
            
            const opt = {
                margin: 10,
                filename: `ใบเสร็จ_${record.name}_${record.visitDate || 'ไม่มีวันที่'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportMedicalCertPDF() {
            const patientName = document.getElementById('pname').value;
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบรับรองแพทย์');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generateMedicalCertContent();
            
            const opt = {
                margin: 10,
                filename: `ใบรับรองแพทย์_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportMedicalCertHalfPage() {
            const patientName = document.getElementById('pname').value;
            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนออกใบรับรองแพทย์');
                return;
            }
            
            const element = document.createElement('div');
            element.innerHTML = generateMedicalCertContentHalfPage();
            
            const opt = {
                margin: 5,
                filename: `ใบรับรองแพทย์_ครึ่งหน้า_${patientName}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportRecordPDF(id) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const record = records.find(r => r.id === id);
            
            if (!record) {
                alert('ไม่พบข้อมูล');
                return;
            }

            const element = document.createElement('div');
            element.innerHTML = generatePDFContentFromRecord(record);
            
            const opt = {
                margin: 10,
                filename: `OPD_TCM_${record.name}_${record.visitDate || 'ไม่มีวันที่'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // สร้างเนื้อหาใบเสร็จ (เต็มหน้า)
        function generateReceiptContent() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            selectedServices.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${item.service}</td>
                        <td style="padding: 8px 0; text-align: right; border-bottom: 1px solid #eee;">${item.price.toLocaleString()} บาท</td>
                    </tr>
                `;
            });
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 25px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">ใบเสร็จรับเงิน</h2>
                        <h4 style="color: #333; margin-bottom: 15px;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</h4>
                        <p style="color: #777;">ที่อยู่: 3218/143 ถ.มิตรภาพ ต.ในเมือง อ.เมือง จ.นครราชสีมา 30000</p>
                        <p style="color: #777;">โทรศัพท์: 095-2522619</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <table style="width: 100%; margin-bottom: 20px;">
                            <tr>
                                <td style="width: 40%; padding: 8px 0;"><strong>ชื่อผู้ป่วย:</strong></td>
                                <td style="padding: 8px 0;">${document.getElementById('pname').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>วันที่:</strong></td>
                                <td style="padding: 8px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>เลขที่ใบเสร็จ:</strong></td>
                                <td style="padding: 8px 0;">RCP${Date.now().toString().slice(-6)}</td>
                            </tr>
                        </table>
                        
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #6c5ce7; padding-bottom: 8px; margin-top: 25px;">รายการบริการ</h4>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="padding: 10px 0; border-bottom: 2px solid #333; text-align: left;">รายการ</th>
                                    <th style="padding: 10px 0; border-bottom: 2px solid #333; text-align: right;">ราคา</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td style="padding: 15px 0; text-align: right; font-weight: 700; border-top: 2px solid #333;">รวมทั้งสิ้น:</td>
                                    <td style="padding: 15px 0; text-align: right; font-weight: 700; border-top: 2px solid #333;">${totalCost.toLocaleString()} บาท</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9ff; border-radius: 8px;">
                        <p><strong>หมายเหตุ:</strong> ${document.getElementById('additionalNote').value || 'ขอบคุณที่ใช้บริการ'}</p>
                    </div>
                    
                    <div style="margin-top: 50px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ผู้รับเงิน</p>
                                </td>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ผู้จ่ายเงิน</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; font-size: 12px; color: #777; text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
                        <p>ใบเสร็จรับเงินนี้เป็นหลักฐานการชำระเงินที่ถูกต้องตามกฎหมาย</p>
                        <p>กรุณาเก็บใบเสร็จนี้ไว้เพื่อแสดงเป็นหลักฐานในภายหลัง</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาใบเสร็จ (ครึ่งหน้า)
        function generateReceiptContentHalfPage() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            selectedServices.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 5px 0; font-size: 12px; border-bottom: 1px solid #eee;">${item.service}</td>
                        <td style="padding: 5px 0; font-size: 12px; text-align: right; border-bottom: 1px solid #eee;">${item.price.toLocaleString()} บาท</td>
                    </tr>
                `;
            });
            
            return `
                <div class="half-page-pdf" style="font-family: 'Sarabun', sans-serif; padding: 15px; border: 1px solid #ddd;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="color: #6c5ce7; margin-bottom: 3px; font-size: 18px;">ใบเสร็จรับเงิน</h3>
                        <h4 style="color: #333; margin-bottom: 8px; font-size: 14px;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</h4>
                        <p style="color: #777; font-size: 10px; margin-bottom: 3px;">ที่อยู่: 3218/143 ถ.มิตรภาพ ต.ในเมือง อ.เมือง จ.นครราชสีมา 30000</p>
                        <p style="color: #777; font-size: 10px;">โทรศัพท์: 095-2522619</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <table style="width: 100%; margin-bottom: 10px; font-size: 12px;">
                            <tr>
                                <td style="width: 40%; padding: 4px 0;"><strong>ชื่อผู้ป่วย:</strong></td>
                                <td style="padding: 4px 0;">${document.getElementById('pname').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0;"><strong>วันที่:</strong></td>
                                <td style="padding: 4px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0;"><strong>เลขที่ใบเสร็จ:</strong></td>
                                <td style="padding: 4px 0;">RCP${Date.now().toString().slice(-6)}</td>
                            </tr>
                        </table>
                        
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #6c5ce7; padding-bottom: 5px; margin-top: 15px; font-size: 14px;">รายการบริการ</h4>
                        <table style="width: 100%; font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="padding: 6px 0; border-bottom: 1px solid #333; text-align: left; font-size: 12px;">รายการ</th>
                                    <th style="padding: 6px 0; border-bottom: 1px solid #333; text-align: right; font-size: 12px;">ราคา</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td style="padding: 10px 0; text-align: right; font-weight: 700; border-top: 2px solid #333; font-size: 14px;">รวมทั้งสิ้น:</td>
                                    <td style="padding: 10px 0; text-align: right; font-weight: 700; border-top: 2px solid #333; font-size: 14px;">${totalCost.toLocaleString()} บาท</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9ff; border-radius: 5px; font-size: 11px;">
                        <p><strong>หมายเหตุ:</strong> ${document.getElementById('additionalNote').value || 'ขอบคุณที่ใช้บริการ'}</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <table style="width: 100%; font-size: 11px;">
                            <tr>
                                <td style="width: 50%; text-align: center;">
                                    <p>___________________</p>
                                    <p>ผู้รับเงิน</p>
                                </td>
                                <td style="width: 50%; text-align: center;">
                                    <p>___________________</p>
                                    <p>ผู้จ่ายเงิน</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาใบเสร็จจากข้อมูลที่บันทึก
        function generateReceiptContentFromRecord(record) {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let servicesHTML = '';
            record.services.forEach(item => {
                servicesHTML += `
                    <tr>
                        <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${item.service}</td>
                        <td style="padding: 8px 0; text-align: right; border-bottom: 1px solid #eee;">${item.price.toLocaleString()} บาท</td>
                    </tr>
                `;
            });
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 25px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">ใบเสร็จรับเงิน</h2>
                        <h4 style="color: #333; margin-bottom: 15px;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</h4>
                        <p style="color: #777;">ที่อยู่: 3218/143 ถ.มิตรภาพ ต.ในเมือง อ.เมือง จ.นครราชสีมา 30000</p>
                        <p style="color: #777;">โทรศัพท์: 095-2522619</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <table style="width: 100%; margin-bottom: 20px;">
                            <tr>
                                <td style="width: 40%; padding: 8px 0;"><strong>ชื่อผู้ป่วย:</strong></td>
                                <td style="padding: 8px 0;">${record.name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>วันที่ตรวจ:</strong></td>
                                <td style="padding: 8px 0;">${record.visitDate || '-'} ${record.visitTime || ''}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>วันที่ออกใบเสร็จ:</strong></td>
                                <td style="padding: 8px 0;">${formattedDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;"><strong>เลขที่ใบเสร็จ:</strong></td>
                                <td style="padding: 8px 0;">RCP${record.id.toString().slice(-6)}</td>
                            </tr>
                        </table>
                        
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #6c5ce7; padding-bottom: 8px; margin-top: 25px;">รายการบริการ</h4>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="padding: 10px 0; border-bottom: 2px solid #333; text-align: left;">รายการ</th>
                                    <th style="padding: 10px 0; border-bottom: 2px solid #333; text-align: right;">ราคา</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicesHTML}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td style="padding: 15px 0; text-align: right; font-weight: 700; border-top: 2px solid #333;">รวมทั้งสิ้น:</td>
                                    <td style="padding: 15px 0; text-align: right; font-weight: 700; border-top: 2px solid #333;">${record.totalCost.toLocaleString()} บาท</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9ff; border-radius: 8px;">
                        <p><strong>หมายเหตุ:</strong> ${record.additionalNote || 'ขอบคุณที่ใช้บริการ'}</p>
                    </div>
                    
                    <div style="margin-top: 50px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ผู้รับเงิน</p>
                                </td>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ผู้จ่ายเงิน</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; font-size: 12px; color: #777; text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
                        <p>ใบเสร็จรับเงินนี้เป็นหลักฐานการชำระเงินที่ถูกต้องตามกฎหมาย</p>
                        <p>กรุณาเก็บใบเสร็จนี้ไว้เพื่อแสดงเป็นหลักฐานในภายหลัง</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาภาครับรองแพทย์ (เต็มหน้า)
        function generateMedicalCertContent() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 30px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="color: #6c5ce7; margin-bottom: 5px;">ใบรับรองแพทย์</h1>
                        <h3 style="color: #333; margin-bottom: 20px;">Medical Certificate</h3>
                        <p style="color: #777;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</p>
                        <p style="color: #777;">ที่อยู่: 3218/143 ถ.มิตรภาพ ต.ในเมือง อ.เมือง จ.นครราชสีมา 30000 โทรศัพท์: 095-2522619</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <p style="text-indent: 50px;">
                            ข้าพเจ้าได้ตรวจผู้ป่วย <strong>${document.getElementById('pname').value || '_________________'}</strong> 
                            อายุ <strong>${document.getElementById('age').value || '___'}</strong> ปี 
                            เพศ <strong>${document.getElementById('gender').value || '___'}</strong> 
                            เมื่อวันที่ <strong>${document.getElementById('visitDate').value || '_________________'}</strong>
                        </p>
                        
                        <p style="text-indent: 50px; margin-top: 20px;">
                            ผลการตรวจพบว่า: ${document.getElementById('symptom').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 50px; margin-top: 20px;">
                            วินิจฉัย: ${document.getElementById('tcmDiag').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 50px; margin-top: 20px;">
                            ให้การรักษาโดย: ${document.getElementById('plan').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 50px; margin-top: 20px;">
                            ควรพักรักษาตัวเป็นเวลา: <strong>${document.getElementById('treatmentDays').value || '___'}</strong> วัน
                            ตั้งแต่วันที่ <strong>${formattedDate}</strong>
                        </p>
                    </div>
                    
                    <div style="margin-top: 80px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 60%;"></td>
                                <td style="text-align: center;">
                                    <p>ลงชื่อ ___________________________</p>
                                    <p>(แพทย์ผู้ออกใบรับรอง)</p>
                                    <p>ใบรับรองแพทย์ฉบับนี้มีอายุ 30 วัน นับจากวันที่ออกให้</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 50px; font-size: 12px; color: #777; border-top: 1px solid #eee; padding-top: 10px;">
                        <p>หมายเหตุ: ใบรับรองแพทย์นี้ใช้สำหรับแสดงต่อนายจ้างหรือหน่วยงานราชการเท่านั้น</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหาภาครับรองแพทย์ (ครึ่งหน้า)
        function generateMedicalCertContentHalfPage() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            return `
                <div class="half-page-pdf" style="font-family: 'Sarabun', sans-serif; padding: 15px; border: 1px solid #ddd;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 3px; font-size: 18px;">ใบรับรองแพทย์</h2>
                        <h3 style="color: #333; margin-bottom: 8px; font-size: 14px;">Medical Certificate</h3>
                        <p style="color: #777; font-size: 10px;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</p>
                        <p style="color: #777; font-size: 10px;">ที่อยู่: 3218/143 ถ.มิตรภาพ ต.ในเมือง อ.เมือง จ.นครราชสีมา 30000 โทรศัพท์: 095-2522619</p>
                    </div>
                    
                    <div style="margin-bottom: 15px; font-size: 12px;">
                        <p style="text-indent: 30px;">
                            ข้าพเจ้าได้ตรวจผู้ป่วย <strong>${document.getElementById('pname').value || '_________________'}</strong> 
                            อายุ <strong>${document.getElementById('age').value || '___'}</strong> ปี 
                            เพศ <strong>${document.getElementById('gender').value || '___'}</strong> 
                            เมื่อวันที่ <strong>${document.getElementById('visitDate').value || '_________________'}</strong>
                        </p>
                        
                        <p style="text-indent: 30px; margin-top: 10px;">
                            ผลการตรวจพบว่า: ${document.getElementById('symptom').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 30px; margin-top: 10px;">
                            วินิจฉัย: ${document.getElementById('tcmDiag').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 30px; margin-top: 10px;">
                            ให้การรักษาโดย: ${document.getElementById('plan').value || '____________________________________________________________'}
                        </p>
                        
                        <p style="text-indent: 30px; margin-top: 10px;">
                            ควรพักรักษาตัวเป็นเวลา: <strong>${document.getElementById('treatmentDays').value || '___'}</strong> วัน
                            ตั้งแต่วันที่ <strong>${formattedDate}</strong>
                        </p>
                    </div>
                    
                    <div style="margin-top: 30px; font-size: 11px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%;"></td>
                                <td style="text-align: center;">
                                    <p>ลงชื่อ ___________________</p>
                                    <p>(แพทย์ผู้ออกใบรับรอง)</p>
                                    <p style="font-size: 9px;">ใบรับรองแพทย์ฉบับนี้มีอายุ 30 วัน</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 9px; color: #777; border-top: 1px solid #eee; padding-top: 8px;">
                        <p>หมายเหตุ: ใบรับรองแพทย์นี้ใช้สำหรับแสดงต่อนายจ้างหรือหน่วยงานราชการเท่านั้น</p>
                    </div>
                </div>
            `;
        }

        // สร้างเนื้อหา PDF จากข้อมูลที่บันทึก
        function generatePDFContentFromRecord(record) {
            const tongue = Array.isArray(record.tongue) ? record.tongue.join(', ') : record.tongue;
            const pulseTCM = Array.isArray(record.pulseTCM) ? record.pulseTCM.join(', ') : record.pulseTCM;
            const servicesList = record.services ? record.services.map(s => `${s.service} (${s.price} บาท)`).join(', ') : 'ไม่มีข้อมูล';
            
            let imagesHTML = '';
            if (record.tongueImage) {
                imagesHTML += `<p><strong>รูปลิ้น:</strong></p><img src="${record.tongueImage}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; margin-bottom: 10px;">`;
            }
            if (record.faceImage) {
                imagesHTML += `<p><strong>รูปหน้า:</strong></p><img src="${record.faceImage}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd;">`;
            }
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">บันทึกการตรวจ OPD แพทย์แผนจีน</h2>
                        <p style="color: #777;">บันทึกเมื่อ: ${record.savedAt}</p>
                    </div>
                    
                    ${imagesHTML ? `<div style="margin-bottom: 25px;">${imagesHTML}</div>` : ''}
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">ข้อมูลผู้ป่วย</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr>
                                <td style="width: 25%; padding: 8px 0; vertical-align: top;"><strong>ชื่อ-สกุล:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.name || '-'}</td>
                                <td style="width: 25%; padding: 8px 0; vertical-align: top;"><strong>อายุ/เพศ:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.age || '-'} ปี / ${record.gender || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>เลขบัตรประชาชน:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.idCard || '-'}</td>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>โทรศัพท์:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.phone || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>โทรฉุกเฉิน:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.emergencyPhone || '-'}</td>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>โรคประจำตัว:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.chronicDisease || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>แพ้ยา:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.drugAllergy || '-'}</td>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>แพ้อาหาร:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${record.foodAllergy || '-'}</td>
                            </tr>
                        </table>
                        
                        <h5 style="color: #555; margin-top: 15px; margin-bottom: 10px;">ข้อมูลชีพจรและอาการทางกาย</h5>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr>
                                <td style="width: 20%; padding: 6px 0;"><strong>BP:</strong></td>
                                <td style="width: 30%; padding: 6px 0;">${record.bloodPressure || '-'} mmHg</td>
                                <td style="width: 20%; padding: 6px 0;"><strong>ชีพจร:</strong></td>
                                <td style="width: 30%; padding: 6px 0;">${record.pulse || '-'} ครั้ง/นาที</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px 0;"><strong>SpO2:</strong></td>
                                <td style="padding: 6px 0;">${record.spo2 || '-'} %</td>
                                <td style="padding: 6px 0;"><strong>อุณหภูมิ:</strong></td>
                                <td style="padding: 6px 0;">${record.temperature || '-'} °C</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px 0;"><strong>น้ำหนัก:</strong></td>
                                <td style="padding: 6px 0;">${record.weight || '-'} kg</td>
                                <td style="padding: 6px 0;"><strong>วันที่ตรวจ:</strong></td>
                                <td style="padding: 6px 0;">${record.visitDate || '-'} ${record.visitTime || ''}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">อาการและการวินิจฉัย</h4>
                        <p><strong>อาการสำคัญ(主诉):</strong> ${record.symptom || '-'}</p>
                        <p><strong>ประวัติที่เกี่ยวข้อง(现病史):</strong> ${record.history || '-'}</p>
                        <p><strong>ลักษณะลิ้น:</strong> ${tongue || '-'}</p>
                        <p><strong>ชีพจร(แพทย์แผนจีน):</strong> ${pulseTCM || '-'}</p>
                        <p><strong>วินิจฉัย TCM:</strong> ${record.tcmDiag || '-'}</p>
                        <p><strong>วินิจฉัยสากล:</strong> ${record.westDiag || '-'}</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">บริการและค่าใช้จ่าย</h4>
                        <p><strong>บริการที่ได้รับ:</strong> ${servicesList || '-'}</p>
                        <p><strong>รวมค่าใช้จ่าย:</strong> ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">แผนการรักษา</h4>
                        <p><strong>แผนการรักษา/คำแนะนำ:</strong> ${record.plan || '-'}</p>
                        <p><strong>ยาสมุนไพรที่แนะนำ:</strong> ${record.herbRecommendation || '-'}</p>
                        <p><strong>จำนวนวันรักษา:</strong> ${record.treatmentDays || 0} วัน</p>
                        <p><strong>หมายเหตุ:</strong> ${record.additionalNote || '-'}</p>
                    </div>
                    
                    <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 15px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ลายเซ็นแพทย์</p>
                                </td>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ลายเซ็นผู้ป่วย/ผู้ปกครอง</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // ส่งออกเป็น PDF (บันทึกการตรวจ) - มีเพิ่มรูปภาพ
        function exportOPDToPDF() {
            const tongueImage = document.getElementById('tongue-image-data').value;
            const faceImage = document.getElementById('face-image-data').value;
            const tongue = getSelectedTongue().join(', ');
            const pulseTCM = getSelectedPulse().join(', ');
            const servicesList = selectedServices.map(s => `${s.service} (${s.price} บาท)`).join(', ');
            
            let imagesHTML = '';
            if (tongueImage) {
                imagesHTML += `<p><strong>รูปลิ้น:</strong></p><img src="${tongueImage}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; margin-bottom: 10px;">`;
            }
            if (faceImage) {
                imagesHTML += `<p><strong>รูปหน้า:</strong></p><img src="${faceImage}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd;">`;
            }
            
            const element = document.createElement('div');
            element.innerHTML = `
                <div style="font-family: 'Sarabun', sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">บันทึกการตรวจ OPD แพทย์แผนจีน</h2>
                        <p style="color: #777;">${document.getElementById('visitDate').value} ${document.getElementById('visitTime').value || ''}</p>
                    </div>
                    
                    ${imagesHTML ? `<div style="margin-bottom: 25px;">${imagesHTML}</div>` : ''}
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">ข้อมูลผู้ป่วย</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr>
                                <td style="width: 25%; padding: 8px 0; vertical-align: top;"><strong>ชื่อ-สกุล:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('pname').value || '-'}</td>
                                <td style="width: 25%; padding: 8px 0; vertical-align: top;"><strong>อายุ/เพศ:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('age').value || '-'} ปี / ${document.getElementById('gender').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>เลขบัตรประชาชน:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('idCard').value || '-'}</td>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>โทรศัพท์:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('phone').value || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>โรคประจำตัว:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('chronicDisease').value || '-'}</td>
                                <td style="padding: 8px 0; vertical-align: top;"><strong>แพ้ยา:</strong></td>
                                <td style="padding: 8px 0; vertical-align: top;">${document.getElementById('drugAllergy').value || '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">อาการและการวินิจฉัย</h4>
                        <p><strong>อาการสำคัญ(主诉):</strong> ${document.getElementById('symptom').value || '-'}</p>
                        <p><strong>ประวัติที่เกี่ยวข้อง(现病史):</strong> ${document.getElementById('history').value || '-'}</p>
                        <p><strong>ลักษณะลิ้น:</strong> ${tongue || '-'}</p>
                        <p><strong>ชีพจร(แพทย์แผนจีน):</strong> ${pulseTCM || '-'}</p>
                        <p><strong>วินิจฉัย TCM:</strong> ${document.getElementById('tcmDiag').value || '-'}</p>
                        <p><strong>วินิจฉัยสากล:</strong> ${document.getElementById('westDiag').value || '-'}</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">บริการและค่าใช้จ่าย</h4>
                        <p><strong>บริการที่ได้รับ:</strong> ${servicesList || '-'}</p>
                        <p><strong>รวมค่าใช้จ่าย:</strong> ${totalCost.toLocaleString()} บาท</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 8px;">แผนการรักษา</h4>
                        <p><strong>แผนการรักษา/คำแนะนำ:</strong> ${document.getElementById('plan').value || '-'}</p>
                        <p><strong>ยาสมุนไพรที่แนะนำ:</strong> ${document.getElementById('herbRecommendation').value || '-'}</p>
                        <p><strong>จำนวนวันรักษา:</strong> ${document.getElementById('treatmentDays').value || 0} วัน</p>
                        <p><strong>หมายเหตุ:</strong> ${document.getElementById('additionalNote').value || '-'}</p>
                    </div>
                    
                    <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 15px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ลายเซ็นแพทย์</p>
                                    <p>วันที่: ${new Date().toLocaleDateString('th-TH')}</p>
                                </td>
                                <td style="width: 50%; text-align: center;">
                                    <p>_________________________________</p>
                                    <p>ลายเซ็นผู้ป่วย/ผู้ปกครอง</p>
                                    <p>วันที่: ${new Date().toLocaleDateString('th-TH')}</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            const opt = {
                margin: 10,
                filename: `OPD_TCM_${document.getElementById('pname').value || 'ผู้ป่วย'}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // ฟังก์ชันอื่นๆ ที่เหลือ (searchRecords, updatePerformanceReport, saveAppointment, loadAppointments, clearForm, ฯลฯ)
        // ... (ส่วนที่เหลือของฟังก์ชันต่างๆ ยังคงเหมือนเดิม)

        // ค้นหาประวัติ
        function searchRecords() {
            const query = document.getElementById('searchBox').value.toLowerCase().trim();
            const idCardQuery = document.getElementById('searchIdCard').value.trim();
            const container = document.getElementById('searchResults');
            
            if (!query && !idCardQuery) {
                container.innerHTML = '<div class="text-muted text-center p-2">พิมพ์คำค้นหาเพื่อค้นหาประวัติ</div>';
                return;
            }
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            let results = records;
            
            if (query) {
                results = results.filter(record => {
                    return (
                        (record.name && record.name.toLowerCase().includes(query)) ||
                        (record.symptom && record.symptom.toLowerCase().includes(query)) ||
                        (record.tcmDiag && record.tcmDiag.toLowerCase().includes(query)) ||
                        (record.westDiag && record.westDiag.toLowerCase().includes(query)) ||
                        (record.plan && record.plan.toLowerCase().includes(query))
                    );
                });
            }
            
            if (idCardQuery) {
                results = results.filter(record => 
                    record.idCard && record.idCard.includes(idCardQuery)
                );
            }
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-muted text-center p-3">ไม่พบผลลัพธ์ที่ตรงกัน</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            results.slice(0, 5).forEach(record => {
                const hasTongueImage = record.tongueImage ? '<i class="bi bi-image text-success me-1" title="มีรูปลิ้น"></i>' : '';
                const hasFaceImage = record.faceImage ? '<i class="bi bi-person-bounding-box text-success me-1" title="มีรูปหน้า"></i>' : '';
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${record.name} ${hasTongueImage}${hasFaceImage}</h6>
                            <small class="text-muted">${record.savedAt}</small>
                        </div>
                        <p class="mb-1">
                            <small>อายุ ${record.age} ปี, ${record.gender}</small><br>
                            <small>บริการ: ${record.services ? record.services.map(s => s.service).join(', ') : 'ไม่มีข้อมูล'}</small><br>
                            <small>รวม: ${record.totalCost ? record.totalCost.toLocaleString() : 0} บาท</small>
                        </p>
                        <div class="d-flex justify-content-end gap-1 mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecord(${record.id})">
                                <i class="bi bi-eye"></i> โหลด
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportRecordPDF(${record.id})">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportReceiptFromRecord(${record.id})">
                                <i class="bi bi-receipt"></i> เสร็จ
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // เปิดโมดัลแสดงประวัติทั้งหมด
        function openSavedList() {
            renderSavedList();
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // ล้างฟอร์มทั้งหมด
        function clearForm() {
            if (!confirm('คุณต้องการล้างข้อมูลทั้งหมดในฟอร์มใช่หรือไม่?')) return;
            
            // ล้าง input fields
            document.getElementById('pname').value = '';
            document.getElementById('age').value = '';
            document.getElementById('gender').value = 'ชาย';
            document.getElementById('idCard').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('emergencyPhone').value = '';
            document.getElementById('chronicDisease').value = '';
            document.getElementById('drugAllergy').value = '';
            document.getElementById('foodAllergy').value = '';
            document.getElementById('bloodPressure').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('spo2').value = '';
            document.getElementById('temperature').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('visitTime').value = '09:00';
            document.getElementById('symptom').value = '';
            document.getElementById('history').value = '';
            document.getElementById('tcmDiag').value = '';
            document.getElementById('westDiag').value = '';
            document.getElementById('plan').value = '';
            document.getElementById('herbRecommendation').value = '';
            document.getElementById('treatmentDays').value = 7;
            document.getElementById('additionalNote').value = '';
            document.getElementById('appointNote').value = '';
            document.getElementById('otherService').value = '';
            document.getElementById('otherPrice').value = 0;
            document.getElementById('otherPulse').value = '';
            document.getElementById('otherPulse').style.display = 'none';
            
            // รีเซ็ต chip selection
            document.querySelectorAll('#tongueChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            document.querySelectorAll('#pulseChips .chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // รีเซ็ต service selection
            document.querySelectorAll('.service-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // ตั้งค่าวันที่นัดหมาย (7 วันข้างหน้า)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('appointDate').value = nextWeek.toISOString().slice(0, 16);
            
            // รีเซตตัวแปร
            selectedServices = [];
            
            // รีเซตรูปภาพ
            document.getElementById('tongue-image-preview').src = '';
            document.getElementById('tongue-image-preview').classList.add('d-none');
            document.getElementById('tongue-image-data').value = '';
            document.getElementById('face-image-preview').src = '';
            document.getElementById('face-image-preview').classList.add('d-none');
            document.getElementById('face-image-data').value = '';
            
            // หยุดสตรีมกล้อง
            const tongueVideo = document.getElementById('tongue-camera');
            const faceVideo = document.getElementById('face-camera');
            if (tongueVideo.srcObject) {
                tongueVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            if (faceVideo.srcObject) {
                faceVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // อัพเดทใบเสร็จ
            updateReceipt();
            
            // เริ่มกล้องใหม่
            setTimeout(() => initCameras(), 500);
            
            alert('ล้างฟอร์มสำเร็จ');
        }

        // ฟังก์ชันสำหรับจัดการการนัดหมาย
        function saveAppointment() {
            const appointDate = document.getElementById('appointDate').value;
            const appointType = document.getElementById('appointType').value;
            const appointNote = document.getElementById('appointNote').value;
            const patientName = document.getElementById('pname').value;

            if (!appointDate) {
                alert('กรุณาเลือกวันเวลานัดหมาย');
                return;
            }

            if (!patientName) {
                alert('กรุณากรอกชื่อผู้ป่วยก่อนบันทึกการนัดหมาย');
                return;
            }

            const appointment = {
                id: Date.now(),
                patientName: patientName,
                date: appointDate,
                type: appointType,
                note: appointNote,
                createdAt: new Date().toLocaleString('th-TH')
            };

            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            appointments.unshift(appointment);
            localStorage.setItem(APPOINTMENT_KEY, JSON.stringify(appointments));

            alert('บันทึกการนัดหมายสำเร็จ!');
            document.getElementById('appointNote').value = '';
            
            // ตั้งค่าวันที่นัดหมายถัดไป (7 วันข้างหน้า)
            const nextDate = new Date(appointDate);
            nextDate.setDate(nextDate.getDate() + 7);
            document.getElementById('appointDate').value = nextDate.toISOString().slice(0, 16);
        }

        // แสดงการนัดหมายทั้งหมด
        function loadAppointments() {
            const container = document.getElementById('appointmentList');
            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            
            if (appointments.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">ยังไม่มีการนัดหมาย</div>';
                return;
            }

            // เรียงลำดับตามวันที่นัดหมาย (เร็วสุดก่อน)
            appointments.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '<div class="list-group">';
            appointments.forEach(appt => {
                const apptDate = new Date(appt.date);
                const now = new Date();
                const isPast = apptDate < now;
                const statusClass = isPast ? 'status-completed' : 'status-pending';
                const statusText = isPast ? 'ผ่านแล้ว' : 'รอดำเนินการ';
                
                const formattedDate = apptDate.toLocaleDateString('th-TH', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${appt.patientName}</h6>
                                <p class="mb-1">
                                    <i class="bi bi-calendar-event me-1"></i> ${formattedDate}<br>
                                    <i class="bi bi-tag me-1"></i> ${appt.type}
                                </p>
                                ${appt.note ? `<small class="text-muted"><i class="bi bi-chat-text me-1"></i> ${appt.note}</small>` : ''}
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteAppointment(${appt.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
            
            // แสดง modal
            const modal = new bootstrap.Modal(document.getElementById('appointmentsModal'));
            modal.show();
        }

        // ลบการนัดหมาย
        function deleteAppointment(id) {
            if (!confirm('คุณต้องการลบการนัดหมายนี้ใช่หรือไม่?')) return;
            
            let appointments = JSON.parse(localStorage.getItem(APPOINTMENT_KEY)) || [];
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem(APPOINTMENT_KEY, JSON.stringify(appointments));
            
            loadAppointments();
        }

        // อัพเดทรายงาน Performance
        function updatePerformanceReport() {
            const period = document.getElementById('reportPeriod').value;
            const doctor = document.getElementById('doctorSelect').value;
            
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            // กรองตามระยะเวลา
            const now = new Date();
            let filteredRecords = records;
            
            if (period !== 'all') {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.visitDate);
                    switch (period) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date();
                            weekAgo.setDate(now.getDate() - 7);
                            return recordDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date();
                            monthAgo.setMonth(now.getMonth() - 1);
                            return recordDate >= monthAgo;
                        case 'year':
                            const yearAgo = new Date();
                            yearAgo.setFullYear(now.getFullYear() - 1);
                            return recordDate >= yearAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // กรองตามแพทย์ (ถ้ามี)
            if (doctor !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.doctor === doctor);
            }
            
            // คำนวณสถิติ
            const totalPatients = filteredRecords.length;
            const totalRevenue = filteredRecords.reduce((sum, record) => sum + (record.totalCost || 0), 0);
            const avgRevenue = totalPatients > 0 ? Math.round(totalRevenue / totalPatients) : 0;
            
            // หาบริการยอดนิยม
            const serviceCount = {};
            filteredRecords.forEach(record => {
                if (record.services && Array.isArray(record.services)) {
                    record.services.forEach(service => {
                        serviceCount[service.service] = (serviceCount[service.service] || 0) + 1;
                    });
                }
            });
            
            let topService = '-';
            let maxCount = 0;
            for (const [service, count] of Object.entries(serviceCount)) {
                if (count > maxCount) {
                    maxCount = count;
                    topService = service;
                }
            }
            
            // อัพเดทตัวเลขสถิติ
            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
            document.getElementById('avgRevenue').textContent = avgRevenue.toLocaleString();
            document.getElementById('topService').textContent = topService;
            
            // อัพเดทกราฟโรคที่รักษา
            updateDiseaseChart(filteredRecords);
            
            // อัพเดทกราฟรายได้แพทย์
            updateDoctorRevenueChart(filteredRecords);
            
            // อัพเดทรายการโรคที่พบบ่อย
            updateTopDiseasesList(filteredRecords);
            
            // อัพเดทรายการรายได้แพทย์
            updateDoctorRevenueList(filteredRecords);
        }

        // อัพเดทกราฟโรคที่รักษา
        function updateDiseaseChart(records) {
            const diseaseCount = {};
            records.forEach(record => {
                const diag = record.tcmDiag || 'ไม่ระบุ';
                diseaseCount[diag] = (diseaseCount[diag] || 0) + 1;
            });
            
            const labels = Object.keys(diseaseCount);
            const data = Object.values(diseaseCount);
            
            const ctx = document.getElementById('diseaseChart').getContext('2d');
            
            if (diseaseChart) {
                diseaseChart.destroy();
            }
            
            diseaseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#6c5ce7', '#a29bfe', '#00cec9', '#00b894', '#fdcb6e',
                            '#e17055', '#d63031', '#e84393', '#0984e3', '#00b894'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'สัดส่วนโรคที่รักษา'
                        }
                    }
                }
            });
        }

        // อัพเดทกราฟรายได้แพทย์
        function updateDoctorRevenueChart(records) {
            const doctorRevenue = {};
            records.forEach(record => {
                const doctor = record.doctor || 'ไม่ระบุ';
                doctorRevenue[doctor] = (doctorRevenue[doctor] || 0) + (record.totalCost || 0);
            });
            
            // แปลงรหัสแพทย์เป็นชื่อ
            const doctorNames = {
                'dr1': 'แพทย์หญิง สุนิสา',
                'dr2': 'แพทย์ชาย อนุชา',
                'dr3': 'แพทย์หญิง ปิยนุช',
                'all': 'แพทย์ทั้งหมด',
                'ไม่ระบุ': 'ไม่ระบุ'
            };
            
            const labels = Object.keys(doctorRevenue).map(d => doctorNames[d] || d);
            const data = Object.values(doctorRevenue);
            
            const ctx = document.getElementById('doctorRevenueChart').getContext('2d');
            
            if (doctorRevenueChart) {
                doctorRevenueChart.destroy();
            }
            
            doctorRevenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'รายได้ (บาท)',
                        data: data,
                        backgroundColor: '#6c5ce7',
                        borderColor: '#6c5ce7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'รายได้ (บาท)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'รายได้แพทย์แต่ละท่าน'
                        }
                    }
                }
            });
        }

        // อัพเดทรายการโรคที่พบบ่อย
        function updateTopDiseasesList(records) {
            const diseaseCount = {};
            records.forEach(record => {
                const diag = record.tcmDiag || 'ไม่ระบุ';
                if (diag !== 'ไม่ระบุ') {
                    diseaseCount[diag] = (diseaseCount[diag] || 0) + 1;
                }
            });
            
            // เรียงลำดับจากมากไปน้อย
            const sortedDiseases = Object.entries(diseaseCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            if (sortedDiseases.length > 0) {
                sortedDiseases.forEach(([disease, count], index) => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <span class="badge bg-primary me-2">${index + 1}</span>
                                <span>${disease}</span>
                            </div>
                            <span class="badge bg-secondary">${count} เคส</span>
                        </div>
                    `;
                });
            } else {
                html = '<div class="text-center text-muted p-3">ไม่มีข้อมูลโรคที่พบบ่อย</div>';
            }
            
            document.getElementById('topDiseasesList').innerHTML = html;
        }

        // อัพเดทรายการรายได้แพทย์
        function updateDoctorRevenueList(records) {
            const doctorRevenue = {};
            records.forEach(record => {
                const doctor = record.doctor || 'ไม่ระบุ';
                doctorRevenue[doctor] = (doctorRevenue[doctor] || 0) + (record.totalCost || 0);
            });
            
            // แปลงรหัสแพทย์เป็นชื่อ
            const doctorNames = {
                'dr1': 'แพทย์หญิง สุนิสา',
                'dr2': 'แพทย์ชาย อนุชา',
                'dr3': 'แพทย์หญิง ปิยนุช',
                'all': 'แพทย์ทั้งหมด',
                'ไม่ระบุ': 'ไม่ระบุ'
            };
            
            const sortedDoctors = Object.entries(doctorRevenue)
                .sort((a, b) => b[1] - a[1]);
            
            let html = '';
            if (sortedDoctors.length > 0) {
                sortedDoctors.forEach(([doctor, revenue], index) => {
                    const doctorName = doctorNames[doctor] || doctor;
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <span class="badge bg-success me-2">${index + 1}</span>
                                <span>${doctorName}</span>
                            </div>
                            <span class="text-success fw-bold">${revenue.toLocaleString()} บาท</span>
                        </div>
                    `;
                });
            } else {
                html = '<div class="text-center text-muted p-3">ไม่มีข้อมูลรายได้แพทย์</div>';
            }
            
            document.getElementById('doctorRevenueList').innerHTML = html;
        }

        // ส่งออกรายงานเป็น PDF
        function exportReportPDF() {
            const element = document.createElement('div');
            element.innerHTML = generateReportContent();
            
            const opt = {
                margin: 10,
                filename: `รายงานสถิติ_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // สร้างเนื้อหาสำหรับรายงาน PDF
        function generateReportContent() {
            const period = document.getElementById('reportPeriod').value;
            const doctor = document.getElementById('doctorSelect').value;
            const periodText = {
                'today': 'วันนี้',
                'week': 'สัปดาห์นี้',
                'month': 'เดือนนี้',
                'year': 'ปีนี้',
                'all': 'ทั้งหมด'
            }[period];
            
            const doctorText = document.getElementById('doctorSelect').selectedOptions[0].text;
            
            return `
                <div style="font-family: 'Sarabun', sans-serif; padding: 25px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #6c5ce7; margin-bottom: 5px;">รายงานสถิติและ Performance</h2>
                        <h4 style="color: #333; margin-bottom: 15px;">ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</h4>
                        <p style="color: #777;">ช่วงเวลา: ${periodText} | แพทย์: ${doctorText}</p>
                        <p style="color: #777;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH')}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">สถิติสรุป</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <tr>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('totalPatients').textContent}</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">จำนวนเคสทั้งหมด</p>
                                </td>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('totalRevenue').textContent} บาท</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">รายได้ทั้งหมด</p>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('avgRevenue').textContent} บาท</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">รายได้เฉลี่ยต่อเคส</p>
                                </td>
                                <td style="padding: 15px; border: 1px solid #ddd; width: 50%;">
                                    <h3 style="color: #6c5ce7; margin: 0; font-size: 2.5rem;">${document.getElementById('topService').textContent}</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">บริการยอดนิยม</p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">สรุปยอดรายได้แพทย์</h4>
                        <div id="doctorRevenueListForPDF" style="margin-top: 15px;">
                            ${document.getElementById('doctorRevenueList').innerHTML}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #6c5ce7; border-bottom: 1px solid #eee; padding-bottom: 10px;">โรคที่พบบ่อย</h4>
                        <div id="topDiseasesListForPDF" style="margin-top: 15px;">
                            ${document.getElementById('topDiseasesList').innerHTML}
                        </div>
                    </div>
                    
                    <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 15px; text-align: center;">
                        <p>รายงานนี้ถูกสร้างขึ้นโดยระบบ OPD ปัณณวิชญ์ คลินิกการแพทย์แผนจีน</p>
                        <p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>
